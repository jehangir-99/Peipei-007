"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),__assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});
/*!
 * Copyright 2017-2021 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */
var core_1=require("@apollo/client/core"),utils_1=require("./utils"),aws_appsync_auth_link_1=require("aws-appsync-auth-link"),graphql_1=require("graphql"),url=require("url"),uuid_1=require("uuid"),types_1=require("./types"),retry_1=require("./utils/retry"),logger=utils_1.rootLogger.extend("subscriptions");exports.CONTROL_EVENTS_KEY="@@controlEvents";var NON_RETRYABLE_CODES=[400,401,403],SERVICE="appsync",APPSYNC_REALTIME_HEADERS={accept:"application/json, text/javascript","content-encoding":"amz-1.0","content-type":"application/json; charset=UTF-8"},CONNECTION_INIT_TIMEOUT=15e3,START_ACK_TIMEOUT=15e3,SERVER_KEEP_ALIVE_TIMEOUT=6e4,DEFAULT_KEEP_ALIVE_TIMEOUT=3e5,standardDomainPattern=/^https:\/\/\w{26}\.appsync\-api\.\w{2}(?:(?:\-\w{2,})+)\-\d\.amazonaws.com\/graphql$/i,customDomainPath="/realtime",AppSyncRealTimeSubscriptionHandshakeLink=function(_super){function AppSyncRealTimeSubscriptionHandshakeLink(_a){var theUrl=_a.url,theRegion=_a.region,theAuth=_a.auth,keepAliveTimeoutMs=_a.keepAliveTimeoutMs,_this=_super.call(this)||this;if(_this.socketStatus=types_1.SOCKET_STATUS.CLOSED,_this.keepAliveTimeout=void 0,_this.subscriptionObserverMap=new Map,_this.promiseArray=[],_this.url=theUrl,_this.region=theRegion,_this.auth=theAuth,_this.keepAliveTimeout=keepAliveTimeoutMs,_this.keepAliveTimeout<SERVER_KEEP_ALIVE_TIMEOUT){throw new Error("keepAliveTimeoutMs must be greater than or equal to "+SERVER_KEEP_ALIVE_TIMEOUT+" ("+_this.keepAliveTimeout+" used).")}return _this}return __extends(AppSyncRealTimeSubscriptionHandshakeLink,_super),AppSyncRealTimeSubscriptionHandshakeLink.prototype.isCustomDomain=function(url){return null===url.match(standardDomainPattern)},AppSyncRealTimeSubscriptionHandshakeLink.prototype.request=function(operation){var _a,_this=this,query=operation.query,variables=operation.variables,_b=operation.getContext(),_c=_b.controlMessages,_d=exports.CONTROL_EVENTS_KEY,controlEvents=(void 0===_c?(_a={},_a[exports.CONTROL_EVENTS_KEY]=void 0,_a):_c)[_d],headers=_b.headers;return new core_1.Observable((function(observer){if(_this.url){var subscriptionId_1=uuid_1.v4(),token=_this.auth.type===aws_appsync_auth_link_1.AUTH_TYPE.AMAZON_COGNITO_USER_POOLS||_this.auth.type===aws_appsync_auth_link_1.AUTH_TYPE.OPENID_CONNECT?_this.auth.jwtToken:null;token=_this.auth.type===aws_appsync_auth_link_1.AUTH_TYPE.AWS_LAMBDA?_this.auth.token:token;var options={appSyncGraphqlEndpoint:_this.url,authenticationType:_this.auth.type,query:graphql_1.print(query),region:_this.region,graphql_headers:function(){return headers},variables:variables,apiKey:_this.auth.type===aws_appsync_auth_link_1.AUTH_TYPE.API_KEY?_this.auth.apiKey:"",credentials:_this.auth.type===aws_appsync_auth_link_1.AUTH_TYPE.AWS_IAM?_this.auth.credentials:null,token:token};return _this._startSubscriptionWithAWSAppSyncRealTime({options:options,observer:observer,subscriptionId:subscriptionId_1}),function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){try{if(this._verifySubscriptionAlreadyStarted(subscriptionId_1),this.subscriptionObserverMap.get(subscriptionId_1).subscriptionState!==types_1.SUBSCRIPTION_STATUS.CONNECTED)throw new Error("Subscription has failed, starting to remove subscription.");this._sendUnsubscriptionMessage(subscriptionId_1)}catch(err){return this._removeSubscriptionObserver(subscriptionId_1),[2]}return[2]}))}))}}observer.error({errors:[__assign({},new graphql_1.GraphQLError("Subscribe only available for AWS AppSync endpoint"))]}),observer.complete()})).filter((function(data){var _a=data.extensions,_b=(void 0===_a?{}:_a).controlMsgType;return!0===controlEvents||!(void 0!==(void 0===_b?void 0:_b))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._verifySubscriptionAlreadyStarted=function(subscriptionId){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return this.subscriptionObserverMap.get(subscriptionId).subscriptionState===types_1.SUBSCRIPTION_STATUS.PENDING?[2,new Promise((function(res,rej){var _a=_this.subscriptionObserverMap.get(subscriptionId),observer=_a.observer,subscriptionState=_a.subscriptionState,variables=_a.variables,query=_a.query;_this.subscriptionObserverMap.set(subscriptionId,{observer:observer,subscriptionState:subscriptionState,variables:variables,query:query,subscriptionReadyCallback:res,subscriptionFailedCallback:rej})}))]:[2]}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._sendUnsubscriptionMessage=function(subscriptionId){try{if(this.awsRealTimeSocket&&this.awsRealTimeSocket.readyState===WebSocket.OPEN&&this.socketStatus===types_1.SOCKET_STATUS.READY){var unsubscribeMessage={id:subscriptionId,type:types_1.MESSAGE_TYPES.GQL_STOP},stringToAWSRealTime=JSON.stringify(unsubscribeMessage);this.awsRealTimeSocket.send(stringToAWSRealTime),this._removeSubscriptionObserver(subscriptionId)}}catch(err){logger({err:err})}},AppSyncRealTimeSubscriptionHandshakeLink.prototype._removeSubscriptionObserver=function(subscriptionId){this.subscriptionObserverMap.delete(subscriptionId),setTimeout(this._closeSocketIfRequired.bind(this),1e3)},AppSyncRealTimeSubscriptionHandshakeLink.prototype._closeSocketIfRequired=function(){this.subscriptionObserverMap.size>0||(this.awsRealTimeSocket?this.awsRealTimeSocket.bufferedAmount>0?setTimeout(this._closeSocketIfRequired.bind(this),1e3):(logger("closing WebSocket..."),clearTimeout(this.keepAliveTimeoutId),this.awsRealTimeSocket.close(1e3),this.awsRealTimeSocket=null,this.socketStatus=types_1.SOCKET_STATUS.CLOSED):this.socketStatus=types_1.SOCKET_STATUS.CLOSED)},AppSyncRealTimeSubscriptionHandshakeLink.prototype._startSubscriptionWithAWSAppSyncRealTime=function(_a){var options=_a.options,observer=_a.observer,subscriptionId=_a.subscriptionId;return __awaiter(this,void 0,void 0,(function(){var appSyncGraphqlEndpoint,authenticationType,query,variables,apiKey,region,_b,graphql_headers,credentials,token,subscriptionState,data,dataString,headerObj,_c,subscriptionMessage,stringToAWSRealTime,err_1,_d,message,subscriptionFailedCallback_1,_e,subscriptionFailedCallback,subscriptionReadyCallback,_f,_this=this;return __generator(this,(function(_g){switch(_g.label){case 0:return appSyncGraphqlEndpoint=options.appSyncGraphqlEndpoint,authenticationType=options.authenticationType,query=options.query,variables=options.variables,apiKey=options.apiKey,region=options.region,_b=options.graphql_headers,graphql_headers=void 0===_b?function(){return{}}:_b,credentials=options.credentials,token=options.token,subscriptionState=types_1.SUBSCRIPTION_STATUS.PENDING,data={query:query,variables:variables},this.subscriptionObserverMap.set(subscriptionId,{observer:observer,query:query,variables:variables,subscriptionState:subscriptionState,startAckTimeoutId:null}),dataString=JSON.stringify(data),_c=[{}],[4,this._awsRealTimeHeaderBasedAuth({apiKey:apiKey,appSyncGraphqlEndpoint:appSyncGraphqlEndpoint,authenticationType:authenticationType,payload:dataString,canonicalUri:"",region:region,credentials:credentials,token:token,graphql_headers:graphql_headers})];case 1:headerObj=__assign.apply(void 0,[__assign.apply(void 0,_c.concat([_g.sent()])),(_f={},_f[aws_appsync_auth_link_1.USER_AGENT_HEADER]=aws_appsync_auth_link_1.USER_AGENT,_f)]),subscriptionMessage={id:subscriptionId,payload:{data:dataString,extensions:{authorization:__assign({},headerObj)}},type:types_1.MESSAGE_TYPES.GQL_START},stringToAWSRealTime=JSON.stringify(subscriptionMessage),_g.label=2;case 2:return _g.trys.push([2,4,,5]),[4,this._initializeWebSocketConnection({apiKey:apiKey,appSyncGraphqlEndpoint:appSyncGraphqlEndpoint,authenticationType:authenticationType,region:region,credentials:credentials,token:token})];case 3:return _g.sent(),[3,5];case 4:return err_1=_g.sent(),_d=err_1.message,message=void 0===_d?"":_d,observer.error({errors:[__assign({},new graphql_1.GraphQLError("Connection failed: "+message))]}),observer.complete(),"function"==typeof(subscriptionFailedCallback_1=(this.subscriptionObserverMap.get(subscriptionId)||{}).subscriptionFailedCallback)&&subscriptionFailedCallback_1(),[2];case 5:return _e=this.subscriptionObserverMap.get(subscriptionId)||{},subscriptionFailedCallback=_e.subscriptionFailedCallback,subscriptionReadyCallback=_e.subscriptionReadyCallback,this.subscriptionObserverMap.set(subscriptionId,{observer:observer,subscriptionState:subscriptionState,variables:variables,query:query,subscriptionReadyCallback:subscriptionReadyCallback,subscriptionFailedCallback:subscriptionFailedCallback,startAckTimeoutId:setTimeout((function(){_this._timeoutStartSubscriptionAck.call(_this,subscriptionId)}),START_ACK_TIMEOUT)}),this.awsRealTimeSocket&&this.awsRealTimeSocket.send(stringToAWSRealTime),[2]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeWebSocketConnection=function(_a){var _this=this,appSyncGraphqlEndpoint=_a.appSyncGraphqlEndpoint,authenticationType=_a.authenticationType,apiKey=_a.apiKey,region=_a.region,credentials=_a.credentials,token=_a.token;if(this.socketStatus!==types_1.SOCKET_STATUS.READY)return new Promise((function(res,rej){return __awaiter(_this,void 0,void 0,(function(){var payloadString,headerString,_a,_b,headerQs,payloadQs,discoverableEndpoint,awsRealTimeUrl,err_2;return __generator(this,(function(_c){switch(_c.label){case 0:if(this.promiseArray.push({res:res,rej:rej}),this.socketStatus!==types_1.SOCKET_STATUS.CLOSED)return[3,5];_c.label=1;case 1:return _c.trys.push([1,4,,5]),this.socketStatus=types_1.SOCKET_STATUS.CONNECTING,payloadString="{}",_b=(_a=JSON).stringify,[4,this._awsRealTimeHeaderBasedAuth({authenticationType:authenticationType,payload:payloadString,canonicalUri:"/connect",apiKey:apiKey,appSyncGraphqlEndpoint:appSyncGraphqlEndpoint,region:region,credentials:credentials,token:token,graphql_headers:function(){}})];case 2:return headerString=_b.apply(_a,[_c.sent()]),headerQs=Buffer.from(headerString).toString("base64"),payloadQs=Buffer.from(payloadString).toString("base64"),discoverableEndpoint=appSyncGraphqlEndpoint,discoverableEndpoint=(discoverableEndpoint=this.isCustomDomain(discoverableEndpoint)?discoverableEndpoint.concat(customDomainPath):discoverableEndpoint.replace("appsync-api","appsync-realtime-api").replace("gogi-beta","grt-beta")).replace("https://","wss://").replace("http://","ws://"),awsRealTimeUrl=discoverableEndpoint+"?header="+headerQs+"&payload="+payloadQs,[4,this._initializeRetryableHandshake({awsRealTimeUrl:awsRealTimeUrl})];case 3:return _c.sent(),this.promiseArray.forEach((function(_a){var res=_a.res;logger("Notifying connection successful"),res()})),this.socketStatus=types_1.SOCKET_STATUS.READY,this.promiseArray=[],[3,5];case 4:return err_2=_c.sent(),this.promiseArray.forEach((function(_a){return(0,_a.rej)(err_2)})),this.promiseArray=[],this.awsRealTimeSocket&&this.awsRealTimeSocket.readyState===WebSocket.OPEN&&this.awsRealTimeSocket.close(3001),this.awsRealTimeSocket=null,this.socketStatus=types_1.SOCKET_STATUS.CLOSED,[3,5];case 5:return[2]}}))}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeHeaderBasedAuth=function(_a){var authenticationType=_a.authenticationType,payload=_a.payload,canonicalUri=_a.canonicalUri,appSyncGraphqlEndpoint=_a.appSyncGraphqlEndpoint,apiKey=_a.apiKey,region=_a.region,credentials=_a.credentials,token=_a.token,graphql_headers=_a.graphql_headers;return __awaiter(this,void 0,void 0,(function(){var headerHandler,handler,host;return __generator(this,(function(_b){switch(_b.label){case 0:return headerHandler={API_KEY:this._awsRealTimeApiKeyHeader.bind(this),AWS_IAM:this._awsRealTimeIAMHeader.bind(this),OPENID_CONNECT:this._awsRealTimeAuthorizationHeader.bind(this),AMAZON_COGNITO_USER_POOLS:this._awsRealTimeAuthorizationHeader.bind(this),AWS_LAMBDA:this._awsRealTimeAuthorizationHeader.bind(this)},"function"!=typeof(handler=headerHandler[authenticationType])?(logger("Authentication type "+authenticationType+" not supported"),[2,{}]):(host=url.parse(appSyncGraphqlEndpoint).host,[4,handler({payload:payload,canonicalUri:canonicalUri,appSyncGraphqlEndpoint:appSyncGraphqlEndpoint,apiKey:apiKey,region:region,host:host,credentials:credentials,token:token,graphql_headers:graphql_headers})]);case 1:return[2,_b.sent()]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeAuthorizationHeader=function(_a){var host=_a.host,token=_a.token,graphql_headers=_a.graphql_headers;return __awaiter(this,void 0,void 0,(function(){var _b,_c,_d;return __generator(this,(function(_e){switch(_e.label){case 0:return _b={},"function"!=typeof token?[3,2]:[4,token.call(void 0)];case 1:return _c=_e.sent(),[3,4];case 2:return[4,token];case 3:_c=_e.sent(),_e.label=4;case 4:return _d=[(_b.Authorization=_c,_b.host=host,_b)],[4,graphql_headers()];case 5:return[2,__assign.apply(void 0,_d.concat([_e.sent()]))]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeApiKeyHeader=function(_a){var apiKey=_a.apiKey,host=_a.host,graphql_headers=_a.graphql_headers;return __awaiter(this,void 0,void 0,(function(){var dt,dtStr,_b;return __generator(this,(function(_c){switch(_c.label){case 0:return dt=new Date,dtStr=dt.toISOString().replace(/[:\-]|\.\d{3}/g,""),_b=[{host:host,"x-amz-date":dtStr,"x-api-key":apiKey}],[4,graphql_headers()];case 1:return[2,__assign.apply(void 0,_b.concat([_c.sent()]))]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._awsRealTimeIAMHeader=function(_a){var payload=_a.payload,canonicalUri=_a.canonicalUri,appSyncGraphqlEndpoint=_a.appSyncGraphqlEndpoint,region=_a.region,credentials=_a.credentials;return __awaiter(this,void 0,void 0,(function(){var endpointInfo,creds,_b,accessKeyId,secretAccessKey,sessionToken,formattedCredentials,request;return __generator(this,(function(_c){switch(_c.label){case 0:return endpointInfo={region:region,service:SERVICE},(creds="function"==typeof credentials?credentials.call():credentials||{})&&"function"==typeof creds.getPromise?[4,creds.getPromise()]:[3,2];case 1:_c.sent(),_c.label=2;case 2:if(!creds)throw new Error("No credentials");return[4,creds];case 3:return _b=_c.sent(),accessKeyId=_b.accessKeyId,secretAccessKey=_b.secretAccessKey,sessionToken=_b.sessionToken,formattedCredentials={access_key:accessKeyId,secret_key:secretAccessKey,session_token:sessionToken},request={url:""+appSyncGraphqlEndpoint+canonicalUri,body:payload,method:"POST",headers:__assign({},APPSYNC_REALTIME_HEADERS)},[2,aws_appsync_auth_link_1.Signer.sign(request,formattedCredentials,endpointInfo).headers]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeRetryableHandshake=function(_a){var awsRealTimeUrl=_a.awsRealTimeUrl;return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_b){switch(_b.label){case 0:return logger("Initializaling retryable Handshake"),[4,retry_1.jitteredExponentialRetry(this._initializeHandshake.bind(this),[{awsRealTimeUrl:awsRealTimeUrl}])];case 1:return _b.sent(),[2]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._initializeHandshake=function(_a){var awsRealTimeUrl=_a.awsRealTimeUrl;return __awaiter(this,void 0,void 0,(function(){var err_3,errorType,errorCode,_this=this;return __generator(this,(function(_b){switch(_b.label){case 0:logger("Initializing handshake "+awsRealTimeUrl),_b.label=1;case 1:return _b.trys.push([1,4,,5]),[4,new Promise((function(res,rej){var newSocket=AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket(awsRealTimeUrl,"graphql-ws");newSocket.onerror=function(){logger("WebSocket connection error")},newSocket.onclose=function(){rej(new Error("Connection handshake error"))},newSocket.onopen=function(){return _this.awsRealTimeSocket=newSocket,res()}}))];case 2:return _b.sent(),[4,new Promise((function(res,rej){var ackOk=!1;_this.awsRealTimeSocket.onerror=function(error){logger("WebSocket closed "+JSON.stringify(error))},_this.awsRealTimeSocket.onclose=function(event){logger("WebSocket closed "+event.reason),rej(new Error(JSON.stringify(event)))},_this.awsRealTimeSocket.onmessage=function(message){var _a;logger("subscription message from AWS AppSyncRealTime: "+message.data+" ");var data=JSON.parse(message.data),type=data.type,_b=data.payload,_c=(void 0===_b?{}:_b).connectionTimeoutMs,connectionTimeoutMs=void 0===_c?DEFAULT_KEEP_ALIVE_TIMEOUT:_c;if(type===types_1.MESSAGE_TYPES.GQL_CONNECTION_ACK)return ackOk=!0,_this.keepAliveTimeout=null!==(_a=_this.keepAliveTimeout)&&void 0!==_a?_a:connectionTimeoutMs,_this.awsRealTimeSocket.onmessage=_this._handleIncomingSubscriptionMessage.bind(_this),_this.awsRealTimeSocket.onerror=function(err){logger(err),_this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED)},_this.awsRealTimeSocket.onclose=function(event){logger("WebSocket closed "+event.reason),_this._errorDisconnect(types_1.CONTROL_MSG.CONNECTION_CLOSED)},void res("Cool, connected to AWS AppSyncRealTime");if(type===types_1.MESSAGE_TYPES.GQL_CONNECTION_ERROR){var _d=data.payload,_e=(void 0===_d?{}:_d).errors,_f=(void 0===_e?[]:_e)[0],_g=void 0===_f?{}:_f,_h=_g.errorType,errorType=void 0===_h?"":_h,_j=_g.errorCode;rej({errorType:errorType,errorCode:void 0===_j?0:_j})}};var gqlInit={type:types_1.MESSAGE_TYPES.GQL_CONNECTION_INIT};_this.awsRealTimeSocket.send(JSON.stringify(gqlInit)),setTimeout(function(){ackOk||rej(new Error("Connection timeout: ack from AWSRealTime was not received on "+CONNECTION_INIT_TIMEOUT+" ms"))}.bind(_this),CONNECTION_INIT_TIMEOUT)}))];case 3:return _b.sent(),[3,5];case 4:throw err_3=_b.sent(),errorType=err_3.errorType,errorCode=err_3.errorCode,NON_RETRYABLE_CODES.indexOf(errorCode)>=0?new retry_1.NonRetryableError(errorType):errorType?new Error(errorType):err_3;case 5:return[2]}}))}))},AppSyncRealTimeSubscriptionHandshakeLink.prototype._handleIncomingSubscriptionMessage=function(message){logger("subscription message from AWS AppSync RealTime: "+message.data);var _a=JSON.parse(message.data),_b=_a.id,id=void 0===_b?"":_b,payload=_a.payload,type=_a.type,_c=this.subscriptionObserverMap.get(id)||{},_d=_c.observer,observer=void 0===_d?null:_d,_e=_c.query,query=void 0===_e?"":_e,_f=_c.variables,variables=void 0===_f?{}:_f,_g=_c.startAckTimeoutId,startAckTimeoutId=void 0===_g?0:_g,_h=_c.subscriptionReadyCallback,subscriptionReadyCallback=void 0===_h?null:_h,_j=_c.subscriptionFailedCallback,subscriptionFailedCallback=void 0===_j?null:_j;if(logger({id:id,observer:observer,query:query,variables:variables}),type===types_1.MESSAGE_TYPES.GQL_DATA&&payload&&payload.data)observer?observer.next(payload):logger("observer not found for id: "+id);else if(type!==types_1.MESSAGE_TYPES.GQL_START_ACK){if(type===types_1.MESSAGE_TYPES.GQL_CONNECTION_KEEP_ALIVE)return clearTimeout(this.keepAliveTimeoutId),void(this.keepAliveTimeoutId=setTimeout(this._errorDisconnect.bind(this,types_1.CONTROL_MSG.TIMEOUT_DISCONNECT),this.keepAliveTimeout));if(type===types_1.MESSAGE_TYPES.GQL_ERROR){subscriptionState=types_1.SUBSCRIPTION_STATUS.FAILED;this.subscriptionObserverMap.set(id,{observer:observer,query:query,variables:variables,startAckTimeoutId:startAckTimeoutId,subscriptionReadyCallback:subscriptionReadyCallback,subscriptionFailedCallback:subscriptionFailedCallback,subscriptionState:subscriptionState}),clearTimeout(startAckTimeoutId),observer?(observer.error({errors:[__assign({},new graphql_1.GraphQLError("Connection failed: "+JSON.stringify(payload)))]}),observer.complete()):logger("observer not found for id: "+id),"function"==typeof subscriptionFailedCallback&&subscriptionFailedCallback()}}else{logger("subscription ready for "+JSON.stringify({query:query,variables:variables})),"function"==typeof subscriptionReadyCallback&&subscriptionReadyCallback(),clearTimeout(startAckTimeoutId),observer?observer.next({data:payload,extensions:{controlMsgType:"CONNECTED"}}):logger("observer not found for id: "+id);var subscriptionState=types_1.SUBSCRIPTION_STATUS.CONNECTED;this.subscriptionObserverMap.set(id,{observer:observer,query:query,variables:variables,startAckTimeoutId:null,subscriptionState:subscriptionState,subscriptionReadyCallback:subscriptionReadyCallback,subscriptionFailedCallback:subscriptionFailedCallback})}},AppSyncRealTimeSubscriptionHandshakeLink.prototype._errorDisconnect=function(msg){logger("Disconnect error: "+msg),this.subscriptionObserverMap.forEach((function(_a){var observer=_a.observer;observer&&!observer.closed&&observer.error({errors:[__assign({},new graphql_1.GraphQLError(msg))]})})),this.subscriptionObserverMap.clear(),this.awsRealTimeSocket&&this.awsRealTimeSocket.close(),this.socketStatus=types_1.SOCKET_STATUS.CLOSED},AppSyncRealTimeSubscriptionHandshakeLink.prototype._timeoutStartSubscriptionAck=function(subscriptionId){var _a=this.subscriptionObserverMap.get(subscriptionId)||{},observer=_a.observer,query=_a.query,variables=_a.variables;observer&&(this.subscriptionObserverMap.set(subscriptionId,{observer:observer,query:query,variables:variables,subscriptionState:types_1.SUBSCRIPTION_STATUS.FAILED}),observer&&!observer.closed&&(observer.error({errors:[__assign({},new graphql_1.GraphQLError("Subscription timeout "+JSON.stringify({query:query,variables:variables})))]}),observer.complete()),logger("timeoutStartSubscription",JSON.stringify({query:query,variables:variables})))},AppSyncRealTimeSubscriptionHandshakeLink.createWebSocket=function(awsRealTimeUrl,protocol){return new WebSocket(awsRealTimeUrl,protocol)},AppSyncRealTimeSubscriptionHandshakeLink}(core_1.ApolloLink);exports.AppSyncRealTimeSubscriptionHandshakeLink=AppSyncRealTimeSubscriptionHandshakeLink;