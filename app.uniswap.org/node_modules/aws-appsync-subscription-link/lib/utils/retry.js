"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])},extendStatics(d,b)};return function(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}}(),__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}};Object.defineProperty(exports,"__esModule",{value:!0});var index_1=require("./index"),logger=index_1.rootLogger.extend("retry"),MAX_DELAY_MS=5e3,NonRetryableError=function(_super){function NonRetryableError(message){var _this=_super.call(this,message)||this;return _this.nonRetryable=!0,_this}return __extends(NonRetryableError,_super),NonRetryableError}(Error);exports.NonRetryableError=NonRetryableError;var isNonRetryableError=function(obj){return obj&&obj.nonRetryable};function retry(functionToRetry,args,delayFn,attempt){return void 0===attempt&&(attempt=1),__awaiter(this,void 0,void 0,(function(){var err_1,retryIn_1;return __generator(this,(function(_a){switch(_a.label){case 0:logger("Attempt #"+attempt+" for this vars: "+JSON.stringify(args)),_a.label=1;case 1:return _a.trys.push([1,3,,8]),[4,functionToRetry.apply(void 0,args)];case 2:return _a.sent(),[3,8];case 3:if(err_1=_a.sent(),logger("error "+err_1),isNonRetryableError(err_1))throw logger("non retryable error"),err_1;return retryIn_1=delayFn(attempt,args,err_1),logger("retryIn ",retryIn_1),!1===retryIn_1?[3,6]:[4,new Promise((function(res){return setTimeout(res,retryIn_1)}))];case 4:return _a.sent(),[4,retry(functionToRetry,args,delayFn,attempt+1)];case 5:return[2,_a.sent()];case 6:throw err_1;case 7:return[3,8];case 8:return[2]}}))}))}function jitteredBackoff(maxDelayMs){return function(attempt){var delay=100*Math.pow(2,attempt)+100*Math.random();return!(delay>maxDelayMs)&&delay}}exports.retry=retry,exports.jitteredExponentialRetry=function(functionToRetry,args,maxDelayMs){return void 0===maxDelayMs&&(maxDelayMs=MAX_DELAY_MS),retry(functionToRetry,args,jitteredBackoff(maxDelayMs))};