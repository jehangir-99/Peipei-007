import{Trie}from"@wry/trie";import{canUseWeakMap,canUseWeakSet}from"../common/canUse.js";import{checkDocument}from"./getFromAST.js";import{invariant}from"../globals/index.js";import{WeakCache}from"@wry/caches";import{wrap}from"optimism";import{cacheSizes}from"../caching/index.js";function identity(document){return document}var DocumentTransform=function(){function DocumentTransform(transform,options){void 0===options&&(options=Object.create(null)),this.resultCache=canUseWeakSet?new WeakSet:new Set,this.transform=transform,options.getCacheKey&&(this.getCacheKey=options.getCacheKey),this.cached=!1!==options.cache,this.resetCache()}return DocumentTransform.prototype.getCacheKey=function(document){return[document]},DocumentTransform.identity=function(){return new DocumentTransform(identity,{cache:!1})},DocumentTransform.split=function(predicate,left,right){return void 0===right&&(right=DocumentTransform.identity()),Object.assign(new DocumentTransform((function(document){return(predicate(document)?left:right).transformDocument(document)}),{cache:!1}),{left:left,right:right})},DocumentTransform.prototype.resetCache=function(){var _this=this;if(this.cached){var stableCacheKeys_1=new Trie(canUseWeakMap);this.performWork=wrap(DocumentTransform.prototype.performWork.bind(this),{makeCacheKey:function(document){var cacheKeys=_this.getCacheKey(document);if(cacheKeys)return invariant(Array.isArray(cacheKeys),67),stableCacheKeys_1.lookupArray(cacheKeys)},max:cacheSizes["documentTransform.cache"],cache:WeakCache})}},DocumentTransform.prototype.performWork=function(document){return checkDocument(document),this.transform(document)},DocumentTransform.prototype.transformDocument=function(document){if(this.resultCache.has(document))return document;var transformedDocument=this.performWork(document);return this.resultCache.add(transformedDocument),transformedDocument},DocumentTransform.prototype.concat=function(otherTransform){var _this=this;return Object.assign(new DocumentTransform((function(document){return otherTransform.transformDocument(_this.transformDocument(document))}),{cache:!1}),{left:this,right:otherTransform})},DocumentTransform}();export{DocumentTransform};