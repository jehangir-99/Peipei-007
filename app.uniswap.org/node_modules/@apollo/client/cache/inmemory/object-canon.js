import{__assign}from"tslib";import{Trie}from"@wry/trie";import{canUseWeakMap,canUseWeakSet,isNonNullObject as isObjectOrArray}from"../../utilities/index.js";import{isArray}from"./helpers.js";function shallowCopy(value){return isObjectOrArray(value)?isArray(value)?value.slice(0):__assign({__proto__:Object.getPrototypeOf(value)},value):value}var ObjectCanon=function(){function ObjectCanon(){this.known=new(canUseWeakSet?WeakSet:Set),this.pool=new Trie(canUseWeakMap),this.passes=new WeakMap,this.keysByJSON=new Map,this.empty=this.admit({})}return ObjectCanon.prototype.isKnown=function(value){return isObjectOrArray(value)&&this.known.has(value)},ObjectCanon.prototype.pass=function(value){if(isObjectOrArray(value)){var copy=shallowCopy(value);return this.passes.set(copy,value),copy}return value},ObjectCanon.prototype.admit=function(value){var _this=this;if(isObjectOrArray(value)){var original=this.passes.get(value);if(original)return original;switch(Object.getPrototypeOf(value)){case Array.prototype:if(this.known.has(value))return value;var array=value.map(this.admit,this);return(node=this.pool.lookupArray(array)).array||(this.known.add(node.array=array),!1!==globalThis.__DEV__&&Object.freeze(array)),node.array;case null:case Object.prototype:if(this.known.has(value))return value;var proto_1=Object.getPrototypeOf(value),array_1=[proto_1],keys=this.sortedKeys(value);array_1.push(keys.json);var node,firstValueIndex_1=array_1.length;if(keys.sorted.forEach((function(key){array_1.push(_this.admit(value[key]))})),!(node=this.pool.lookupArray(array_1)).object){var obj_1=node.object=Object.create(proto_1);this.known.add(obj_1),keys.sorted.forEach((function(key,i){obj_1[key]=array_1[firstValueIndex_1+i]})),!1!==globalThis.__DEV__&&Object.freeze(obj_1)}return node.object}}return value},ObjectCanon.prototype.sortedKeys=function(obj){var keys=Object.keys(obj),node=this.pool.lookupArray(keys);if(!node.keys){keys.sort();var json=JSON.stringify(keys);(node.keys=this.keysByJSON.get(json))||this.keysByJSON.set(json,node.keys={sorted:keys,json:json})}return node.keys},ObjectCanon}();export{ObjectCanon};