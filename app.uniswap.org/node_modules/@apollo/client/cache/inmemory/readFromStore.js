import{__assign}from"tslib";import{invariant,newInvariantError}from"../../utilities/globals/index.js";import{Kind}from"graphql";import{wrap}from"optimism";import{isField,resultKeyNameFromField,isReference,makeReference,shouldInclude,addTypenameToDocument,getDefaultValues,getMainDefinition,getQueryDefinition,getFragmentFromSelection,maybeDeepFreeze,mergeDeepArray,DeepMerger,isNonNullObject,canUseWeakMap,compact,canonicalStringify,cacheSizes}from"../../utilities/index.js";import{maybeDependOnExistenceOfEntity,supportsResultCaching}from"./entityStore.js";import{isArray,extractFragmentContext,getTypenameFromStoreObject,shouldCanonizeResults}from"./helpers.js";import{MissingFieldError}from"../core/types/common.js";import{ObjectCanon}from"./object-canon.js";function execSelectionSetKeyArgs(options){return[options.selectionSet,options.objectOrReference,options.context,options.context.canonizeResults]}var StoreReader=function(){function StoreReader(config){var _this=this;this.knownResults=new(canUseWeakMap?WeakMap:Map),this.config=compact(config,{addTypename:!1!==config.addTypename,canonizeResults:shouldCanonizeResults(config)}),this.canon=config.canon||new ObjectCanon,this.executeSelectionSet=wrap((function(options){var _a,canonizeResults=options.context.canonizeResults,peekArgs=execSelectionSetKeyArgs(options);peekArgs[3]=!canonizeResults;var other=(_a=_this.executeSelectionSet).peek.apply(_a,peekArgs);return other?canonizeResults?__assign(__assign({},other),{result:_this.canon.admit(other.result)}):other:(maybeDependOnExistenceOfEntity(options.context.store,options.enclosingRef.__ref),_this.execSelectionSetImpl(options))}),{max:this.config.resultCacheMaxSize||cacheSizes["inMemoryCache.executeSelectionSet"]||5e4,keyArgs:execSelectionSetKeyArgs,makeCacheKey:function(selectionSet,parent,context,canonizeResults){if(supportsResultCaching(context.store))return context.store.makeCacheKey(selectionSet,isReference(parent)?parent.__ref:parent,context.varString,canonizeResults)}}),this.executeSubSelectedArray=wrap((function(options){return maybeDependOnExistenceOfEntity(options.context.store,options.enclosingRef.__ref),_this.execSubSelectedArrayImpl(options)}),{max:this.config.resultCacheMaxSize||cacheSizes["inMemoryCache.executeSubSelectedArray"]||1e4,makeCacheKey:function(_a){var field=_a.field,array=_a.array,context=_a.context;if(supportsResultCaching(context.store))return context.store.makeCacheKey(field,array,context.varString)}})}return StoreReader.prototype.resetCanon=function(){this.canon=new ObjectCanon},StoreReader.prototype.diffQueryAgainstStore=function(_a){var store=_a.store,query=_a.query,_b=_a.rootId,rootId=void 0===_b?"ROOT_QUERY":_b,variables=_a.variables,_c=_a.returnPartialData,returnPartialData=void 0===_c||_c,_d=_a.canonizeResults,canonizeResults=void 0===_d?this.config.canonizeResults:_d,policies=this.config.cache.policies;variables=__assign(__assign({},getDefaultValues(getQueryDefinition(query))),variables);var missing,rootRef=makeReference(rootId),execResult=this.executeSelectionSet({selectionSet:getMainDefinition(query).selectionSet,objectOrReference:rootRef,enclosingRef:rootRef,context:__assign({store:store,query:query,policies:policies,variables:variables,varString:canonicalStringify(variables),canonizeResults:canonizeResults},extractFragmentContext(query,this.config.fragments))});if(execResult.missing&&(missing=[new MissingFieldError(firstMissing(execResult.missing),execResult.missing,query,variables)],!returnPartialData))throw missing[0];return{result:execResult.result,complete:!missing,missing:missing}},StoreReader.prototype.isFresh=function(result,parent,selectionSet,context){if(supportsResultCaching(context.store)&&this.knownResults.get(result)===selectionSet){var latest=this.executeSelectionSet.peek(selectionSet,parent,context,this.canon.isKnown(result));if(latest&&result===latest.result)return!0}return!1},StoreReader.prototype.execSelectionSetImpl=function(_a){var _this=this,selectionSet=_a.selectionSet,objectOrReference=_a.objectOrReference,enclosingRef=_a.enclosingRef,context=_a.context;if(isReference(objectOrReference)&&!context.policies.rootTypenamesById[objectOrReference.__ref]&&!context.store.has(objectOrReference.__ref))return{result:this.canon.empty,missing:"Dangling reference to missing ".concat(objectOrReference.__ref," object")};var missing,variables=context.variables,policies=context.policies,typename=context.store.getFieldValue(objectOrReference,"__typename"),objectsToMerge=[],missingMerger=new DeepMerger;function handleMissing(result,resultName){var _a;return result.missing&&(missing=missingMerger.merge(missing,((_a={})[resultName]=result.missing,_a))),result.result}this.config.addTypename&&"string"==typeof typename&&!policies.rootIdsByTypename[typename]&&objectsToMerge.push({__typename:typename});var workSet=new Set(selectionSet.selections);workSet.forEach((function(selection){var _a,_b;if(shouldInclude(selection,variables))if(isField(selection)){var fieldValue=policies.readField({fieldName:selection.name.value,field:selection,variables:context.variables,from:objectOrReference},context),resultName=resultKeyNameFromField(selection);void 0===fieldValue?addTypenameToDocument.added(selection)||(missing=missingMerger.merge(missing,((_a={})[resultName]="Can't find field '".concat(selection.name.value,"' on ").concat(isReference(objectOrReference)?objectOrReference.__ref+" object":"object "+JSON.stringify(objectOrReference,null,2)),_a))):isArray(fieldValue)?fieldValue.length>0&&(fieldValue=handleMissing(_this.executeSubSelectedArray({field:selection,array:fieldValue,enclosingRef:enclosingRef,context:context}),resultName)):selection.selectionSet?null!=fieldValue&&(fieldValue=handleMissing(_this.executeSelectionSet({selectionSet:selection.selectionSet,objectOrReference:fieldValue,enclosingRef:isReference(fieldValue)?fieldValue:enclosingRef,context:context}),resultName)):context.canonizeResults&&(fieldValue=_this.canon.pass(fieldValue)),void 0!==fieldValue&&objectsToMerge.push(((_b={})[resultName]=fieldValue,_b))}else{var fragment=getFragmentFromSelection(selection,context.lookupFragment);if(!fragment&&selection.kind===Kind.FRAGMENT_SPREAD)throw newInvariantError(9,selection.name.value);fragment&&policies.fragmentMatches(fragment,typename)&&fragment.selectionSet.selections.forEach(workSet.add,workSet)}}));var finalResult={result:mergeDeepArray(objectsToMerge),missing:missing},frozen=context.canonizeResults?this.canon.admit(finalResult):maybeDeepFreeze(finalResult);return frozen.result&&this.knownResults.set(frozen.result,selectionSet),frozen},StoreReader.prototype.execSubSelectedArrayImpl=function(_a){var missing,_this=this,field=_a.field,array=_a.array,enclosingRef=_a.enclosingRef,context=_a.context,missingMerger=new DeepMerger;function handleMissing(childResult,i){var _a;return childResult.missing&&(missing=missingMerger.merge(missing,((_a={})[i]=childResult.missing,_a))),childResult.result}return field.selectionSet&&(array=array.filter(context.store.canRead)),array=array.map((function(item,i){return null===item?null:isArray(item)?handleMissing(_this.executeSubSelectedArray({field:field,array:item,enclosingRef:enclosingRef,context:context}),i):field.selectionSet?handleMissing(_this.executeSelectionSet({selectionSet:field.selectionSet,objectOrReference:item,enclosingRef:isReference(item)?item:enclosingRef,context:context}),i):(!1!==globalThis.__DEV__&&assertSelectionSetForIdValue(context.store,field,item),item)})),{result:context.canonizeResults?this.canon.admit(array):array,missing:missing}},StoreReader}();export{StoreReader};function firstMissing(tree){try{JSON.stringify(tree,(function(_,value){if("string"==typeof value)throw value;return value}))}catch(result){return result}}function assertSelectionSetForIdValue(store,field,fieldValue){if(!field.selectionSet){var workSet_1=new Set([fieldValue]);workSet_1.forEach((function(value){isNonNullObject(value)&&(invariant(!isReference(value),10,getTypenameFromStoreObject(store,value),field.name.value),Object.values(value).forEach(workSet_1.add,workSet_1))}))}}