import{__assign,__awaiter,__generator}from"tslib";import{invariant}from"../utilities/globals/index.js";import{visit,BREAK,isSelectionNode}from"graphql";import{argumentsObjectFromField,buildQueryFromSelectionSet,createFragmentMap,getFragmentDefinitions,getMainDefinition,hasDirectives,isField,isInlineFragment,mergeDeep,mergeDeepArray,removeClientSetsFromDocument,resultKeyNameFromField,shouldInclude}from"../utilities/index.js";import{cacheSlot}from"../cache/index.js";var LocalState=function(){function LocalState(_a){var cache=_a.cache,client=_a.client,resolvers=_a.resolvers,fragmentMatcher=_a.fragmentMatcher;this.selectionsToResolveCache=new WeakMap,this.cache=cache,client&&(this.client=client),resolvers&&this.addResolvers(resolvers),fragmentMatcher&&this.setFragmentMatcher(fragmentMatcher)}return LocalState.prototype.addResolvers=function(resolvers){var _this=this;this.resolvers=this.resolvers||{},Array.isArray(resolvers)?resolvers.forEach((function(resolverGroup){_this.resolvers=mergeDeep(_this.resolvers,resolverGroup)})):this.resolvers=mergeDeep(this.resolvers,resolvers)},LocalState.prototype.setResolvers=function(resolvers){this.resolvers={},this.addResolvers(resolvers)},LocalState.prototype.getResolvers=function(){return this.resolvers||{}},LocalState.prototype.runResolvers=function(_a){return __awaiter(this,arguments,void 0,(function(_b){var document=_b.document,remoteResult=_b.remoteResult,context=_b.context,variables=_b.variables,_c=_b.onlyRunForcedResolvers,onlyRunForcedResolvers=void 0!==_c&&_c;return __generator(this,(function(_d){return document?[2,this.resolveDocument(document,remoteResult.data,context,variables,this.fragmentMatcher,onlyRunForcedResolvers).then((function(localResult){return __assign(__assign({},remoteResult),{data:localResult.result})}))]:[2,remoteResult]}))}))},LocalState.prototype.setFragmentMatcher=function(fragmentMatcher){this.fragmentMatcher=fragmentMatcher},LocalState.prototype.getFragmentMatcher=function(){return this.fragmentMatcher},LocalState.prototype.clientQuery=function(document){return hasDirectives(["client"],document)&&this.resolvers?document:null},LocalState.prototype.serverQuery=function(document){return removeClientSetsFromDocument(document)},LocalState.prototype.prepareContext=function(context){var cache=this.cache;return __assign(__assign({},context),{cache:cache,getCacheKey:function(obj){return cache.identify(obj)}})},LocalState.prototype.addExportedVariables=function(document_1){return __awaiter(this,arguments,void 0,(function(document,variables,context){return void 0===variables&&(variables={}),void 0===context&&(context={}),__generator(this,(function(_a){return document?[2,this.resolveDocument(document,this.buildRootValueFromCache(document,variables)||{},this.prepareContext(context),variables).then((function(data){return __assign(__assign({},variables),data.exportedVariables)}))]:[2,__assign({},variables)]}))}))},LocalState.prototype.shouldForceResolvers=function(document){var forceResolvers=!1;return visit(document,{Directive:{enter:function(node){if("client"===node.name.value&&node.arguments&&(forceResolvers=node.arguments.some((function(arg){return"always"===arg.name.value&&"BooleanValue"===arg.value.kind&&!0===arg.value.value}))))return BREAK}}}),forceResolvers},LocalState.prototype.buildRootValueFromCache=function(document,variables){return this.cache.diff({query:buildQueryFromSelectionSet(document),variables:variables,returnPartialData:!0,optimistic:!1}).result},LocalState.prototype.resolveDocument=function(document_1,rootValue_1){return __awaiter(this,arguments,void 0,(function(document,rootValue,context,variables,fragmentMatcher,onlyRunForcedResolvers){var mainDefinition,fragments,fragmentMap,selectionsToResolve,definitionOperation,defaultOperationType,_a,cache,client,execContext;return void 0===context&&(context={}),void 0===variables&&(variables={}),void 0===fragmentMatcher&&(fragmentMatcher=function(){return!0}),void 0===onlyRunForcedResolvers&&(onlyRunForcedResolvers=!1),__generator(this,(function(_b){return mainDefinition=getMainDefinition(document),fragments=getFragmentDefinitions(document),fragmentMap=createFragmentMap(fragments),selectionsToResolve=this.collectSelectionsToResolve(mainDefinition,fragmentMap),definitionOperation=mainDefinition.operation,defaultOperationType=definitionOperation?definitionOperation.charAt(0).toUpperCase()+definitionOperation.slice(1):"Query",cache=(_a=this).cache,client=_a.client,execContext={fragmentMap:fragmentMap,context:__assign(__assign({},context),{cache:cache,client:client}),variables:variables,fragmentMatcher:fragmentMatcher,defaultOperationType:defaultOperationType,exportedVariables:{},selectionsToResolve:selectionsToResolve,onlyRunForcedResolvers:onlyRunForcedResolvers},!1,[2,this.resolveSelectionSet(mainDefinition.selectionSet,false,rootValue,execContext).then((function(result){return{result:result,exportedVariables:execContext.exportedVariables}}))]}))}))},LocalState.prototype.resolveSelectionSet=function(selectionSet,isClientFieldDescendant,rootValue,execContext){return __awaiter(this,void 0,void 0,(function(){var fragmentMap,context,variables,resultsToMerge,execute,_this=this;return __generator(this,(function(_a){return fragmentMap=execContext.fragmentMap,context=execContext.context,variables=execContext.variables,resultsToMerge=[rootValue],execute=function(selection){return __awaiter(_this,void 0,void 0,(function(){var fragment,typeCondition;return __generator(this,(function(_a){return(isClientFieldDescendant||execContext.selectionsToResolve.has(selection))&&shouldInclude(selection,variables)?isField(selection)?[2,this.resolveField(selection,isClientFieldDescendant,rootValue,execContext).then((function(fieldResult){var _a;void 0!==fieldResult&&resultsToMerge.push(((_a={})[resultKeyNameFromField(selection)]=fieldResult,_a))}))]:(isInlineFragment(selection)?fragment=selection:(fragment=fragmentMap[selection.name.value],invariant(fragment,18,selection.name.value)),fragment&&fragment.typeCondition&&(typeCondition=fragment.typeCondition.name.value,execContext.fragmentMatcher(rootValue,typeCondition,context))?[2,this.resolveSelectionSet(fragment.selectionSet,isClientFieldDescendant,rootValue,execContext).then((function(fragmentResult){resultsToMerge.push(fragmentResult)}))]:[2]):[2]}))}))},[2,Promise.all(selectionSet.selections.map(execute)).then((function(){return mergeDeepArray(resultsToMerge)}))]}))}))},LocalState.prototype.resolveField=function(field,isClientFieldDescendant,rootValue,execContext){return __awaiter(this,void 0,void 0,(function(){var variables,fieldName,aliasedFieldName,aliasUsed,defaultResult,resultPromise,resolverType,resolverMap,resolve,_this=this;return __generator(this,(function(_a){return rootValue?(variables=execContext.variables,fieldName=field.name.value,aliasedFieldName=resultKeyNameFromField(field),aliasUsed=fieldName!==aliasedFieldName,defaultResult=rootValue[aliasedFieldName]||rootValue[fieldName],resultPromise=Promise.resolve(defaultResult),execContext.onlyRunForcedResolvers&&!this.shouldForceResolvers(field)||(resolverType=rootValue.__typename||execContext.defaultOperationType,(resolverMap=this.resolvers&&this.resolvers[resolverType])&&(resolve=resolverMap[aliasUsed?fieldName:aliasedFieldName])&&(resultPromise=Promise.resolve(cacheSlot.withValue(this.cache,resolve,[rootValue,argumentsObjectFromField(field,variables),execContext.context,{field:field,fragmentMap:execContext.fragmentMap}])))),[2,resultPromise.then((function(result){var _a,_b;if(void 0===result&&(result=defaultResult),field.directives&&field.directives.forEach((function(directive){"export"===directive.name.value&&directive.arguments&&directive.arguments.forEach((function(arg){"as"===arg.name.value&&"StringValue"===arg.value.kind&&(execContext.exportedVariables[arg.value.value]=result)}))})),!field.selectionSet)return result;if(null==result)return result;var isClientField=null!==(_b=null===(_a=field.directives)||void 0===_a?void 0:_a.some((function(d){return"client"===d.name.value})))&&void 0!==_b&&_b;return Array.isArray(result)?_this.resolveSubSelectedArray(field,isClientFieldDescendant||isClientField,result,execContext):field.selectionSet?_this.resolveSelectionSet(field.selectionSet,isClientFieldDescendant||isClientField,result,execContext):void 0}))]):[2,null]}))}))},LocalState.prototype.resolveSubSelectedArray=function(field,isClientFieldDescendant,result,execContext){var _this=this;return Promise.all(result.map((function(item){return null===item?null:Array.isArray(item)?_this.resolveSubSelectedArray(field,isClientFieldDescendant,item,execContext):field.selectionSet?_this.resolveSelectionSet(field.selectionSet,isClientFieldDescendant,item,execContext):void 0})))},LocalState.prototype.collectSelectionsToResolve=function(mainDefinition,fragmentMap){var isSingleASTNode=function(node){return!Array.isArray(node)},selectionsToResolveCache=this.selectionsToResolveCache;return function collectByDefinition(definitionNode){if(!selectionsToResolveCache.has(definitionNode)){var matches_1=new Set;selectionsToResolveCache.set(definitionNode,matches_1),visit(definitionNode,{Directive:function(node,_,__,___,ancestors){"client"===node.name.value&&ancestors.forEach((function(node){isSingleASTNode(node)&&isSelectionNode(node)&&matches_1.add(node)}))},FragmentSpread:function(spread,_,__,___,ancestors){var fragment=fragmentMap[spread.name.value];invariant(fragment,19,spread.name.value);var fragmentSelections=collectByDefinition(fragment);fragmentSelections.size>0&&(ancestors.forEach((function(node){isSingleASTNode(node)&&isSelectionNode(node)&&matches_1.add(node)})),matches_1.add(spread),fragmentSelections.forEach((function(selection){matches_1.add(selection)})))}})}return selectionsToResolveCache.get(definitionNode)}(mainDefinition)},LocalState}();export{LocalState};