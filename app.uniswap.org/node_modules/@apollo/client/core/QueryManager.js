import{__assign,__awaiter,__generator}from"tslib";import{invariant,newInvariantError}from"../utilities/globals/index.js";import{equal}from"@wry/equality";import{execute}from"../link/core/index.js";import{hasDirectives,isExecutionPatchIncrementalResult,isExecutionPatchResult,removeDirectivesFromDocument}from"../utilities/index.js";import{canonicalStringify}from"../cache/index.js";import{getDefaultValues,getOperationDefinition,getOperationName,hasClientExports,graphQLResultHasError,getGraphQLErrorsFromResult,Observable,asyncMap,isNonEmptyArray,Concast,makeUniqueId,isDocumentNode,isNonNullObject,DocumentTransform}from"../utilities/index.js";import{mergeIncrementalData}from"../utilities/common/incrementalResult.js";import{ApolloError,isApolloError,graphQLResultHasProtocolErrors}from"../errors/index.js";import{ObservableQuery,logMissingFieldErrors}from"./ObservableQuery.js";import{NetworkStatus,isNetworkRequestInFlight}from"./networkStatus.js";import{LocalState}from"./LocalState.js";import{QueryInfo,shouldWriteResult}from"./QueryInfo.js";import{PROTOCOL_ERRORS_SYMBOL}from"../errors/index.js";import{print}from"../utilities/index.js";var hasOwnProperty=Object.prototype.hasOwnProperty,IGNORE=Object.create(null);import{Trie}from"@wry/trie";import{AutoCleanedWeakCache,cacheSizes}from"../utilities/index.js";var QueryManager=function(){function QueryManager(_a){var cache=_a.cache,link=_a.link,defaultOptions=_a.defaultOptions,documentTransform=_a.documentTransform,_b=_a.queryDeduplication,queryDeduplication=void 0!==_b&&_b,onBroadcast=_a.onBroadcast,_c=_a.ssrMode,ssrMode=void 0!==_c&&_c,_d=_a.clientAwareness,clientAwareness=void 0===_d?{}:_d,localState=_a.localState,_e=_a.assumeImmutableResults,assumeImmutableResults=void 0===_e?!!cache.assumeImmutableResults:_e,defaultContext=_a.defaultContext,_this=this;this.clientAwareness={},this.queries=new Map,this.fetchCancelFns=new Map,this.transformCache=new AutoCleanedWeakCache(cacheSizes["queryManager.getDocumentInfo"]||2e3),this.queryIdCounter=1,this.requestIdCounter=1,this.mutationIdCounter=1,this.inFlightLinkObservables=new Trie(!1);var defaultDocumentTransform=new DocumentTransform((function(document){return _this.cache.transformDocument(document)}),{cache:!1});this.cache=cache,this.link=link,this.defaultOptions=defaultOptions||Object.create(null),this.queryDeduplication=queryDeduplication,this.clientAwareness=clientAwareness,this.localState=localState||new LocalState({cache:cache}),this.ssrMode=ssrMode,this.assumeImmutableResults=assumeImmutableResults,this.documentTransform=documentTransform?defaultDocumentTransform.concat(documentTransform).concat(defaultDocumentTransform):defaultDocumentTransform,this.defaultContext=defaultContext||Object.create(null),(this.onBroadcast=onBroadcast)&&(this.mutationStore=Object.create(null))}return QueryManager.prototype.stop=function(){var _this=this;this.queries.forEach((function(_info,queryId){_this.stopQueryNoBroadcast(queryId)})),this.cancelPendingFetches(newInvariantError(25))},QueryManager.prototype.cancelPendingFetches=function(error){this.fetchCancelFns.forEach((function(cancel){return cancel(error)})),this.fetchCancelFns.clear()},QueryManager.prototype.mutate=function(_a){return __awaiter(this,arguments,void 0,(function(_b){var mutationId,hasClientExports,mutationStoreValue,isOptimistic,self,_c,_d,mutation=_b.mutation,variables=_b.variables,optimisticResponse=_b.optimisticResponse,updateQueries=_b.updateQueries,_e=_b.refetchQueries,refetchQueries=void 0===_e?[]:_e,_f=_b.awaitRefetchQueries,awaitRefetchQueries=void 0!==_f&&_f,updateWithProxyFn=_b.update,onQueryUpdated=_b.onQueryUpdated,_g=_b.fetchPolicy,fetchPolicy=void 0===_g?(null===(_c=this.defaultOptions.mutate)||void 0===_c?void 0:_c.fetchPolicy)||"network-only":_g,_h=_b.errorPolicy,errorPolicy=void 0===_h?(null===(_d=this.defaultOptions.mutate)||void 0===_d?void 0:_d.errorPolicy)||"none":_h,keepRootFields=_b.keepRootFields,context=_b.context;return __generator(this,(function(_j){switch(_j.label){case 0:return invariant(mutation,26),invariant("network-only"===fetchPolicy||"no-cache"===fetchPolicy,27),mutationId=this.generateMutationId(),mutation=this.cache.transformForLink(this.transform(mutation)),hasClientExports=this.getDocumentInfo(mutation).hasClientExports,variables=this.getVariables(mutation,variables),hasClientExports?[4,this.localState.addExportedVariables(mutation,variables,context)]:[3,2];case 1:variables=_j.sent(),_j.label=2;case 2:return mutationStoreValue=this.mutationStore&&(this.mutationStore[mutationId]={mutation:mutation,variables:variables,loading:!0,error:null}),isOptimistic=optimisticResponse&&this.markMutationOptimistic(optimisticResponse,{mutationId:mutationId,document:mutation,variables:variables,fetchPolicy:fetchPolicy,errorPolicy:errorPolicy,context:context,updateQueries:updateQueries,update:updateWithProxyFn,keepRootFields:keepRootFields}),this.broadcastQueries(),self=this,[2,new Promise((function(resolve,reject){return asyncMap(self.getObservableFromLink(mutation,__assign(__assign({},context),{optimisticResponse:isOptimistic?optimisticResponse:void 0}),variables,!1),(function(result){if(graphQLResultHasError(result)&&"none"===errorPolicy)throw new ApolloError({graphQLErrors:getGraphQLErrorsFromResult(result)});mutationStoreValue&&(mutationStoreValue.loading=!1,mutationStoreValue.error=null);var storeResult=__assign({},result);return"function"==typeof refetchQueries&&(refetchQueries=refetchQueries(storeResult)),"ignore"===errorPolicy&&graphQLResultHasError(storeResult)&&delete storeResult.errors,self.markMutationResult({mutationId:mutationId,result:storeResult,document:mutation,variables:variables,fetchPolicy:fetchPolicy,errorPolicy:errorPolicy,context:context,update:updateWithProxyFn,updateQueries:updateQueries,awaitRefetchQueries:awaitRefetchQueries,refetchQueries:refetchQueries,removeOptimistic:isOptimistic?mutationId:void 0,onQueryUpdated:onQueryUpdated,keepRootFields:keepRootFields})})).subscribe({next:function(storeResult){self.broadcastQueries(),"hasNext"in storeResult&&!1!==storeResult.hasNext||resolve(storeResult)},error:function(err){mutationStoreValue&&(mutationStoreValue.loading=!1,mutationStoreValue.error=err),isOptimistic&&self.cache.removeOptimistic(mutationId),self.broadcastQueries(),reject(err instanceof ApolloError?err:new ApolloError({networkError:err}))}})}))]}}))}))},QueryManager.prototype.markMutationResult=function(mutation,cache){var _this=this;void 0===cache&&(cache=this.cache);var result=mutation.result,cacheWrites=[],skipCache="no-cache"===mutation.fetchPolicy;if(!skipCache&&shouldWriteResult(result,mutation.errorPolicy)){if(isExecutionPatchIncrementalResult(result)||cacheWrites.push({result:result.data,dataId:"ROOT_MUTATION",query:mutation.document,variables:mutation.variables}),isExecutionPatchIncrementalResult(result)&&isNonEmptyArray(result.incremental)){var diff=cache.diff({id:"ROOT_MUTATION",query:this.getDocumentInfo(mutation.document).asQuery,variables:mutation.variables,optimistic:!1,returnPartialData:!0}),mergedData=void 0;diff.result&&(mergedData=mergeIncrementalData(diff.result,result)),void 0!==mergedData&&(result.data=mergedData,cacheWrites.push({result:mergedData,dataId:"ROOT_MUTATION",query:mutation.document,variables:mutation.variables}))}var updateQueries_1=mutation.updateQueries;updateQueries_1&&this.queries.forEach((function(_a,queryId){var observableQuery=_a.observableQuery,queryName=observableQuery&&observableQuery.queryName;if(queryName&&hasOwnProperty.call(updateQueries_1,queryName)){var updater=updateQueries_1[queryName],_b=_this.queries.get(queryId),document=_b.document,variables=_b.variables,_c=cache.diff({query:document,variables:variables,returnPartialData:!0,optimistic:!1}),currentQueryResult=_c.result;if(_c.complete&&currentQueryResult){var nextQueryResult=updater(currentQueryResult,{mutationResult:result,queryName:document&&getOperationName(document)||void 0,queryVariables:variables});nextQueryResult&&cacheWrites.push({result:nextQueryResult,dataId:"ROOT_QUERY",query:document,variables:variables})}}}))}if(cacheWrites.length>0||(mutation.refetchQueries||"").length>0||mutation.update||mutation.onQueryUpdated||mutation.removeOptimistic){var results_1=[];if(this.refetchQueries({updateCache:function(cache){skipCache||cacheWrites.forEach((function(write){return cache.write(write)}));var update=mutation.update,isFinalResult=!isExecutionPatchResult(result)||isExecutionPatchIncrementalResult(result)&&!result.hasNext;if(update){if(!skipCache){var diff=cache.diff({id:"ROOT_MUTATION",query:_this.getDocumentInfo(mutation.document).asQuery,variables:mutation.variables,optimistic:!1,returnPartialData:!0});diff.complete&&("incremental"in(result=__assign(__assign({},result),{data:diff.result}))&&delete result.incremental,"hasNext"in result&&delete result.hasNext)}isFinalResult&&update(cache,result,{context:mutation.context,variables:mutation.variables})}skipCache||mutation.keepRootFields||!isFinalResult||cache.modify({id:"ROOT_MUTATION",fields:function(value,_a){var fieldName=_a.fieldName,DELETE=_a.DELETE;return"__typename"===fieldName?value:DELETE}})},include:mutation.refetchQueries,optimistic:!1,removeOptimistic:mutation.removeOptimistic,onQueryUpdated:mutation.onQueryUpdated||null}).forEach((function(result){return results_1.push(result)})),mutation.awaitRefetchQueries||mutation.onQueryUpdated)return Promise.all(results_1).then((function(){return result}))}return Promise.resolve(result)},QueryManager.prototype.markMutationOptimistic=function(optimisticResponse,mutation){var _this=this,data="function"==typeof optimisticResponse?optimisticResponse(mutation.variables,{IGNORE:IGNORE}):optimisticResponse;return data!==IGNORE&&(this.cache.recordOptimisticTransaction((function(cache){try{_this.markMutationResult(__assign(__assign({},mutation),{result:{data:data}}),cache)}catch(error){!1!==globalThis.__DEV__&&invariant.error(error)}}),mutation.mutationId),!0)},QueryManager.prototype.fetchQuery=function(queryId,options,networkStatus){return this.fetchConcastWithInfo(queryId,options,networkStatus).concast.promise},QueryManager.prototype.getQueryStore=function(){var store=Object.create(null);return this.queries.forEach((function(info,queryId){store[queryId]={variables:info.variables,networkStatus:info.networkStatus,networkError:info.networkError,graphQLErrors:info.graphQLErrors}})),store},QueryManager.prototype.resetErrors=function(queryId){var queryInfo=this.queries.get(queryId);queryInfo&&(queryInfo.networkError=void 0,queryInfo.graphQLErrors=[])},QueryManager.prototype.transform=function(document){return this.documentTransform.transformDocument(document)},QueryManager.prototype.getDocumentInfo=function(document){var transformCache=this.transformCache;if(!transformCache.has(document)){var cacheEntry={hasClientExports:hasClientExports(document),hasForcedResolvers:this.localState.shouldForceResolvers(document),hasNonreactiveDirective:hasDirectives(["nonreactive"],document),clientQuery:this.localState.clientQuery(document),serverQuery:removeDirectivesFromDocument([{name:"client",remove:!0},{name:"connection"},{name:"nonreactive"}],document),defaultVars:getDefaultValues(getOperationDefinition(document)),asQuery:__assign(__assign({},document),{definitions:document.definitions.map((function(def){return"OperationDefinition"===def.kind&&"query"!==def.operation?__assign(__assign({},def),{operation:"query"}):def}))})};transformCache.set(document,cacheEntry)}return transformCache.get(document)},QueryManager.prototype.getVariables=function(document,variables){return __assign(__assign({},this.getDocumentInfo(document).defaultVars),variables)},QueryManager.prototype.watchQuery=function(options){var query=this.transform(options.query);void 0===(options=__assign(__assign({},options),{variables:this.getVariables(query,options.variables)})).notifyOnNetworkStatusChange&&(options.notifyOnNetworkStatusChange=!1);var queryInfo=new QueryInfo(this),observable=new ObservableQuery({queryManager:this,queryInfo:queryInfo,options:options});return observable.lastQuery=query,this.queries.set(observable.queryId,queryInfo),queryInfo.init({document:query,observableQuery:observable,variables:observable.variables}),observable},QueryManager.prototype.query=function(options,queryId){var _this=this;return void 0===queryId&&(queryId=this.generateQueryId()),invariant(options.query,28),invariant("Document"===options.query.kind,29),invariant(!options.returnPartialData,30),invariant(!options.pollInterval,31),this.fetchQuery(queryId,__assign(__assign({},options),{query:this.transform(options.query)})).finally((function(){return _this.stopQuery(queryId)}))},QueryManager.prototype.generateQueryId=function(){return String(this.queryIdCounter++)},QueryManager.prototype.generateRequestId=function(){return this.requestIdCounter++},QueryManager.prototype.generateMutationId=function(){return String(this.mutationIdCounter++)},QueryManager.prototype.stopQueryInStore=function(queryId){this.stopQueryInStoreNoBroadcast(queryId),this.broadcastQueries()},QueryManager.prototype.stopQueryInStoreNoBroadcast=function(queryId){var queryInfo=this.queries.get(queryId);queryInfo&&queryInfo.stop()},QueryManager.prototype.clearStore=function(options){return void 0===options&&(options={discardWatches:!0}),this.cancelPendingFetches(newInvariantError(32)),this.queries.forEach((function(queryInfo){queryInfo.observableQuery?queryInfo.networkStatus=NetworkStatus.loading:queryInfo.stop()})),this.mutationStore&&(this.mutationStore=Object.create(null)),this.cache.reset(options)},QueryManager.prototype.getObservableQueries=function(include){var _this=this;void 0===include&&(include="active");var queries=new Map,queryNamesAndDocs=new Map,legacyQueryOptions=new Set;return Array.isArray(include)&&include.forEach((function(desc){"string"==typeof desc?queryNamesAndDocs.set(desc,!1):isDocumentNode(desc)?queryNamesAndDocs.set(_this.transform(desc),!1):isNonNullObject(desc)&&desc.query&&legacyQueryOptions.add(desc)})),this.queries.forEach((function(_a,queryId){var oq=_a.observableQuery,document=_a.document;if(oq){if("all"===include)return void queries.set(queryId,oq);var queryName=oq.queryName;if("standby"===oq.options.fetchPolicy||"active"===include&&!oq.hasObservers())return;("active"===include||queryName&&queryNamesAndDocs.has(queryName)||document&&queryNamesAndDocs.has(document))&&(queries.set(queryId,oq),queryName&&queryNamesAndDocs.set(queryName,!0),document&&queryNamesAndDocs.set(document,!0))}})),legacyQueryOptions.size&&legacyQueryOptions.forEach((function(options){var queryId=makeUniqueId("legacyOneTimeQuery"),queryInfo=_this.getQuery(queryId).init({document:options.query,variables:options.variables}),oq=new ObservableQuery({queryManager:_this,queryInfo:queryInfo,options:__assign(__assign({},options),{fetchPolicy:"network-only"})});invariant(oq.queryId===queryId),queryInfo.setObservableQuery(oq),queries.set(queryId,oq)})),!1!==globalThis.__DEV__&&queryNamesAndDocs.size&&queryNamesAndDocs.forEach((function(included,nameOrDoc){included||!1!==globalThis.__DEV__&&invariant.warn("string"==typeof nameOrDoc?33:34,nameOrDoc)})),queries},QueryManager.prototype.reFetchObservableQueries=function(includeStandby){var _this=this;void 0===includeStandby&&(includeStandby=!1);var observableQueryPromises=[];return this.getObservableQueries(includeStandby?"all":"active").forEach((function(observableQuery,queryId){var fetchPolicy=observableQuery.options.fetchPolicy;observableQuery.resetLastResults(),(includeStandby||"standby"!==fetchPolicy&&"cache-only"!==fetchPolicy)&&observableQueryPromises.push(observableQuery.refetch()),_this.getQuery(queryId).setDiff(null)})),this.broadcastQueries(),Promise.all(observableQueryPromises)},QueryManager.prototype.setObservableQuery=function(observableQuery){this.getQuery(observableQuery.queryId).setObservableQuery(observableQuery)},QueryManager.prototype.startGraphQLSubscription=function(_a){var _this=this,query=_a.query,fetchPolicy=_a.fetchPolicy,_b=_a.errorPolicy,errorPolicy=void 0===_b?"none":_b,variables=_a.variables,_c=_a.context,context=void 0===_c?{}:_c;query=this.transform(query),variables=this.getVariables(query,variables);var makeObservable=function(variables){return _this.getObservableFromLink(query,context,variables).map((function(result){"no-cache"!==fetchPolicy&&(shouldWriteResult(result,errorPolicy)&&_this.cache.write({query:query,result:result.data,dataId:"ROOT_SUBSCRIPTION",variables:variables}),_this.broadcastQueries());var hasErrors=graphQLResultHasError(result),hasProtocolErrors=graphQLResultHasProtocolErrors(result);if(hasErrors||hasProtocolErrors){var errors={};if(hasErrors&&(errors.graphQLErrors=result.errors),hasProtocolErrors&&(errors.protocolErrors=result.extensions[PROTOCOL_ERRORS_SYMBOL]),"none"===errorPolicy||hasProtocolErrors)throw new ApolloError(errors)}return"ignore"===errorPolicy&&delete result.errors,result}))};if(this.getDocumentInfo(query).hasClientExports){var observablePromise_1=this.localState.addExportedVariables(query,variables,context).then(makeObservable);return new Observable((function(observer){var sub=null;return observablePromise_1.then((function(observable){return sub=observable.subscribe(observer)}),observer.error),function(){return sub&&sub.unsubscribe()}}))}return makeObservable(variables)},QueryManager.prototype.stopQuery=function(queryId){this.stopQueryNoBroadcast(queryId),this.broadcastQueries()},QueryManager.prototype.stopQueryNoBroadcast=function(queryId){this.stopQueryInStoreNoBroadcast(queryId),this.removeQuery(queryId)},QueryManager.prototype.removeQuery=function(queryId){this.fetchCancelFns.delete(queryId),this.queries.has(queryId)&&(this.getQuery(queryId).stop(),this.queries.delete(queryId))},QueryManager.prototype.broadcastQueries=function(){this.onBroadcast&&this.onBroadcast(),this.queries.forEach((function(info){return info.notify()}))},QueryManager.prototype.getLocalState=function(){return this.localState},QueryManager.prototype.getObservableFromLink=function(query,context,variables,deduplication){var _a,observable,_this=this;void 0===deduplication&&(deduplication=null!==(_a=null==context?void 0:context.queryDeduplication)&&void 0!==_a?_a:this.queryDeduplication);var _b=this.getDocumentInfo(query),serverQuery=_b.serverQuery,clientQuery=_b.clientQuery;if(serverQuery){var inFlightLinkObservables_1=this.inFlightLinkObservables,link=this.link,operation={query:serverQuery,variables:variables,operationName:getOperationName(serverQuery)||void 0,context:this.prepareContext(__assign(__assign({},context),{forceFetch:!deduplication}))};if(context=operation.context,deduplication){var printedServerQuery_1=print(serverQuery),varJson_1=canonicalStringify(variables),entry=inFlightLinkObservables_1.lookup(printedServerQuery_1,varJson_1);if(!(observable=entry.observable)){var concast=new Concast([execute(link,operation)]);observable=entry.observable=concast,concast.beforeNext((function(){inFlightLinkObservables_1.remove(printedServerQuery_1,varJson_1)}))}}else observable=new Concast([execute(link,operation)])}else observable=new Concast([Observable.of({data:{}})]),context=this.prepareContext(context);return clientQuery&&(observable=asyncMap(observable,(function(result){return _this.localState.runResolvers({document:clientQuery,remoteResult:result,context:context,variables:variables})}))),observable},QueryManager.prototype.getResultsFromLink=function(queryInfo,cacheWriteBehavior,options){var requestId=queryInfo.lastRequestId=this.generateRequestId(),linkDocument=this.cache.transformForLink(options.query);return asyncMap(this.getObservableFromLink(linkDocument,options.context,options.variables),(function(result){var graphQLErrors=getGraphQLErrorsFromResult(result),hasErrors=graphQLErrors.length>0;if(requestId>=queryInfo.lastRequestId){if(hasErrors&&"none"===options.errorPolicy)throw queryInfo.markError(new ApolloError({graphQLErrors:graphQLErrors}));queryInfo.markResult(result,linkDocument,options,cacheWriteBehavior),queryInfo.markReady()}var aqr={data:result.data,loading:!1,networkStatus:NetworkStatus.ready};return hasErrors&&"ignore"!==options.errorPolicy&&(aqr.errors=graphQLErrors,aqr.networkStatus=NetworkStatus.error),aqr}),(function(networkError){var error=isApolloError(networkError)?networkError:new ApolloError({networkError:networkError});throw requestId>=queryInfo.lastRequestId&&queryInfo.markError(error),error}))},QueryManager.prototype.fetchConcastWithInfo=function(queryId,options,networkStatus,query){var _this=this;void 0===networkStatus&&(networkStatus=NetworkStatus.loading),void 0===query&&(query=options.query);var concast,containsDataFromLink,variables=this.getVariables(query,options.variables),queryInfo=this.getQuery(queryId),defaults=this.defaultOptions.watchQuery,_a=options.fetchPolicy,fetchPolicy=void 0===_a?defaults&&defaults.fetchPolicy||"cache-first":_a,_b=options.errorPolicy,errorPolicy=void 0===_b?defaults&&defaults.errorPolicy||"none":_b,_c=options.returnPartialData,returnPartialData=void 0!==_c&&_c,_d=options.notifyOnNetworkStatusChange,notifyOnNetworkStatusChange=void 0!==_d&&_d,_e=options.context,context=void 0===_e?{}:_e,normalized=Object.assign({},options,{query:query,variables:variables,fetchPolicy:fetchPolicy,errorPolicy:errorPolicy,returnPartialData:returnPartialData,notifyOnNetworkStatusChange:notifyOnNetworkStatusChange,context:context}),fromVariables=function(variables){normalized.variables=variables;var sourcesWithInfo=_this.fetchQueryByPolicy(queryInfo,normalized,networkStatus);return"standby"!==normalized.fetchPolicy&&sourcesWithInfo.sources.length>0&&queryInfo.observableQuery&&queryInfo.observableQuery.applyNextFetchPolicy("after-fetch",options),sourcesWithInfo},cleanupCancelFn=function(){return _this.fetchCancelFns.delete(queryId)};if(this.fetchCancelFns.set(queryId,(function(reason){cleanupCancelFn(),setTimeout((function(){return concast.cancel(reason)}))})),this.getDocumentInfo(normalized.query).hasClientExports)concast=new Concast(this.localState.addExportedVariables(normalized.query,normalized.variables,normalized.context).then(fromVariables).then((function(sourcesWithInfo){return sourcesWithInfo.sources}))),containsDataFromLink=!0;else{var sourcesWithInfo=fromVariables(normalized.variables);containsDataFromLink=sourcesWithInfo.fromLink,concast=new Concast(sourcesWithInfo.sources)}return concast.promise.then(cleanupCancelFn,cleanupCancelFn),{concast:concast,fromLink:containsDataFromLink}},QueryManager.prototype.refetchQueries=function(_a){var _this=this,updateCache=_a.updateCache,include=_a.include,_b=_a.optimistic,optimistic=void 0!==_b&&_b,_c=_a.removeOptimistic,removeOptimistic=void 0===_c?optimistic?makeUniqueId("refetchQueries"):void 0:_c,onQueryUpdated=_a.onQueryUpdated,includedQueriesById=new Map;include&&this.getObservableQueries(include).forEach((function(oq,queryId){includedQueriesById.set(queryId,{oq:oq,lastDiff:_this.getQuery(queryId).getDiff()})}));var results=new Map;return updateCache&&this.cache.batch({update:updateCache,optimistic:optimistic&&removeOptimistic||!1,removeOptimistic:removeOptimistic,onWatchUpdated:function(watch,diff,lastDiff){var oq=watch.watcher instanceof QueryInfo&&watch.watcher.observableQuery;if(oq){if(onQueryUpdated){includedQueriesById.delete(oq.queryId);var result=onQueryUpdated(oq,diff,lastDiff);return!0===result&&(result=oq.refetch()),!1!==result&&results.set(oq,result),result}null!==onQueryUpdated&&includedQueriesById.set(oq.queryId,{oq:oq,lastDiff:lastDiff,diff:diff})}}}),includedQueriesById.size&&includedQueriesById.forEach((function(_a,queryId){var result,oq=_a.oq,lastDiff=_a.lastDiff,diff=_a.diff;if(onQueryUpdated){if(!diff){var info=oq.queryInfo;info.reset(),diff=info.getDiff()}result=onQueryUpdated(oq,diff,lastDiff)}onQueryUpdated&&!0!==result||(result=oq.refetch()),!1!==result&&results.set(oq,result),queryId.indexOf("legacyOneTimeQuery")>=0&&_this.stopQueryNoBroadcast(queryId)})),removeOptimistic&&this.cache.removeOptimistic(removeOptimistic),results},QueryManager.prototype.fetchQueryByPolicy=function(queryInfo,_a,networkStatus){var _this=this,query=_a.query,variables=_a.variables,fetchPolicy=_a.fetchPolicy,refetchWritePolicy=_a.refetchWritePolicy,errorPolicy=_a.errorPolicy,returnPartialData=_a.returnPartialData,context=_a.context,notifyOnNetworkStatusChange=_a.notifyOnNetworkStatusChange,oldNetworkStatus=queryInfo.networkStatus;queryInfo.init({document:query,variables:variables,networkStatus:networkStatus});var readCache=function(){return queryInfo.getDiff()},resultsFromCache=function(diff,networkStatus){void 0===networkStatus&&(networkStatus=queryInfo.networkStatus||NetworkStatus.loading);var data=diff.result;!1===globalThis.__DEV__||returnPartialData||equal(data,{})||logMissingFieldErrors(diff.missing);var fromData=function(data){return Observable.of(__assign({data:data,loading:isNetworkRequestInFlight(networkStatus),networkStatus:networkStatus},diff.complete?null:{partial:!0}))};return data&&_this.getDocumentInfo(query).hasForcedResolvers?_this.localState.runResolvers({document:query,remoteResult:{data:data},context:context,variables:variables,onlyRunForcedResolvers:!0}).then((function(resolved){return fromData(resolved.data||void 0)})):"none"===errorPolicy&&networkStatus===NetworkStatus.refetch&&Array.isArray(diff.missing)?fromData(void 0):fromData(data)},cacheWriteBehavior="no-cache"===fetchPolicy?0:networkStatus===NetworkStatus.refetch&&"merge"!==refetchWritePolicy?1:2,resultsFromLink=function(){return _this.getResultsFromLink(queryInfo,cacheWriteBehavior,{query:query,variables:variables,context:context,fetchPolicy:fetchPolicy,errorPolicy:errorPolicy})},shouldNotify=notifyOnNetworkStatusChange&&"number"==typeof oldNetworkStatus&&oldNetworkStatus!==networkStatus&&isNetworkRequestInFlight(networkStatus);switch(fetchPolicy){default:case"cache-first":return(diff=readCache()).complete?{fromLink:!1,sources:[resultsFromCache(diff,queryInfo.markReady())]}:returnPartialData||shouldNotify?{fromLink:!0,sources:[resultsFromCache(diff),resultsFromLink()]}:{fromLink:!0,sources:[resultsFromLink()]};case"cache-and-network":var diff;return(diff=readCache()).complete||returnPartialData||shouldNotify?{fromLink:!0,sources:[resultsFromCache(diff),resultsFromLink()]}:{fromLink:!0,sources:[resultsFromLink()]};case"cache-only":return{fromLink:!1,sources:[resultsFromCache(readCache(),queryInfo.markReady())]};case"network-only":return shouldNotify?{fromLink:!0,sources:[resultsFromCache(readCache()),resultsFromLink()]}:{fromLink:!0,sources:[resultsFromLink()]};case"no-cache":return shouldNotify?{fromLink:!0,sources:[resultsFromCache(queryInfo.getDiff()),resultsFromLink()]}:{fromLink:!0,sources:[resultsFromLink()]};case"standby":return{fromLink:!1,sources:[]}}},QueryManager.prototype.getQuery=function(queryId){return queryId&&!this.queries.has(queryId)&&this.queries.set(queryId,new QueryInfo(this,queryId)),this.queries.get(queryId)},QueryManager.prototype.prepareContext=function(context){void 0===context&&(context={});var newContext=this.localState.prepareContext(context);return __assign(__assign(__assign({},this.defaultContext),newContext),{clientAwareness:this.clientAwareness})},QueryManager}();export{QueryManager};