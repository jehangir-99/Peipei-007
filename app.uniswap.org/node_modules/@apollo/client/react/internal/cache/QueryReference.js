import{__assign}from"tslib";import{equal}from"@wry/equality";import{createFulfilledPromise,createRejectedPromise}from"../../../utilities/index.js";import{wrapPromiseWithState}from"../../../utilities/index.js";import{invariant}from"../../../utilities/globals/invariantWrappers.js";var QUERY_REFERENCE_SYMBOL=Symbol(),PROMISE_SYMBOL=Symbol();export function wrapQueryRef(internalQueryRef){var _a,ref=((_a={toPromise:function(){return getWrappedPromise(ref).then((function(){return ref}))}})[QUERY_REFERENCE_SYMBOL]=internalQueryRef,_a[PROMISE_SYMBOL]=internalQueryRef.promise,_a);return ref}export function assertWrappedQueryRef(queryRef){invariant(!queryRef||QUERY_REFERENCE_SYMBOL in queryRef,59)}export function getWrappedPromise(queryRef){var internalQueryRef=unwrapQueryRef(queryRef);return"fulfilled"===internalQueryRef.promise.status?internalQueryRef.promise:queryRef[PROMISE_SYMBOL]}export function unwrapQueryRef(queryRef){return queryRef[QUERY_REFERENCE_SYMBOL]}export function updateWrappedQueryRef(queryRef,promise){queryRef[PROMISE_SYMBOL]=promise}var OBSERVED_CHANGED_OPTIONS=["canonizeResults","context","errorPolicy","fetchPolicy","refetchWritePolicy","returnPartialData"],InternalQueryReference=function(){function InternalQueryReference(observable,options){var _this=this;this.key={},this.listeners=new Set,this.references=0,this.softReferences=0,this.handleNext=this.handleNext.bind(this),this.handleError=this.handleError.bind(this),this.dispose=this.dispose.bind(this),this.observable=observable,options.onDispose&&(this.onDispose=options.onDispose),this.setResult(),this.subscribeToQuery();var startDisposeTimer=function(){var _a;_this.references||(_this.autoDisposeTimeoutId=setTimeout(_this.dispose,null!==(_a=options.autoDisposeTimeoutMs)&&void 0!==_a?_a:3e4))};this.promise.then(startDisposeTimer,startDisposeTimer)}return Object.defineProperty(InternalQueryReference.prototype,"disposed",{get:function(){return this.subscription.closed},enumerable:!1,configurable:!0}),Object.defineProperty(InternalQueryReference.prototype,"watchQueryOptions",{get:function(){return this.observable.options},enumerable:!1,configurable:!0}),InternalQueryReference.prototype.reinitialize=function(){var observable=this.observable,originalFetchPolicy=this.watchQueryOptions.fetchPolicy,avoidNetworkRequests="no-cache"===originalFetchPolicy||"standby"===originalFetchPolicy;try{if(avoidNetworkRequests?observable.silentSetOptions({fetchPolicy:"standby"}):(observable.resetLastResults(),observable.silentSetOptions({fetchPolicy:"cache-first"})),this.subscribeToQuery(),avoidNetworkRequests)return;observable.resetDiff(),this.setResult()}finally{observable.silentSetOptions({fetchPolicy:originalFetchPolicy})}},InternalQueryReference.prototype.retain=function(){var _this=this;this.references++,clearTimeout(this.autoDisposeTimeoutId);var disposed=!1;return function(){disposed||(disposed=!0,_this.references--,setTimeout((function(){_this.references||_this.dispose()})))}},InternalQueryReference.prototype.softRetain=function(){var _this=this;this.softReferences++;var disposed=!1;return function(){disposed||(disposed=!0,_this.softReferences--,setTimeout((function(){_this.softReferences||_this.references||_this.dispose()})))}},InternalQueryReference.prototype.didChangeOptions=function(watchQueryOptions){var _this=this;return OBSERVED_CHANGED_OPTIONS.some((function(option){return option in watchQueryOptions&&!equal(_this.watchQueryOptions[option],watchQueryOptions[option])}))},InternalQueryReference.prototype.applyOptions=function(watchQueryOptions){var _a=this.watchQueryOptions,currentFetchPolicy=_a.fetchPolicy,currentCanonizeResults=_a.canonizeResults;return"standby"===currentFetchPolicy&&currentFetchPolicy!==watchQueryOptions.fetchPolicy?this.initiateFetch(this.observable.reobserve(watchQueryOptions)):(this.observable.silentSetOptions(watchQueryOptions),currentCanonizeResults!==watchQueryOptions.canonizeResults&&(this.result=__assign(__assign({},this.result),this.observable.getCurrentResult()),this.promise=createFulfilledPromise(this.result))),this.promise},InternalQueryReference.prototype.listen=function(listener){var _this=this;return this.listeners.add(listener),function(){_this.listeners.delete(listener)}},InternalQueryReference.prototype.refetch=function(variables){return this.initiateFetch(this.observable.refetch(variables))},InternalQueryReference.prototype.fetchMore=function(options){return this.initiateFetch(this.observable.fetchMore(options))},InternalQueryReference.prototype.dispose=function(){this.subscription.unsubscribe(),this.onDispose()},InternalQueryReference.prototype.onDispose=function(){},InternalQueryReference.prototype.handleNext=function(result){var _a;if("pending"===this.promise.status)void 0===result.data&&(result.data=this.result.data),this.result=result,null===(_a=this.resolve)||void 0===_a||_a.call(this,result);else{if(result.data===this.result.data&&result.networkStatus===this.result.networkStatus)return;void 0===result.data&&(result.data=this.result.data),this.result=result,this.promise=createFulfilledPromise(result),this.deliver(this.promise)}},InternalQueryReference.prototype.handleError=function(error){var _a;if(this.subscription.unsubscribe(),this.subscription=this.observable.resubscribeAfterError(this.handleNext,this.handleError),"pending"===this.promise.status)null===(_a=this.reject)||void 0===_a||_a.call(this,error);else this.promise=createRejectedPromise(error),this.deliver(this.promise)},InternalQueryReference.prototype.deliver=function(promise){this.listeners.forEach((function(listener){return listener(promise)}))},InternalQueryReference.prototype.initiateFetch=function(returnedPromise){var _this=this;return this.promise=this.createPendingPromise(),this.promise.catch((function(){})),returnedPromise.then((function(){setTimeout((function(){var _a;"pending"===_this.promise.status&&(_this.result=_this.observable.getCurrentResult(),null===(_a=_this.resolve)||void 0===_a||_a.call(_this,_this.result))}))})).catch((function(){})),returnedPromise},InternalQueryReference.prototype.subscribeToQuery=function(){var _this=this;this.subscription=this.observable.filter((function(result){return!equal(result.data,{})&&!equal(result,_this.result)})).subscribe(this.handleNext,this.handleError)},InternalQueryReference.prototype.setResult=function(){var result=this.observable.getCurrentResult(!1);equal(result,this.result)||(this.result=result,this.promise=!result.data||result.partial&&!this.watchQueryOptions.returnPartialData?this.createPendingPromise():createFulfilledPromise(result))},InternalQueryReference.prototype.createPendingPromise=function(){var _this=this;return wrapPromiseWithState(new Promise((function(resolve,reject){_this.resolve=resolve,_this.reject=reject})))},InternalQueryReference}();export{InternalQueryReference};