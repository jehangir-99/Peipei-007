import*as React from"react";import PropTypes from"prop-types";import withSideEffect from"react-clientside-effect";import{moveFocusInside,focusInside,focusIsHidden,expandFocusableNodes}from"focus-lock";import{deferAction}from"./util";import{mediumFocus,mediumBlur,mediumEffect}from"./medium";var focusOnBody=function(){return document&&document.activeElement===document.body},isFreeFocus=function(){return focusOnBody()||focusIsHidden()},lastActiveTrap=null,lastActiveFocus=null,lastPortaledElement=null,focusWasOutsideWindow=!1,defaultWhitelist=function(){return!0},focusWhitelisted=function(activeElement){return(lastActiveTrap.whiteList||defaultWhitelist)(activeElement)},recordPortal=function(observerNode,portaledElement){lastPortaledElement={observerNode:observerNode,portaledElement:portaledElement}},focusIsPortaledPair=function(element){return lastPortaledElement&&lastPortaledElement.portaledElement===element};function autoGuard(startIndex,end,step,allNodes){var lastGuard=null,i=startIndex;do{var item=allNodes[i];if(item.guard)item.node.dataset.focusAutoGuard&&(lastGuard=item);else{if(!item.lockItem)break;if(i!==startIndex)return;lastGuard=null}}while((i+=step)!==end);lastGuard&&(lastGuard.node.tabIndex=0)}var extractRef=function(ref){return ref&&"current"in ref?ref.current:ref},focusWasOutside=function(crossFrameOption){return crossFrameOption?Boolean(focusWasOutsideWindow):"meanwhile"===focusWasOutsideWindow},checkInHost=function checkInHost(check,el,boundary){return el&&(el.host===check&&(!el.activeElement||boundary.contains(el.activeElement))||el.parentNode&&checkInHost(check,el.parentNode,boundary))},withinHost=function(activeElement,workingArea){return workingArea.some((function(area){return checkInHost(activeElement,area,area)}))},activateTrap=function(){var result=!1;if(lastActiveTrap){var _lastActiveTrap=lastActiveTrap,observed=_lastActiveTrap.observed,persistentFocus=_lastActiveTrap.persistentFocus,autoFocus=_lastActiveTrap.autoFocus,shards=_lastActiveTrap.shards,crossFrame=_lastActiveTrap.crossFrame,focusOptions=_lastActiveTrap.focusOptions,workingNode=observed||lastPortaledElement&&lastPortaledElement.portaledElement,activeElement=document&&document.activeElement;if(workingNode){var workingArea=[workingNode].concat(shards.map(extractRef).filter(Boolean));if(activeElement&&!focusWhitelisted(activeElement)||(persistentFocus||focusWasOutside(crossFrame)||!isFreeFocus()||!lastActiveFocus&&autoFocus)&&(workingNode&&!(focusInside(workingArea)||activeElement&&withinHost(activeElement,workingArea)||focusIsPortaledPair(activeElement,workingNode))&&(document&&!lastActiveFocus&&activeElement&&!autoFocus?(activeElement.blur&&activeElement.blur(),document.body.focus()):(result=moveFocusInside(workingArea,lastActiveFocus,{focusOptions:focusOptions}),lastPortaledElement={})),focusWasOutsideWindow=!1,lastActiveFocus=document&&document.activeElement),document){var newActiveElement=document&&document.activeElement,allNodes=expandFocusableNodes(workingArea),focusedIndex=allNodes.map((function(_ref){return _ref.node})).indexOf(newActiveElement);focusedIndex>-1&&(allNodes.filter((function(_ref2){var guard=_ref2.guard,node=_ref2.node;return guard&&node.dataset.focusAutoGuard})).forEach((function(_ref3){return _ref3.node.removeAttribute("tabIndex")})),autoGuard(focusedIndex,allNodes.length,1,allNodes),autoGuard(focusedIndex,-1,-1,allNodes))}}}return result},onTrap=function(event){activateTrap()&&event&&(event.stopPropagation(),event.preventDefault())},onBlur=function(){return deferAction(activateTrap)},onFocus=function(event){var source=event.target,currentNode=event.currentTarget;currentNode.contains(source)||recordPortal(currentNode,source)},FocusWatcher=function(){return null},FocusTrap=function(_ref4){var children=_ref4.children;return React.createElement("div",{onBlur:onBlur,onFocus:onFocus},children)};FocusTrap.propTypes="production"!==process.env.NODE_ENV?{children:PropTypes.node.isRequired}:{};var onWindowBlur=function(){focusWasOutsideWindow="just",deferAction((function(){focusWasOutsideWindow="meanwhile"}))},attachHandler=function(){document.addEventListener("focusin",onTrap),document.addEventListener("focusout",onBlur),window.addEventListener("blur",onWindowBlur)},detachHandler=function(){document.removeEventListener("focusin",onTrap),document.removeEventListener("focusout",onBlur),window.removeEventListener("blur",onWindowBlur)};function reducePropsToState(propsList){return propsList.filter((function(_ref5){return!_ref5.disabled}))}function handleStateChangeOnClient(traps){var trap=traps.slice(-1)[0];trap&&!lastActiveTrap&&attachHandler();var lastTrap=lastActiveTrap,sameTrap=lastTrap&&trap&&trap.id===lastTrap.id;lastActiveTrap=trap,lastTrap&&!sameTrap&&(lastTrap.onDeactivation(),traps.filter((function(_ref6){return _ref6.id===lastTrap.id})).length||lastTrap.returnFocus(!trap)),trap?(lastActiveFocus=null,sameTrap&&lastTrap.observed===trap.observed||trap.onActivation(),activateTrap(!0),deferAction(activateTrap)):(detachHandler(),lastActiveFocus=null)}mediumFocus.assignSyncMedium(onFocus),mediumBlur.assignMedium(onBlur),mediumEffect.assignMedium((function(cb){return cb({moveFocusInside:moveFocusInside,focusInside:focusInside})}));export default withSideEffect(reducePropsToState,handleStateChangeOnClient)(FocusWatcher);