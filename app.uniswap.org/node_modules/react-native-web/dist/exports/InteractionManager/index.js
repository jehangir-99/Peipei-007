import invariant from"fbjs/lib/invariant";import TaskQueue from"./TaskQueue";import EventEmitter from"../../vendor/react-native/vendor/emitter/EventEmitter";import requestIdleCallback from"../../modules/requestIdleCallback";var _emitter=new EventEmitter,InteractionManager={Events:{interactionStart:"interactionStart",interactionComplete:"interactionComplete"},runAfterInteractions(task){var tasks=[],promise=new Promise((resolve=>{_scheduleUpdate(),task&&tasks.push(task),tasks.push({run:resolve,name:"resolve "+(task&&task.name||"?")}),_taskQueue.enqueueTasks(tasks)}));return{then:promise.then.bind(promise),done:promise.then.bind(promise),cancel:()=>{_taskQueue.cancelTasks(tasks)}}},createInteractionHandle(){_scheduleUpdate();var handle=++_inc;return _addInteractionSet.add(handle),handle},clearInteractionHandle(handle){invariant(!!handle,"Must provide a handle to clear."),_scheduleUpdate(),_addInteractionSet.delete(handle),_deleteInteractionSet.add(handle)},addListener:_emitter.addListener.bind(_emitter),setDeadline(deadline){_deadline=deadline}},_interactionSet=new Set,_addInteractionSet=new Set,_deleteInteractionSet=new Set,_taskQueue=new TaskQueue({onMoreTasks:_scheduleUpdate}),_nextUpdateHandle=0,_inc=0,_deadline=-1;function _scheduleUpdate(){_nextUpdateHandle||(_nextUpdateHandle=_deadline>0?setTimeout(_processUpdate):requestIdleCallback(_processUpdate))}function _processUpdate(){_nextUpdateHandle=0;var interactionCount=_interactionSet.size;_addInteractionSet.forEach((handle=>_interactionSet.add(handle))),_deleteInteractionSet.forEach((handle=>_interactionSet.delete(handle)));var nextInteractionCount=_interactionSet.size;if(0!==interactionCount&&0===nextInteractionCount?_emitter.emit(InteractionManager.Events.interactionComplete):0===interactionCount&&0!==nextInteractionCount&&_emitter.emit(InteractionManager.Events.interactionStart),0===nextInteractionCount)for(var begin=Date.now();_taskQueue.hasTasksToProcess();)if(_taskQueue.processNext(),_deadline>0&&Date.now()-begin>=_deadline){_scheduleUpdate();break}_addInteractionSet.clear(),_deleteInteractionSet.clear()}export default InteractionManager;