import _createForOfIteratorHelperLoose from"@babel/runtime/helpers/createForOfIteratorHelperLoose";import _extends from"@babel/runtime/helpers/extends";import _objectSpread from"@babel/runtime/helpers/objectSpread2";import RefreshControl from"../../../exports/RefreshControl";import ScrollView from"../../../exports/ScrollView";import View from"../../../exports/View";import StyleSheet from"../../../exports/StyleSheet";import findNodeHandle from"../../../exports/findNodeHandle";import Batchinator from"../Batchinator";import clamp from"../Utilities/clamp";import infoLog from"../infoLog";import{CellRenderMask}from"./CellRenderMask";import ChildListCollection from"./ChildListCollection";import FillRateHelper from"../FillRateHelper";import StateSafePureComponent from"./StateSafePureComponent";import ViewabilityHelper from"../ViewabilityHelper";import CellRenderer from"./VirtualizedListCellRenderer";import{VirtualizedListCellContextProvider,VirtualizedListContext,VirtualizedListContextProvider}from"./VirtualizedListContext.js";import{computeWindowedRenderLimits,keyExtractor as defaultKeyExtractor}from"../VirtualizeUtils";import invariant from"fbjs/lib/invariant";import nullthrows from"nullthrows";import*as React from"react";var __DEV__="production"!==process.env.NODE_ENV,ON_EDGE_REACHED_EPSILON=.001,_usedIndexForKey=!1,_keylessItemComponentName="";function horizontalOrDefault(horizontal){return null!=horizontal&&horizontal}function initialNumToRenderOrDefault(initialNumToRender){return null!=initialNumToRender?initialNumToRender:10}function maxToRenderPerBatchOrDefault(maxToRenderPerBatch){return null!=maxToRenderPerBatch?maxToRenderPerBatch:10}function onStartReachedThresholdOrDefault(onStartReachedThreshold){return null!=onStartReachedThreshold?onStartReachedThreshold:2}function onEndReachedThresholdOrDefault(onEndReachedThreshold){return null!=onEndReachedThreshold?onEndReachedThreshold:2}function getScrollingThreshold(threshold,visibleLength){return threshold*visibleLength/2}function scrollEventThrottleOrDefault(scrollEventThrottle){return null!=scrollEventThrottle?scrollEventThrottle:50}function windowSizeOrDefault(windowSize){return null!=windowSize?windowSize:21}function findLastWhere(arr,predicate){for(var i=arr.length-1;i>=0;i--)if(predicate(arr[i]))return arr[i];return null}class VirtualizedList extends StateSafePureComponent{scrollToEnd(params){var animated=!params||params.animated,veryLast=this.props.getItemCount(this.props.data)-1;if(!(veryLast<0)){var frame=this.__getFrameMetricsApprox(veryLast,this.props),offset=Math.max(0,frame.offset+frame.length+this._footerLength-this._scrollMetrics.visibleLength);null!=this._scrollRef&&(null!=this._scrollRef.scrollTo?this._scrollRef.scrollTo(horizontalOrDefault(this.props.horizontal)?{x:offset,animated:animated}:{y:offset,animated:animated}):console.warn("No scrollTo method provided. This may be because you have two nested VirtualizedLists with the same orientation, or because you are using a custom component that does not implement scrollTo."))}}scrollToIndex(params){var _this$props=this.props,data=_this$props.data,horizontal=_this$props.horizontal,getItemCount=_this$props.getItemCount,getItemLayout=_this$props.getItemLayout,onScrollToIndexFailed=_this$props.onScrollToIndexFailed,animated=params.animated,index=params.index,viewOffset=params.viewOffset,viewPosition=params.viewPosition;if(invariant(index>=0,"scrollToIndex out of range: requested index "+index+" but minimum is 0"),invariant(getItemCount(data)>=1,"scrollToIndex out of range: item length "+getItemCount(data)+" but minimum is 1"),invariant(index<getItemCount(data),"scrollToIndex out of range: requested index "+index+" is out of 0 to "+(getItemCount(data)-1)),!getItemLayout&&index>this._highestMeasuredFrameIndex)return invariant(!!onScrollToIndexFailed,"scrollToIndex should be used in conjunction with getItemLayout or onScrollToIndexFailed, otherwise there is no way to know the location of offscreen indices or handle failures."),void onScrollToIndexFailed({averageItemLength:this._averageCellLength,highestMeasuredFrameIndex:this._highestMeasuredFrameIndex,index:index});var frame=this.__getFrameMetricsApprox(Math.floor(index),this.props),offset=Math.max(0,this._getOffsetApprox(index,this.props)-(viewPosition||0)*(this._scrollMetrics.visibleLength-frame.length))-(viewOffset||0);null!=this._scrollRef&&(null!=this._scrollRef.scrollTo?this._scrollRef.scrollTo(horizontal?{x:offset,animated:animated}:{y:offset,animated:animated}):console.warn("No scrollTo method provided. This may be because you have two nested VirtualizedLists with the same orientation, or because you are using a custom component that does not implement scrollTo."))}scrollToItem(params){for(var item=params.item,_this$props2=this.props,data=_this$props2.data,getItem=_this$props2.getItem,itemCount=(0,_this$props2.getItemCount)(data),_index=0;_index<itemCount;_index++)if(getItem(data,_index)===item){this.scrollToIndex(_objectSpread(_objectSpread({},params),{},{index:_index}));break}}scrollToOffset(params){var animated=params.animated,offset=params.offset;null!=this._scrollRef&&(null!=this._scrollRef.scrollTo?this._scrollRef.scrollTo(horizontalOrDefault(this.props.horizontal)?{x:offset,animated:animated}:{y:offset,animated:animated}):console.warn("No scrollTo method provided. This may be because you have two nested VirtualizedLists with the same orientation, or because you are using a custom component that does not implement scrollTo."))}recordInteraction(){this._nestedChildLists.forEach((childList=>{childList.recordInteraction()})),this._viewabilityTuples.forEach((t=>{t.viewabilityHelper.recordInteraction()})),this._updateViewableItems(this.props,this.state.cellsAroundViewport)}flashScrollIndicators(){null!=this._scrollRef&&this._scrollRef.flashScrollIndicators()}getScrollResponder(){if(this._scrollRef&&this._scrollRef.getScrollResponder)return this._scrollRef.getScrollResponder()}getScrollableNode(){return this._scrollRef&&this._scrollRef.getScrollableNode?this._scrollRef.getScrollableNode():this._scrollRef}getScrollRef(){return this._scrollRef&&this._scrollRef.getScrollRef?this._scrollRef.getScrollRef():this._scrollRef}_getCellKey(){var _this$context;return(null==(_this$context=this.context)?void 0:_this$context.cellKey)||"rootList"}hasMore(){return this._hasMore}constructor(_props){var _this$props$updateCel;if(super(_props),this._getScrollMetrics=()=>this._scrollMetrics,this._getOutermostParentListRef=()=>this._isNestedWithSameOrientation()?this.context.getOutermostParentListRef():this,this._registerAsNestedChild=childList=>{this._nestedChildLists.add(childList.ref,childList.cellKey),this._hasInteracted&&childList.ref.recordInteraction()},this._unregisterAsNestedChild=childList=>{this._nestedChildLists.remove(childList.ref)},this._onUpdateSeparators=(keys,newProps)=>{keys.forEach((key=>{var ref=null!=key&&this._cellRefs[key];ref&&ref.updateSeparatorProps(newProps)}))},this._getSpacerKey=isVertical=>isVertical?"height":"width",this._averageCellLength=0,this._cellRefs={},this._frames={},this._footerLength=0,this._hasTriggeredInitialScrollToIndex=!1,this._hasInteracted=!1,this._hasMore=!1,this._hasWarned={},this._headerLength=0,this._hiPriInProgress=!1,this._highestMeasuredFrameIndex=0,this._indicesToKeys=new Map,this._lastFocusedCellKey=null,this._nestedChildLists=new ChildListCollection,this._offsetFromParentVirtualizedList=0,this._prevParentOffset=0,this._scrollMetrics={contentLength:0,dOffset:0,dt:10,offset:0,timestamp:0,velocity:0,visibleLength:0,zoomScale:1},this._scrollRef=null,this._sentStartForContentLength=0,this._sentEndForContentLength=0,this._totalCellLength=0,this._totalCellsMeasured=0,this._viewabilityTuples=[],this._captureScrollRef=ref=>{this._scrollRef=ref},this._defaultRenderScrollComponent=props=>{var _props$refreshing,onRefresh=props.onRefresh;return this._isNestedWithSameOrientation()?React.createElement(View,props):onRefresh?(invariant("boolean"==typeof props.refreshing,"`refreshing` prop must be set as a boolean in order to use `onRefresh`, but got `"+JSON.stringify(null!==(_props$refreshing=props.refreshing)&&void 0!==_props$refreshing?_props$refreshing:"undefined")+"`"),React.createElement(ScrollView,_extends({},props,{refreshControl:null==props.refreshControl?React.createElement(RefreshControl,{refreshing:props.refreshing,onRefresh:onRefresh,progressViewOffset:props.progressViewOffset}):props.refreshControl}))):React.createElement(ScrollView,props)},this._onCellLayout=(e,cellKey,index)=>{var layout=e.nativeEvent.layout,next={offset:this._selectOffset(layout),length:this._selectLength(layout),index:index,inLayout:!0},curr=this._frames[cellKey];curr&&next.offset===curr.offset&&next.length===curr.length&&index===curr.index?this._frames[cellKey].inLayout=!0:(this._totalCellLength+=next.length-(curr?curr.length:0),this._totalCellsMeasured+=curr?0:1,this._averageCellLength=this._totalCellLength/this._totalCellsMeasured,this._frames[cellKey]=next,this._highestMeasuredFrameIndex=Math.max(this._highestMeasuredFrameIndex,index),this._scheduleCellsToRenderUpdate()),this._triggerRemeasureForChildListsInCell(cellKey),this._computeBlankness(),this._updateViewableItems(this.props,this.state.cellsAroundViewport)},this._onCellUnmount=cellKey=>{delete this._cellRefs[cellKey];var curr=this._frames[cellKey];curr&&(this._frames[cellKey]=_objectSpread(_objectSpread({},curr),{},{inLayout:!1}))},this._onLayout=e=>{this._isNestedWithSameOrientation()?this.measureLayoutRelativeToContainingList():this._scrollMetrics.visibleLength=this._selectLength(e.nativeEvent.layout),this.props.onLayout&&this.props.onLayout(e),this._scheduleCellsToRenderUpdate(),this._maybeCallOnEdgeReached()},this._onLayoutEmpty=e=>{this.props.onLayout&&this.props.onLayout(e)},this._onLayoutFooter=e=>{this._triggerRemeasureForChildListsInCell(this._getFooterCellKey()),this._footerLength=this._selectLength(e.nativeEvent.layout)},this._onLayoutHeader=e=>{this._headerLength=this._selectLength(e.nativeEvent.layout)},this._onContentSizeChange=(width,height)=>{width>0&&height>0&&null!=this.props.initialScrollIndex&&this.props.initialScrollIndex>0&&!this._hasTriggeredInitialScrollToIndex&&(null==this.props.contentOffset&&(this.props.initialScrollIndex<this.props.getItemCount(this.props.data)?this.scrollToIndex({animated:!1,index:nullthrows(this.props.initialScrollIndex)}):this.scrollToEnd({animated:!1})),this._hasTriggeredInitialScrollToIndex=!0),this.props.onContentSizeChange&&this.props.onContentSizeChange(width,height),this._scrollMetrics.contentLength=this._selectLength({height:height,width:width}),this._scheduleCellsToRenderUpdate(),this._maybeCallOnEdgeReached()},this._convertParentScrollMetrics=metrics=>{var offset=metrics.offset-this._offsetFromParentVirtualizedList,visibleLength=metrics.visibleLength,dOffset=offset-this._scrollMetrics.offset;return{visibleLength:visibleLength,contentLength:this._scrollMetrics.contentLength,offset:offset,dOffset:dOffset}},this._onScroll=e=>{this._nestedChildLists.forEach((childList=>{childList._onScroll(e)})),this.props.onScroll&&this.props.onScroll(e);var timestamp=e.timeStamp,visibleLength=this._selectLength(e.nativeEvent.layoutMeasurement),contentLength=this._selectLength(e.nativeEvent.contentSize),offset=this._selectOffset(e.nativeEvent.contentOffset),dOffset=offset-this._scrollMetrics.offset;if(this._isNestedWithSameOrientation()){if(0===this._scrollMetrics.contentLength)return;var _this$_convertParentS=this._convertParentScrollMetrics({visibleLength:visibleLength,offset:offset});visibleLength=_this$_convertParentS.visibleLength,contentLength=_this$_convertParentS.contentLength,offset=_this$_convertParentS.offset,dOffset=_this$_convertParentS.dOffset}var dt=this._scrollMetrics.timestamp?Math.max(1,timestamp-this._scrollMetrics.timestamp):1,velocity=dOffset/dt;dt>500&&this._scrollMetrics.dt>500&&contentLength>5*visibleLength&&!this._hasWarned.perf&&(infoLog("VirtualizedList: You have a large list that is slow to update - make sure your renderItem function renders components that follow React performance best practices like PureComponent, shouldComponentUpdate, etc.",{dt:dt,prevDt:this._scrollMetrics.dt,contentLength:contentLength}),this._hasWarned.perf=!0);var zoomScale=e.nativeEvent.zoomScale<0?1:e.nativeEvent.zoomScale;this._scrollMetrics={contentLength:contentLength,dt:dt,dOffset:dOffset,offset:offset,timestamp:timestamp,velocity:velocity,visibleLength:visibleLength,zoomScale:zoomScale},this._updateViewableItems(this.props,this.state.cellsAroundViewport),this.props&&(this._maybeCallOnEdgeReached(),0!==velocity&&this._fillRateHelper.activate(),this._computeBlankness(),this._scheduleCellsToRenderUpdate())},this._onScrollBeginDrag=e=>{this._nestedChildLists.forEach((childList=>{childList._onScrollBeginDrag(e)})),this._viewabilityTuples.forEach((tuple=>{tuple.viewabilityHelper.recordInteraction()})),this._hasInteracted=!0,this.props.onScrollBeginDrag&&this.props.onScrollBeginDrag(e)},this._onScrollEndDrag=e=>{this._nestedChildLists.forEach((childList=>{childList._onScrollEndDrag(e)}));var velocity=e.nativeEvent.velocity;velocity&&(this._scrollMetrics.velocity=this._selectOffset(velocity)),this._computeBlankness(),this.props.onScrollEndDrag&&this.props.onScrollEndDrag(e)},this._onMomentumScrollBegin=e=>{this._nestedChildLists.forEach((childList=>{childList._onMomentumScrollBegin(e)})),this.props.onMomentumScrollBegin&&this.props.onMomentumScrollBegin(e)},this._onMomentumScrollEnd=e=>{this._nestedChildLists.forEach((childList=>{childList._onMomentumScrollEnd(e)})),this._scrollMetrics.velocity=0,this._computeBlankness(),this.props.onMomentumScrollEnd&&this.props.onMomentumScrollEnd(e)},this._updateCellsToRender=()=>{this._updateViewableItems(this.props,this.state.cellsAroundViewport),this.setState(((state,props)=>{var cellsAroundViewport=this._adjustCellsAroundViewport(props,state.cellsAroundViewport),renderMask=VirtualizedList._createRenderMask(props,cellsAroundViewport,this._getNonViewportRenderRegions(props));return cellsAroundViewport.first===state.cellsAroundViewport.first&&cellsAroundViewport.last===state.cellsAroundViewport.last&&renderMask.equals(state.renderMask)?null:{cellsAroundViewport:cellsAroundViewport,renderMask:renderMask}}))},this._createViewToken=(index,isViewable,props)=>{var data=props.data,item=(0,props.getItem)(data,index);return{index:index,item:item,key:this._keyExtractor(item,index,props),isViewable:isViewable}},this._getOffsetApprox=(index,props)=>{if(Number.isInteger(index))return this.__getFrameMetricsApprox(index,props).offset;var frameMetrics=this.__getFrameMetricsApprox(Math.floor(index),props),remainder=index-Math.floor(index);return frameMetrics.offset+remainder*frameMetrics.length},this.__getFrameMetricsApprox=(index,props)=>{var frame=this._getFrameMetrics(index,props);if(frame&&frame.index===index)return frame;var data=props.data,getItemCount=props.getItemCount,getItemLayout=props.getItemLayout;return invariant(index>=0&&index<getItemCount(data),"Tried to get frame for out of range index "+index),invariant(!getItemLayout,"Should not have to estimate frames when a measurement metrics function is provided"),{length:this._averageCellLength,offset:this._averageCellLength*index}},this._getFrameMetrics=(index,props)=>{var data=props.data,getItem=props.getItem,getItemCount=props.getItemCount,getItemLayout=props.getItemLayout;invariant(index>=0&&index<getItemCount(data),"Tried to get frame for out of range index "+index);var item=getItem(data,index),frame=this._frames[this._keyExtractor(item,index,props)];return frame&&frame.index===index||!getItemLayout?frame:getItemLayout(data,index)},this._getNonViewportRenderRegions=props=>{if(!this._lastFocusedCellKey||!this._cellRefs[this._lastFocusedCellKey])return[];var focusedCellIndex=this._cellRefs[this._lastFocusedCellKey].props.index,itemCount=props.getItemCount(props.data);if(focusedCellIndex>=itemCount||this._keyExtractor(props.getItem(props.data,focusedCellIndex),focusedCellIndex,props)!==this._lastFocusedCellKey)return[];for(var first=focusedCellIndex,heightOfCellsBeforeFocused=0,i=first-1;i>=0&&heightOfCellsBeforeFocused<this._scrollMetrics.visibleLength;i--)first--,heightOfCellsBeforeFocused+=this.__getFrameMetricsApprox(i,props).length;for(var last=focusedCellIndex,heightOfCellsAfterFocused=0,_i=last+1;_i<itemCount&&heightOfCellsAfterFocused<this._scrollMetrics.visibleLength;_i++)last++,heightOfCellsAfterFocused+=this.__getFrameMetricsApprox(_i,props).length;return[{first:first,last:last}]},this._checkProps(_props),this._fillRateHelper=new FillRateHelper(this._getFrameMetrics),this._updateCellsToRenderBatcher=new Batchinator(this._updateCellsToRender,null!==(_this$props$updateCel=this.props.updateCellsBatchingPeriod)&&void 0!==_this$props$updateCel?_this$props$updateCel:50),this.props.viewabilityConfigCallbackPairs)this._viewabilityTuples=this.props.viewabilityConfigCallbackPairs.map((pair=>({viewabilityHelper:new ViewabilityHelper(pair.viewabilityConfig),onViewableItemsChanged:pair.onViewableItemsChanged})));else{var _this$props3=this.props,onViewableItemsChanged=_this$props3.onViewableItemsChanged,viewabilityConfig=_this$props3.viewabilityConfig;onViewableItemsChanged&&this._viewabilityTuples.push({viewabilityHelper:new ViewabilityHelper(viewabilityConfig),onViewableItemsChanged:onViewableItemsChanged})}var initialRenderRegion=VirtualizedList._initialRenderRegion(_props);this.state={cellsAroundViewport:initialRenderRegion,renderMask:VirtualizedList._createRenderMask(_props,initialRenderRegion)},this.invertedWheelEventHandler=ev=>{var scrollOffset=this.props.horizontal?ev.target.scrollLeft:ev.target.scrollTop,scrollLength=this.props.horizontal?ev.target.scrollWidth:ev.target.scrollHeight,clientLength=this.props.horizontal?ev.target.clientWidth:ev.target.clientHeight,isEventTargetScrollable=scrollLength>clientLength,delta=this.props.horizontal?ev.deltaX||ev.wheelDeltaX:ev.deltaY||ev.wheelDeltaY,leftoverDelta=delta;isEventTargetScrollable&&(leftoverDelta=delta<0?Math.min(delta+scrollOffset,0):Math.max(delta-(scrollLength-clientLength-scrollOffset),0));var targetDelta=delta-leftoverDelta;if(this.props.inverted&&this._scrollRef&&this._scrollRef.getScrollableNode){var node=this._scrollRef.getScrollableNode();if(this.props.horizontal){ev.target.scrollLeft+=targetDelta;var nextScrollLeft=node.scrollLeft-leftoverDelta;node.scrollLeft=this.props.getItemLayout?nextScrollLeft:Math.min(nextScrollLeft,this._totalCellLength)}else{ev.target.scrollTop+=targetDelta;var nextScrollTop=node.scrollTop-leftoverDelta;node.scrollTop=this.props.getItemLayout?nextScrollTop:Math.min(nextScrollTop,this._totalCellLength)}ev.preventDefault()}}}_checkProps(props){var onScroll=props.onScroll,windowSize=props.windowSize,getItemCount=props.getItemCount,data=props.data,initialScrollIndex=props.initialScrollIndex;invariant(!onScroll||!onScroll.__isNative,"Components based on VirtualizedList must be wrapped with Animated.createAnimatedComponent to support native onScroll events with useNativeDriver"),invariant(windowSizeOrDefault(windowSize)>0,"VirtualizedList: The windowSize prop must be present and set to a value greater than 0."),invariant(getItemCount,'VirtualizedList: The "getItemCount" prop must be provided');var itemCount=getItemCount(data);if(null==initialScrollIndex||this._hasTriggeredInitialScrollToIndex||!(initialScrollIndex<0||itemCount>0&&initialScrollIndex>=itemCount)||this._hasWarned.initialScrollIndex||(console.warn('initialScrollIndex "'+initialScrollIndex+'" is not valid (list has '+itemCount+" items)"),this._hasWarned.initialScrollIndex=!0),__DEV__&&!this._hasWarned.flexWrap){var flatStyles=StyleSheet.flatten(this.props.contentContainerStyle);null!=flatStyles&&"wrap"===flatStyles.flexWrap&&(console.warn("`flexWrap: `wrap`` is not supported with the `VirtualizedList` components.Consider using `numColumns` with `FlatList` instead."),this._hasWarned.flexWrap=!0)}}static _createRenderMask(props,cellsAroundViewport,additionalRegions){var itemCount=props.getItemCount(props.data);invariant(cellsAroundViewport.first>=0&&cellsAroundViewport.last>=cellsAroundViewport.first-1&&cellsAroundViewport.last<itemCount,'Invalid cells around viewport "['+cellsAroundViewport.first+", "+cellsAroundViewport.last+']" was passed to VirtualizedList._createRenderMask');var renderMask=new CellRenderMask(itemCount);if(itemCount>0){for(var _i2=0,_allRegions=[cellsAroundViewport,...null!=additionalRegions?additionalRegions:[]];_i2<_allRegions.length;_i2++){var region=_allRegions[_i2];renderMask.addCells(region)}if(null==props.initialScrollIndex||props.initialScrollIndex<=0){var initialRegion=VirtualizedList._initialRenderRegion(props);renderMask.addCells(initialRegion)}var stickyIndicesSet=new Set(props.stickyHeaderIndices);VirtualizedList._ensureClosestStickyHeader(props,stickyIndicesSet,renderMask,cellsAroundViewport.first)}return renderMask}static _initialRenderRegion(props){var _props$initialScrollI,itemCount=props.getItemCount(props.data),firstCellIndex=Math.max(0,Math.min(itemCount-1,Math.floor(null!==(_props$initialScrollI=props.initialScrollIndex)&&void 0!==_props$initialScrollI?_props$initialScrollI:0)));return{first:firstCellIndex,last:Math.min(itemCount,firstCellIndex+initialNumToRenderOrDefault(props.initialNumToRender))-1}}static _ensureClosestStickyHeader(props,stickyIndicesSet,renderMask,cellIdx){for(var stickyOffset=props.ListHeaderComponent?1:0,itemIdx=cellIdx-1;itemIdx>=0;itemIdx--)if(stickyIndicesSet.has(itemIdx+stickyOffset)){renderMask.addCells({first:itemIdx,last:itemIdx});break}}_adjustCellsAroundViewport(props,cellsAroundViewport){var newCellsAroundViewport,data=props.data,getItemCount=props.getItemCount,onEndReachedThreshold=onEndReachedThresholdOrDefault(props.onEndReachedThreshold),_this$_scrollMetrics=this._scrollMetrics,contentLength=_this$_scrollMetrics.contentLength,offset=_this$_scrollMetrics.offset,visibleLength=_this$_scrollMetrics.visibleLength,distanceFromEnd=contentLength-visibleLength-offset;if(visibleLength<=0||contentLength<=0)return cellsAroundViewport.last>=getItemCount(data)?VirtualizedList._constrainToItemCount(cellsAroundViewport,props):cellsAroundViewport;if(props.disableVirtualization){var renderAhead=distanceFromEnd<onEndReachedThreshold*visibleLength?maxToRenderPerBatchOrDefault(props.maxToRenderPerBatch):0;newCellsAroundViewport={first:0,last:Math.min(cellsAroundViewport.last+renderAhead,getItemCount(data)-1)}}else{if(props.initialScrollIndex&&!this._scrollMetrics.offset&&Math.abs(distanceFromEnd)>=Number.EPSILON)return cellsAroundViewport.last>=getItemCount(data)?VirtualizedList._constrainToItemCount(cellsAroundViewport,props):cellsAroundViewport;newCellsAroundViewport=computeWindowedRenderLimits(props,maxToRenderPerBatchOrDefault(props.maxToRenderPerBatch),windowSizeOrDefault(props.windowSize),cellsAroundViewport,this.__getFrameMetricsApprox,this._scrollMetrics),invariant(newCellsAroundViewport.last<getItemCount(data),"computeWindowedRenderLimits() should return range in-bounds")}if(this._nestedChildLists.size()>0){var childIdx=this._findFirstChildWithMore(newCellsAroundViewport.first,newCellsAroundViewport.last);newCellsAroundViewport.last=null!=childIdx?childIdx:newCellsAroundViewport.last}return newCellsAroundViewport}_findFirstChildWithMore(first,last){for(var ii=first;ii<=last;ii++){var cellKeyForIndex=this._indicesToKeys.get(ii);if(null!=cellKeyForIndex&&this._nestedChildLists.anyInCell(cellKeyForIndex,(childList=>childList.hasMore())))return ii}return null}componentDidMount(){this._isNestedWithSameOrientation()&&this.context.registerAsNestedChild({ref:this,cellKey:this.context.cellKey}),this.setupWebWheelHandler()}componentWillUnmount(){this._isNestedWithSameOrientation()&&this.context.unregisterAsNestedChild({ref:this}),this._updateCellsToRenderBatcher.dispose({abort:!0}),this._viewabilityTuples.forEach((tuple=>{tuple.viewabilityHelper.dispose()})),this._fillRateHelper.deactivateAndFlush(),this.teardownWebWheelHandler()}setupWebWheelHandler(){this._scrollRef&&this._scrollRef.getScrollableNode?this._scrollRef.getScrollableNode().addEventListener("wheel",this.invertedWheelEventHandler):setTimeout((()=>this.setupWebWheelHandler()),50)}teardownWebWheelHandler(){this._scrollRef&&this._scrollRef.getScrollableNode&&this._scrollRef.getScrollableNode().removeEventListener("wheel",this.invertedWheelEventHandler)}static getDerivedStateFromProps(newProps,prevState){if(newProps.getItemCount(newProps.data)===prevState.renderMask.numCells())return prevState;var constrainedCells=VirtualizedList._constrainToItemCount(prevState.cellsAroundViewport,newProps);return{cellsAroundViewport:constrainedCells,renderMask:VirtualizedList._createRenderMask(newProps,constrainedCells)}}_pushCells(cells,stickyHeaderIndices,stickyIndicesFromProps,first,last,inversionStyle){var prevCellKey,_this=this,_this$props4=this.props,CellRendererComponent=_this$props4.CellRendererComponent,ItemSeparatorComponent=_this$props4.ItemSeparatorComponent,ListHeaderComponent=_this$props4.ListHeaderComponent,ListItemComponent=_this$props4.ListItemComponent,data=_this$props4.data,debug=_this$props4.debug,getItem=_this$props4.getItem,getItemCount=_this$props4.getItemCount,getItemLayout=_this$props4.getItemLayout,horizontal=_this$props4.horizontal,renderItem=_this$props4.renderItem,stickyOffset=ListHeaderComponent?1:0,end=getItemCount(data)-1;last=Math.min(end,last);for(var _loop=function(){var item=getItem(data,ii),key=_this._keyExtractor(item,ii,_this.props);_this._indicesToKeys.set(ii,key),stickyIndicesFromProps.has(ii+stickyOffset)&&stickyHeaderIndices.push(cells.length);var shouldListenForLayout=null==getItemLayout||debug||_this._fillRateHelper.enabled();cells.push(React.createElement(CellRenderer,_extends({CellRendererComponent:CellRendererComponent,ItemSeparatorComponent:ii<end?ItemSeparatorComponent:void 0,ListItemComponent:ListItemComponent,cellKey:key,horizontal:horizontal,index:ii,inversionStyle:inversionStyle,item:item,key:key,prevCellKey:prevCellKey,onUpdateSeparators:_this._onUpdateSeparators,onCellFocusCapture:e=>_this._onCellFocusCapture(key),onUnmount:_this._onCellUnmount,ref:_ref=>{_this._cellRefs[key]=_ref},renderItem:renderItem},shouldListenForLayout&&{onCellLayout:_this._onCellLayout}))),prevCellKey=key},ii=first;ii<=last;ii++)_loop()}static _constrainToItemCount(cells,props){var itemCount=props.getItemCount(props.data),last=Math.min(itemCount-1,cells.last),maxToRenderPerBatch=maxToRenderPerBatchOrDefault(props.maxToRenderPerBatch);return{first:clamp(0,itemCount-1-maxToRenderPerBatch,cells.first),last:last}}_isNestedWithSameOrientation(){var nestedContext=this.context;return!(!nestedContext||!!nestedContext.horizontal!==horizontalOrDefault(this.props.horizontal))}_keyExtractor(item,index,props){if(null!=props.keyExtractor)return props.keyExtractor(item,index);var key=defaultKeyExtractor(item,index);return key===String(index)&&(_usedIndexForKey=!0,item.type&&item.type.displayName&&(_keylessItemComponentName=item.type.displayName)),key}render(){this._checkProps(this.props);var _this$props5=this.props,ListEmptyComponent=_this$props5.ListEmptyComponent,ListFooterComponent=_this$props5.ListFooterComponent,ListHeaderComponent=_this$props5.ListHeaderComponent,_this$props6=this.props,data=_this$props6.data,horizontal=_this$props6.horizontal,inversionStyle=this.props.inverted?horizontalOrDefault(this.props.horizontal)?styles.horizontallyInverted:styles.verticallyInverted:null,cells=[],stickyIndicesFromProps=new Set(this.props.stickyHeaderIndices),stickyHeaderIndices=[];if(ListHeaderComponent){stickyIndicesFromProps.has(0)&&stickyHeaderIndices.push(0);var _element=React.isValidElement(ListHeaderComponent)?ListHeaderComponent:React.createElement(ListHeaderComponent,null);cells.push(React.createElement(VirtualizedListCellContextProvider,{cellKey:this._getCellKey()+"-header",key:"$header"},React.createElement(View,{onLayout:this._onLayoutHeader,style:[inversionStyle,this.props.ListHeaderComponentStyle]},_element)))}var itemCount=this.props.getItemCount(data);if(0===itemCount&&ListEmptyComponent){var _element2=React.isValidElement(ListEmptyComponent)?ListEmptyComponent:React.createElement(ListEmptyComponent,null);cells.push(React.createElement(VirtualizedListCellContextProvider,{cellKey:this._getCellKey()+"-empty",key:"$empty"},React.cloneElement(_element2,{onLayout:event=>{this._onLayoutEmpty(event),_element2.props.onLayout&&_element2.props.onLayout(event)},style:[inversionStyle,_element2.props.style]})))}if(itemCount>0){_usedIndexForKey=!1,_keylessItemComponentName="";for(var _step,spacerKey=this._getSpacerKey(!horizontal),renderRegions=this.state.renderMask.enumerateRegions(),lastSpacer=findLastWhere(renderRegions,(r=>r.isSpacer)),_iterator=_createForOfIteratorHelperLoose(renderRegions);!(_step=_iterator()).done;){var section=_step.value;if(section.isSpacer){if(this.props.disableVirtualization)continue;var last=section===lastSpacer&&!this.props.getItemLayout?clamp(section.first-1,section.last,this._highestMeasuredFrameIndex):section.last,firstMetrics=this.__getFrameMetricsApprox(section.first,this.props),lastMetrics=this.__getFrameMetricsApprox(last,this.props),spacerSize=lastMetrics.offset+lastMetrics.length-firstMetrics.offset;cells.push(React.createElement(View,{key:"$spacer-"+section.first,style:{[spacerKey]:spacerSize}}))}else this._pushCells(cells,stickyHeaderIndices,stickyIndicesFromProps,section.first,section.last,inversionStyle)}!this._hasWarned.keys&&_usedIndexForKey&&(console.warn("VirtualizedList: missing keys for items, make sure to specify a key or id property on each item or provide a custom keyExtractor.",_keylessItemComponentName),this._hasWarned.keys=!0)}if(ListFooterComponent){var _element3=React.isValidElement(ListFooterComponent)?ListFooterComponent:React.createElement(ListFooterComponent,null);cells.push(React.createElement(VirtualizedListCellContextProvider,{cellKey:this._getFooterCellKey(),key:"$footer"},React.createElement(View,{onLayout:this._onLayoutFooter,style:[inversionStyle,this.props.ListFooterComponentStyle]},_element3)))}var scrollProps=_objectSpread(_objectSpread({},this.props),{},{onContentSizeChange:this._onContentSizeChange,onLayout:this._onLayout,onScroll:this._onScroll,onScrollBeginDrag:this._onScrollBeginDrag,onScrollEndDrag:this._onScrollEndDrag,onMomentumScrollBegin:this._onMomentumScrollBegin,onMomentumScrollEnd:this._onMomentumScrollEnd,scrollEventThrottle:scrollEventThrottleOrDefault(this.props.scrollEventThrottle),invertStickyHeaders:void 0!==this.props.invertStickyHeaders?this.props.invertStickyHeaders:this.props.inverted,stickyHeaderIndices:stickyHeaderIndices,style:inversionStyle?[inversionStyle,this.props.style]:this.props.style});this._hasMore=this.state.cellsAroundViewport.last<itemCount-1;var ret=React.createElement(VirtualizedListContextProvider,{value:{cellKey:null,getScrollMetrics:this._getScrollMetrics,horizontal:horizontalOrDefault(this.props.horizontal),getOutermostParentListRef:this._getOutermostParentListRef,registerAsNestedChild:this._registerAsNestedChild,unregisterAsNestedChild:this._unregisterAsNestedChild}},React.cloneElement((this.props.renderScrollComponent||this._defaultRenderScrollComponent)(scrollProps),{ref:this._captureScrollRef},cells));return this.props.debug?React.createElement(View,{style:styles.debug},ret,this._renderDebugOverlay()):ret}componentDidUpdate(prevProps){var _this$props7=this.props,data=_this$props7.data,extraData=_this$props7.extraData;data===prevProps.data&&extraData===prevProps.extraData||this._viewabilityTuples.forEach((tuple=>{tuple.viewabilityHelper.resetViewableIndices()}));var hiPriInProgress=this._hiPriInProgress;this._scheduleCellsToRenderUpdate(),hiPriInProgress&&(this._hiPriInProgress=!1)}_computeBlankness(){this._fillRateHelper.computeBlankness(this.props,this.state.cellsAroundViewport,this._scrollMetrics)}_onCellFocusCapture(cellKey){this._lastFocusedCellKey=cellKey,this._updateCellsToRender()}_triggerRemeasureForChildListsInCell(cellKey){this._nestedChildLists.forEachInCell(cellKey,(childList=>{childList.measureLayoutRelativeToContainingList()}))}measureLayoutRelativeToContainingList(){try{if(!this._scrollRef)return;this._scrollRef.measureLayout(this.context.getOutermostParentListRef().getScrollRef(),((x,y,width,height)=>{this._offsetFromParentVirtualizedList=this._selectOffset({x:x,y:y}),this._scrollMetrics.contentLength=this._selectLength({width:width,height:height});var scrollMetrics=this._convertParentScrollMetrics(this.context.getScrollMetrics());(this._scrollMetrics.visibleLength!==scrollMetrics.visibleLength||this._scrollMetrics.offset!==scrollMetrics.offset)&&(this._scrollMetrics.visibleLength=scrollMetrics.visibleLength,this._scrollMetrics.offset=scrollMetrics.offset,this._nestedChildLists.forEach((childList=>{childList.measureLayoutRelativeToContainingList()})))}),(error=>{console.warn("VirtualizedList: Encountered an error while measuring a list's offset from its containing VirtualizedList.")}))}catch(error){console.warn("measureLayoutRelativeToContainingList threw an error",error.stack)}}_getFooterCellKey(){return this._getCellKey()+"-footer"}_renderDebugOverlay(){for(var normalize=this._scrollMetrics.visibleLength/(this._scrollMetrics.contentLength||1),framesInLayout=[],itemCount=this.props.getItemCount(this.props.data),ii=0;ii<itemCount;ii++){var frame=this.__getFrameMetricsApprox(ii,this.props);frame.inLayout&&framesInLayout.push(frame)}var windowTop=this.__getFrameMetricsApprox(this.state.cellsAroundViewport.first,this.props).offset,frameLast=this.__getFrameMetricsApprox(this.state.cellsAroundViewport.last,this.props),windowLen=frameLast.offset+frameLast.length-windowTop,visTop=this._scrollMetrics.offset,visLen=this._scrollMetrics.visibleLength;return React.createElement(View,{style:[styles.debugOverlayBase,styles.debugOverlay]},framesInLayout.map(((f,ii)=>React.createElement(View,{key:"f"+ii,style:[styles.debugOverlayBase,styles.debugOverlayFrame,{top:f.offset*normalize,height:f.length*normalize}]}))),React.createElement(View,{style:[styles.debugOverlayBase,styles.debugOverlayFrameLast,{top:windowTop*normalize,height:windowLen*normalize}]}),React.createElement(View,{style:[styles.debugOverlayBase,styles.debugOverlayFrameVis,{top:visTop*normalize,height:visLen*normalize}]}))}_selectLength(metrics){return horizontalOrDefault(this.props.horizontal)?metrics.width:metrics.height}_selectOffset(metrics){return horizontalOrDefault(this.props.horizontal)?metrics.x:metrics.y}_maybeCallOnEdgeReached(){var _this$props8=this.props,data=_this$props8.data,getItemCount=_this$props8.getItemCount,onStartReached=_this$props8.onStartReached,onStartReachedThreshold=_this$props8.onStartReachedThreshold,onEndReached=_this$props8.onEndReached,onEndReachedThreshold=_this$props8.onEndReachedThreshold,initialScrollIndex=_this$props8.initialScrollIndex,_this$_scrollMetrics2=this._scrollMetrics,contentLength=_this$_scrollMetrics2.contentLength,visibleLength=_this$_scrollMetrics2.visibleLength,offset=_this$_scrollMetrics2.offset,distanceFromStart=offset,distanceFromEnd=contentLength-visibleLength-offset;distanceFromStart<ON_EDGE_REACHED_EPSILON&&(distanceFromStart=0),distanceFromEnd<ON_EDGE_REACHED_EPSILON&&(distanceFromEnd=0);var isWithinStartThreshold=distanceFromStart<=(null!=onStartReachedThreshold?onStartReachedThreshold*visibleLength:2),isWithinEndThreshold=distanceFromEnd<=(null!=onEndReachedThreshold?onEndReachedThreshold*visibleLength:2);onEndReached&&this.state.cellsAroundViewport.last===getItemCount(data)-1&&isWithinEndThreshold&&this._scrollMetrics.contentLength!==this._sentEndForContentLength?(this._sentEndForContentLength=this._scrollMetrics.contentLength,onEndReached({distanceFromEnd:distanceFromEnd})):null!=onStartReached&&0===this.state.cellsAroundViewport.first&&isWithinStartThreshold&&this._scrollMetrics.contentLength!==this._sentStartForContentLength?initialScrollIndex&&0===this._scrollMetrics.timestamp||(this._sentStartForContentLength=this._scrollMetrics.contentLength,onStartReached({distanceFromStart:distanceFromStart})):(this._sentStartForContentLength=isWithinStartThreshold?this._sentStartForContentLength:0,this._sentEndForContentLength=isWithinEndThreshold?this._sentEndForContentLength:0)}_scheduleCellsToRenderUpdate(){var _this$state$cellsArou=this.state.cellsAroundViewport,first=_this$state$cellsArou.first,last=_this$state$cellsArou.last,_this$_scrollMetrics3=this._scrollMetrics,offset=_this$_scrollMetrics3.offset,visibleLength=_this$_scrollMetrics3.visibleLength,velocity=_this$_scrollMetrics3.velocity,itemCount=this.props.getItemCount(this.props.data),hiPri=!1,onStartReachedThreshold=onStartReachedThresholdOrDefault(this.props.onStartReachedThreshold),onEndReachedThreshold=onEndReachedThresholdOrDefault(this.props.onEndReachedThreshold);if(first>0){var distTop=offset-this.__getFrameMetricsApprox(first,this.props).offset;hiPri=distTop<0||velocity<-2&&distTop<getScrollingThreshold(onStartReachedThreshold,visibleLength)}if(!hiPri&&last>=0&&last<itemCount-1){var distBottom=this.__getFrameMetricsApprox(last,this.props).offset-(offset+visibleLength);hiPri=distBottom<0||velocity>2&&distBottom<getScrollingThreshold(onEndReachedThreshold,visibleLength)}if(hiPri&&(this._averageCellLength||this.props.getItemLayout)&&!this._hiPriInProgress)return this._hiPriInProgress=!0,this._updateCellsToRenderBatcher.dispose({abort:!0}),void this._updateCellsToRender();this._updateCellsToRenderBatcher.schedule()}_updateViewableItems(props,cellsAroundViewport){this._viewabilityTuples.forEach((tuple=>{tuple.viewabilityHelper.onUpdate(props,this._scrollMetrics.offset,this._scrollMetrics.visibleLength,this._getFrameMetrics,this._createViewToken,tuple.onViewableItemsChanged,cellsAroundViewport)}))}}VirtualizedList.contextType=VirtualizedListContext;var styles=StyleSheet.create({verticallyInverted:{transform:"scaleY(-1)"},horizontallyInverted:{transform:"scaleX(-1)"},debug:{flex:1},debugOverlayBase:{position:"absolute",top:0,right:0},debugOverlay:{bottom:0,width:20,borderColor:"blue",borderWidth:1},debugOverlayFrame:{left:0,backgroundColor:"orange"},debugOverlayFrameLast:{left:0,borderColor:"green",borderWidth:2},debugOverlayFrameVis:{left:0,borderColor:"red",borderWidth:2}});export default VirtualizedList;