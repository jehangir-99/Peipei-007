import{isNaN,isVueViewModel,isSyntheticEvent}from"./is.js";import{memoBuilder}from"./memo.js";import{convertToPlainObject}from"./object.js";import{getFunctionName}from"./stacktrace.js";function normalize(input,depth=100,maxProperties=1/0){try{return visit("",input,depth,maxProperties)}catch(err){return{ERROR:`**non-serializable** (${err})`}}}function normalizeToSize(object,depth=3,maxSize=102400){const normalized=normalize(object,depth);return jsonSize(normalized)>maxSize?normalizeToSize(object,depth-1,maxSize):normalized}function visit(key,value,depth=1/0,maxProperties=1/0,memo=memoBuilder()){const[memoize,unmemoize]=memo;if(null==value||["number","boolean","string"].includes(typeof value)&&!isNaN(value))return value;const stringified=stringifyValue(key,value);if(!stringified.startsWith("[object "))return stringified;if(value.__sentry_skip_normalization__)return value;const remainingDepth="number"==typeof value.__sentry_override_normalization_depth__?value.__sentry_override_normalization_depth__:depth;if(0===remainingDepth)return stringified.replace("object ","");if(memoize(value))return"[Circular ~]";const valueWithToJSON=value;if(valueWithToJSON&&"function"==typeof valueWithToJSON.toJSON)try{return visit("",valueWithToJSON.toJSON(),remainingDepth-1,maxProperties,memo)}catch(err){}const normalized=Array.isArray(value)?[]:{};let numAdded=0;const visitable=convertToPlainObject(value);for(const visitKey in visitable){if(!Object.prototype.hasOwnProperty.call(visitable,visitKey))continue;if(numAdded>=maxProperties){normalized[visitKey]="[MaxProperties ~]";break}const visitValue=visitable[visitKey];normalized[visitKey]=visit(visitKey,visitValue,remainingDepth-1,maxProperties,memo),numAdded++}return unmemoize(value),normalized}function stringifyValue(key,value){try{if("domain"===key&&value&&"object"==typeof value&&value._events)return"[Domain]";if("domainEmitter"===key)return"[DomainEmitter]";if("undefined"!=typeof global&&value===global)return"[Global]";if("undefined"!=typeof window&&value===window)return"[Window]";if("undefined"!=typeof document&&value===document)return"[Document]";if(isVueViewModel(value))return"[VueViewModel]";if(isSyntheticEvent(value))return"[SyntheticEvent]";if("number"==typeof value&&value!=value)return"[NaN]";if("function"==typeof value)return`[Function: ${getFunctionName(value)}]`;if("symbol"==typeof value)return`[${String(value)}]`;if("bigint"==typeof value)return`[BigInt: ${String(value)}]`;const objName=getConstructorName(value);return/^HTML(\w*)Element$/.test(objName)?`[HTMLElement: ${objName}]`:`[object ${objName}]`}catch(err){return`**non-serializable** (${err})`}}function getConstructorName(value){const prototype=Object.getPrototypeOf(value);return prototype?prototype.constructor.name:"null prototype"}function utf8Length(value){return~-encodeURI(value).split(/%..|./).length}function jsonSize(value){return utf8Length(JSON.stringify(value))}export{normalize,normalizeToSize,visit as walk};