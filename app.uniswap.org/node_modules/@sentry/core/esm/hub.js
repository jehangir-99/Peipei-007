import{uuid4,dateTimestampInSeconds,consoleSandbox,logger,GLOBAL_OBJ,getGlobalSingleton}from"@sentry/utils";import{DEFAULT_ENVIRONMENT}from"./constants.js";import{Scope}from"./scope.js";import{closeSession,makeSession,updateSession}from"./session.js";const API_VERSION=4,DEFAULT_BREADCRUMBS=100;class Hub{constructor(client,scope=new Scope,_version=API_VERSION){this._version=_version,this._stack=[{scope:scope}],client&&this.bindClient(client)}isOlderThan(version){return this._version<version}bindClient(client){this.getStackTop().client=client,client&&client.setupIntegrations&&client.setupIntegrations()}pushScope(){const scope=Scope.clone(this.getScope());return this.getStack().push({client:this.getClient(),scope:scope}),scope}popScope(){return!(this.getStack().length<=1)&&!!this.getStack().pop()}withScope(callback){const scope=this.pushScope();try{callback(scope)}finally{this.popScope()}}getClient(){return this.getStackTop().client}getScope(){return this.getStackTop().scope}getStack(){return this._stack}getStackTop(){return this._stack[this._stack.length-1]}captureException(exception,hint){const eventId=this._lastEventId=hint&&hint.event_id?hint.event_id:uuid4(),syntheticException=new Error("Sentry syntheticException");return this._withClient(((client,scope)=>{client.captureException(exception,{originalException:exception,syntheticException:syntheticException,...hint,event_id:eventId},scope)})),eventId}captureMessage(message,level,hint){const eventId=this._lastEventId=hint&&hint.event_id?hint.event_id:uuid4(),syntheticException=new Error(message);return this._withClient(((client,scope)=>{client.captureMessage(message,level,{originalException:message,syntheticException:syntheticException,...hint,event_id:eventId},scope)})),eventId}captureEvent(event,hint){const eventId=hint&&hint.event_id?hint.event_id:uuid4();return event.type||(this._lastEventId=eventId),this._withClient(((client,scope)=>{client.captureEvent(event,{...hint,event_id:eventId},scope)})),eventId}lastEventId(){return this._lastEventId}addBreadcrumb(breadcrumb,hint){const{scope:scope,client:client}=this.getStackTop();if(!client)return;const{beforeBreadcrumb:beforeBreadcrumb=null,maxBreadcrumbs:maxBreadcrumbs=DEFAULT_BREADCRUMBS}=client.getOptions&&client.getOptions()||{};if(maxBreadcrumbs<=0)return;const mergedBreadcrumb={timestamp:dateTimestampInSeconds(),...breadcrumb},finalBreadcrumb=beforeBreadcrumb?consoleSandbox((()=>beforeBreadcrumb(mergedBreadcrumb,hint))):mergedBreadcrumb;null!==finalBreadcrumb&&(client.emit&&client.emit("beforeAddBreadcrumb",finalBreadcrumb,hint),scope.addBreadcrumb(finalBreadcrumb,maxBreadcrumbs))}setUser(user){this.getScope().setUser(user)}setTags(tags){this.getScope().setTags(tags)}setExtras(extras){this.getScope().setExtras(extras)}setTag(key,value){this.getScope().setTag(key,value)}setExtra(key,extra){this.getScope().setExtra(key,extra)}setContext(name,context){this.getScope().setContext(name,context)}configureScope(callback){const{scope:scope,client:client}=this.getStackTop();client&&callback(scope)}run(callback){const oldHub=makeMain(this);try{callback(this)}finally{makeMain(oldHub)}}getIntegration(integration){const client=this.getClient();if(!client)return null;try{return client.getIntegration(integration)}catch(_oO){return("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.warn(`Cannot retrieve integration ${integration.id} from the current Hub`),null}}startTransaction(context,customSamplingContext){const result=this._callExtensionMethod("startTransaction",context,customSamplingContext);if(("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&!result){this.getClient()?console.warn("Tracing extension 'startTransaction' has not been added. Call 'addTracingExtensions' before calling 'init':\nSentry.addTracingExtensions();\nSentry.init({...});\n"):console.warn("Tracing extension 'startTransaction' is missing. You should 'init' the SDK before calling 'startTransaction'")}return result}traceHeaders(){return this._callExtensionMethod("traceHeaders")}captureSession(endSession=!1){if(endSession)return this.endSession();this._sendSessionUpdate()}endSession(){const scope=this.getStackTop().scope,session=scope.getSession();session&&closeSession(session),this._sendSessionUpdate(),scope.setSession()}startSession(context){const{scope:scope,client:client}=this.getStackTop(),{release:release,environment:environment=DEFAULT_ENVIRONMENT}=client&&client.getOptions()||{},{userAgent:userAgent}=GLOBAL_OBJ.navigator||{},session=makeSession({release:release,environment:environment,user:scope.getUser(),...userAgent&&{userAgent:userAgent},...context}),currentSession=scope.getSession&&scope.getSession();return currentSession&&"ok"===currentSession.status&&updateSession(currentSession,{status:"exited"}),this.endSession(),scope.setSession(session),session}shouldSendDefaultPii(){const client=this.getClient(),options=client&&client.getOptions();return Boolean(options&&options.sendDefaultPii)}_sendSessionUpdate(){const{scope:scope,client:client}=this.getStackTop(),session=scope.getSession();session&&client&&client.captureSession&&client.captureSession(session)}_withClient(callback){const{scope:scope,client:client}=this.getStackTop();client&&callback(client,scope)}_callExtensionMethod(method,...args){const sentry=getMainCarrier().__SENTRY__;if(sentry&&sentry.extensions&&"function"==typeof sentry.extensions[method])return sentry.extensions[method].apply(this,args);("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.warn(`Extension method ${method} couldn't be found, doing nothing.`)}}function getMainCarrier(){return GLOBAL_OBJ.__SENTRY__=GLOBAL_OBJ.__SENTRY__||{extensions:{},hub:void 0},GLOBAL_OBJ}function makeMain(hub){const registry=getMainCarrier(),oldHub=getHubFromCarrier(registry);return setHubOnCarrier(registry,hub),oldHub}function getCurrentHub(){const registry=getMainCarrier();if(registry.__SENTRY__&&registry.__SENTRY__.acs){const hub=registry.__SENTRY__.acs.getCurrentHub();if(hub)return hub}return getGlobalHub(registry)}function getGlobalHub(registry=getMainCarrier()){return hasHubOnCarrier(registry)&&!getHubFromCarrier(registry).isOlderThan(API_VERSION)||setHubOnCarrier(registry,new Hub),getHubFromCarrier(registry)}function ensureHubOnCarrier(carrier,parent=getGlobalHub()){if(!hasHubOnCarrier(carrier)||getHubFromCarrier(carrier).isOlderThan(API_VERSION)){const globalHubTopStack=parent.getStackTop();setHubOnCarrier(carrier,new Hub(globalHubTopStack.client,Scope.clone(globalHubTopStack.scope)))}}function setAsyncContextStrategy(strategy){const registry=getMainCarrier();registry.__SENTRY__=registry.__SENTRY__||{},registry.__SENTRY__.acs=strategy}function runWithAsyncContext(callback,options={}){const registry=getMainCarrier();return registry.__SENTRY__&&registry.__SENTRY__.acs?registry.__SENTRY__.acs.runWithAsyncContext(callback,options):callback()}function hasHubOnCarrier(carrier){return!!(carrier&&carrier.__SENTRY__&&carrier.__SENTRY__.hub)}function getHubFromCarrier(carrier){return getGlobalSingleton("hub",(()=>new Hub),carrier)}function setHubOnCarrier(carrier,hub){if(!carrier)return!1;return(carrier.__SENTRY__=carrier.__SENTRY__||{}).hub=hub,!0}export{API_VERSION,Hub,ensureHubOnCarrier,getCurrentHub,getHubFromCarrier,getMainCarrier,makeMain,runWithAsyncContext,setAsyncContextStrategy,setHubOnCarrier};