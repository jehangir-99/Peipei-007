import{makePromiseBuffer,forEachEnvelopeItem,envelopeItemTypeToDataCategory,isRateLimited,resolvedSyncPromise,createEnvelope,SentryError,logger,serializeEnvelope,updateRateLimits}from"@sentry/utils";const DEFAULT_TRANSPORT_BUFFER_SIZE=30;function createTransport(options,makeRequest,buffer=makePromiseBuffer(options.bufferSize||30)){let rateLimits={};function send(envelope){const filteredEnvelopeItems=[];if(forEachEnvelopeItem(envelope,((item,type)=>{const envelopeItemDataCategory=envelopeItemTypeToDataCategory(type);if(isRateLimited(rateLimits,envelopeItemDataCategory)){const event=getEventForEnvelopeItem(item,type);options.recordDroppedEvent("ratelimit_backoff",envelopeItemDataCategory,event)}else filteredEnvelopeItems.push(item)})),0===filteredEnvelopeItems.length)return resolvedSyncPromise();const filteredEnvelope=createEnvelope(envelope[0],filteredEnvelopeItems),recordEnvelopeLoss=reason=>{forEachEnvelopeItem(filteredEnvelope,((item,type)=>{const event=getEventForEnvelopeItem(item,type);options.recordDroppedEvent(reason,envelopeItemTypeToDataCategory(type),event)}))};return buffer.add((()=>makeRequest({body:serializeEnvelope(filteredEnvelope,options.textEncoder)}).then((response=>(void 0!==response.statusCode&&(response.statusCode<200||response.statusCode>=300)&&("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.warn(`Sentry responded with status code ${response.statusCode} to sent event.`),rateLimits=updateRateLimits(rateLimits,response),response)),(error=>{throw recordEnvelopeLoss("network_error"),error})))).then((result=>result),(error=>{if(error instanceof SentryError)return("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.error("Skipped sending event because buffer is full."),recordEnvelopeLoss("queue_overflow"),resolvedSyncPromise();throw error}))}return send.__sentry__baseTransport__=!0,{send:send,flush:timeout=>buffer.drain(timeout)}}function getEventForEnvelopeItem(item,type){if("event"===type||"transaction"===type)return Array.isArray(item)?item[1]:void 0}export{DEFAULT_TRANSPORT_BUFFER_SIZE,createTransport};