import{__awaiter,__generator,__read,__rest,__spreadArray}from"tslib";import{PluginType,Status}from"@amplitude/analytics-types";import{INVALID_API_KEY,MAX_RETRIES_EXCEEDED_MESSAGE,MISSING_API_KEY_MESSAGE,SUCCESS_MESSAGE,UNEXPECTED_ERROR_MESSAGE}from"../messages";import{STORAGE_PREFIX}from"../constants";import{chunk}from"../utils/chunk";import{buildResult}from"../utils/result-builder";import{createServerConfig}from"../config";function getErrorMessage(error){return error instanceof Error?error.message:String(error)}export function getResponseBodyString(res){var responseBodyString="";try{"body"in res&&(responseBodyString=JSON.stringify(res.body))}catch(_a){}return responseBodyString}var Destination=function(){function Destination(){this.name="amplitude",this.type=PluginType.DESTINATION,this.retryTimeout=1e3,this.throttleTimeout=3e4,this.storageKey="",this.scheduled=null,this.queue=[]}return Destination.prototype.setup=function(config){var _a;return __awaiter(this,void 0,void 0,(function(){var unsent,_this=this;return __generator(this,(function(_b){switch(_b.label){case 0:return this.config=config,this.storageKey="".concat(STORAGE_PREFIX,"_").concat(this.config.apiKey.substring(0,10)),[4,null===(_a=this.config.storageProvider)||void 0===_a?void 0:_a.get(this.storageKey)];case 1:return unsent=_b.sent(),this.saveEvents(),unsent&&unsent.length>0&&Promise.all(unsent.map((function(event){return _this.execute(event)}))).catch(),[2,Promise.resolve(void 0)]}}))}))},Destination.prototype.execute=function(event){var _this=this;return new Promise((function(resolve){var context={event:event,attempts:0,callback:function(result){return resolve(result)},timeout:0};_this.addToQueue(context)}))},Destination.prototype.addToQueue=function(){for(var _this=this,list=[],_i=0;_i<arguments.length;_i++)list[_i]=arguments[_i];list.filter((function(context){return context.attempts<_this.config.flushMaxRetries?(context.attempts+=1,!0):(_this.fulfillRequest([context],500,MAX_RETRIES_EXCEEDED_MESSAGE),!1)})).forEach((function(context){_this.queue=_this.queue.concat(context),0!==context.timeout?setTimeout((function(){context.timeout=0,_this.schedule(0)}),context.timeout):_this.schedule(_this.config.flushIntervalMillis)})),this.saveEvents()},Destination.prototype.schedule=function(timeout){var _this=this;this.scheduled||(this.scheduled=setTimeout((function(){_this.flush(!0).then((function(){_this.queue.length>0&&_this.schedule(timeout)}))}),timeout))},Destination.prototype.flush=function(useRetry){return void 0===useRetry&&(useRetry=!1),__awaiter(this,void 0,void 0,(function(){var list,later,batches,_this=this;return __generator(this,(function(_a){switch(_a.label){case 0:return list=[],later=[],this.queue.forEach((function(context){return 0===context.timeout?list.push(context):later.push(context)})),this.queue=later,this.scheduled&&(clearTimeout(this.scheduled),this.scheduled=null),batches=chunk(list,this.config.flushQueueSize),[4,Promise.all(batches.map((function(batch){return _this.send(batch,useRetry)})))];case 1:return _a.sent(),[2]}}))}))},Destination.prototype.send=function(list,useRetry){return void 0===useRetry&&(useRetry=!0),__awaiter(this,void 0,void 0,(function(){var payload,serverUrl,res,e_1,errorMessage;return __generator(this,(function(_a){switch(_a.label){case 0:if(!this.config.apiKey)return[2,this.fulfillRequest(list,400,MISSING_API_KEY_MESSAGE)];payload={api_key:this.config.apiKey,events:list.map((function(context){var _a=context.event;_a.extra;return __rest(_a,["extra"])})),options:{min_id_length:this.config.minIdLength}},_a.label=1;case 1:return _a.trys.push([1,3,,4]),serverUrl=createServerConfig(this.config.serverUrl,this.config.serverZone,this.config.useBatch).serverUrl,[4,this.config.transportProvider.send(serverUrl,payload)];case 2:return null===(res=_a.sent())?(this.fulfillRequest(list,0,UNEXPECTED_ERROR_MESSAGE),[2]):useRetry?(this.handleResponse(res,list),[3,4]):("body"in res?this.fulfillRequest(list,res.statusCode,"".concat(res.status,": ").concat(getResponseBodyString(res))):this.fulfillRequest(list,res.statusCode,res.status),[2]);case 3:return e_1=_a.sent(),errorMessage=getErrorMessage(e_1),this.config.loggerProvider.error(errorMessage),this.fulfillRequest(list,0,errorMessage),[3,4];case 4:return[2]}}))}))},Destination.prototype.handleResponse=function(res,list){var status=res.status;switch(status){case Status.Success:this.handleSuccessResponse(res,list);break;case Status.Invalid:this.handleInvalidResponse(res,list);break;case Status.PayloadTooLarge:this.handlePayloadTooLargeResponse(res,list);break;case Status.RateLimit:this.handleRateLimitResponse(res,list);break;default:this.config.loggerProvider.warn("{code: 0, error: \"Status '".concat(status,"' provided for ").concat(list.length,' events"}')),this.handleOtherResponse(list)}},Destination.prototype.handleSuccessResponse=function(res,list){this.fulfillRequest(list,res.statusCode,SUCCESS_MESSAGE)},Destination.prototype.handleInvalidResponse=function(res,list){var _this=this;if(res.body.missingField||res.body.error.startsWith(INVALID_API_KEY))this.fulfillRequest(list,res.statusCode,res.body.error);else{var dropIndex=__spreadArray(__spreadArray(__spreadArray(__spreadArray([],__read(Object.values(res.body.eventsWithInvalidFields)),!1),__read(Object.values(res.body.eventsWithMissingFields)),!1),__read(Object.values(res.body.eventsWithInvalidIdLengths)),!1),__read(res.body.silencedEvents),!1).flat(),dropIndexSet=new Set(dropIndex),retry=list.filter((function(context,index){if(!dropIndexSet.has(index))return!0;_this.fulfillRequest([context],res.statusCode,res.body.error)}));retry.length>0&&this.config.loggerProvider.warn(getResponseBodyString(res)),this.addToQueue.apply(this,__spreadArray([],__read(retry),!1))}},Destination.prototype.handlePayloadTooLargeResponse=function(res,list){1!==list.length?(this.config.loggerProvider.warn(getResponseBodyString(res)),this.config.flushQueueSize/=2,this.addToQueue.apply(this,__spreadArray([],__read(list),!1))):this.fulfillRequest(list,res.statusCode,res.body.error)},Destination.prototype.handleRateLimitResponse=function(res,list){var _this=this,dropUserIds=Object.keys(res.body.exceededDailyQuotaUsers),dropDeviceIds=Object.keys(res.body.exceededDailyQuotaDevices),throttledIndex=res.body.throttledEvents,dropUserIdsSet=new Set(dropUserIds),dropDeviceIdsSet=new Set(dropDeviceIds),throttledIndexSet=new Set(throttledIndex),retry=list.filter((function(context,index){if(!(context.event.user_id&&dropUserIdsSet.has(context.event.user_id)||context.event.device_id&&dropDeviceIdsSet.has(context.event.device_id)))return throttledIndexSet.has(index)&&(context.timeout=_this.throttleTimeout),!0;_this.fulfillRequest([context],res.statusCode,res.body.error)}));retry.length>0&&this.config.loggerProvider.warn(getResponseBodyString(res)),this.addToQueue.apply(this,__spreadArray([],__read(retry),!1))},Destination.prototype.handleOtherResponse=function(list){var _this=this;this.addToQueue.apply(this,__spreadArray([],__read(list.map((function(context){return context.timeout=context.attempts*_this.retryTimeout,context}))),!1))},Destination.prototype.fulfillRequest=function(list,code,message){this.saveEvents(),list.forEach((function(context){return context.callback(buildResult(context.event,code,message))}))},Destination.prototype.saveEvents=function(){if(this.config.storageProvider){var events=Array.from(this.queue.map((function(context){return context.event})));this.config.storageProvider.set(this.storageKey,events)}},Destination}();export{Destination};