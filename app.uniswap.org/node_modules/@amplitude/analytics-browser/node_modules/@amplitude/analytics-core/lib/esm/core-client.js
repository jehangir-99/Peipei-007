import{__awaiter,__generator,__values}from"tslib";import{createGroupIdentifyEvent,createIdentifyEvent,createTrackEvent,createRevenueEvent,createGroupEvent}from"./utils/event-builder";import{Timeline}from"./timeline";import{buildResult}from"./utils/result-builder";import{CLIENT_NOT_INITIALIZED,OPT_OUT_MESSAGE}from"./messages";import{returnWrapper}from"./utils/return-wrapper";var AmplitudeCore=function(){function AmplitudeCore(name){void 0===name&&(name="$default"),this.initializing=!1,this.q=[],this.dispatchQ=[],this.logEvent=this.track.bind(this),this.timeline=new Timeline(this),this.name=name}return AmplitudeCore.prototype._init=function(config){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return this.config=config,this.timeline.reset(this),[4,this.runQueuedFunctions("q")];case 1:return _a.sent(),[2]}}))}))},AmplitudeCore.prototype.runQueuedFunctions=function(queueName){return __awaiter(this,void 0,void 0,(function(){var queuedFunctions,queuedFunctions_1,queuedFunctions_1_1,e_1_1,e_1,_a;return __generator(this,(function(_b){switch(_b.label){case 0:queuedFunctions=this[queueName],this[queueName]=[],_b.label=1;case 1:_b.trys.push([1,6,7,8]),queuedFunctions_1=__values(queuedFunctions),queuedFunctions_1_1=queuedFunctions_1.next(),_b.label=2;case 2:return queuedFunctions_1_1.done?[3,5]:[4,(0,queuedFunctions_1_1.value)()];case 3:_b.sent(),_b.label=4;case 4:return queuedFunctions_1_1=queuedFunctions_1.next(),[3,2];case 5:return[3,8];case 6:return e_1_1=_b.sent(),e_1={error:e_1_1},[3,8];case 7:try{queuedFunctions_1_1&&!queuedFunctions_1_1.done&&(_a=queuedFunctions_1.return)&&_a.call(queuedFunctions_1)}finally{if(e_1)throw e_1.error}return[7];case 8:return[2]}}))}))},AmplitudeCore.prototype.track=function(eventInput,eventProperties,eventOptions){var event=createTrackEvent(eventInput,eventProperties,eventOptions);return returnWrapper(this.dispatch(event))},AmplitudeCore.prototype.identify=function(identify,eventOptions){var event=createIdentifyEvent(identify,eventOptions);return returnWrapper(this.dispatch(event))},AmplitudeCore.prototype.groupIdentify=function(groupType,groupName,identify,eventOptions){var event=createGroupIdentifyEvent(groupType,groupName,identify,eventOptions);return returnWrapper(this.dispatch(event))},AmplitudeCore.prototype.setGroup=function(groupType,groupName,eventOptions){var event=createGroupEvent(groupType,groupName,eventOptions);return returnWrapper(this.dispatch(event))},AmplitudeCore.prototype.revenue=function(revenue,eventOptions){var event=createRevenueEvent(revenue,eventOptions);return returnWrapper(this.dispatch(event))},AmplitudeCore.prototype.add=function(plugin){return this.config?returnWrapper(this.timeline.register(plugin,this.config)):(this.q.push(this.add.bind(this,plugin)),returnWrapper())},AmplitudeCore.prototype.remove=function(pluginName){return this.config?returnWrapper(this.timeline.deregister(pluginName)):(this.q.push(this.remove.bind(this,pluginName)),returnWrapper())},AmplitudeCore.prototype.dispatchWithCallback=function(event,callback){if(!this.config)return callback(buildResult(event,0,CLIENT_NOT_INITIALIZED));this.process(event).then(callback)},AmplitudeCore.prototype.dispatch=function(event){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return this.config?[2,this.process(event)]:[2,new Promise((function(resolve){_this.dispatchQ.push(_this.dispatchWithCallback.bind(_this,event,resolve))}))]}))}))},AmplitudeCore.prototype.process=function(event){return __awaiter(this,void 0,void 0,(function(){var e_2,message,result;return __generator(this,(function(_a){switch(_a.label){case 0:return _a.trys.push([0,2,,3]),this.config.optOut?[2,buildResult(event,0,OPT_OUT_MESSAGE)]:[4,this.timeline.push(event)];case 1:return 200===(result=_a.sent()).code?this.config.loggerProvider.log(result.message):this.config.loggerProvider.error(result.message),[2,result];case 2:return e_2=_a.sent(),message=String(e_2),this.config.loggerProvider.error(message),[2,result=buildResult(event,0,message)];case 3:return[2]}}))}))},AmplitudeCore.prototype.setOptOut=function(optOut){this.config?this.config.optOut=Boolean(optOut):this.q.push(this.setOptOut.bind(this,Boolean(optOut)))},AmplitudeCore.prototype.flush=function(){return returnWrapper(this.timeline.flush())},AmplitudeCore}();export{AmplitudeCore};