import{__awaiter,__generator}from"tslib";import{PluginType}from"@amplitude/analytics-types";import{DEFAULT_FILE_DOWNLOAD_EVENT,FILE_EXTENSION,FILE_NAME,LINK_ID,LINK_TEXT,LINK_URL}from"../constants";export var fileDownloadTracking=function(){var observer,eventListeners=[];return{name:"@amplitude/plugin-file-download-tracking-browser",type:PluginType.ENRICHMENT,setup:function(config,amplitude){return __awaiter(void 0,void 0,void 0,(function(){var addFileDownloadListener,ext;return __generator(this,(function(_a){return amplitude?("undefined"==typeof document||(addFileDownloadListener=function(a){var url;try{url=new URL(a.href,window.location.href)}catch(_a){return}var result=ext.exec(url.href),fileExtension=null==result?void 0:result[1];fileExtension&&function(element,type,handler){element.addEventListener(type,handler),eventListeners.push({element:element,type:type,handler:handler})}(a,"click",(function(){var _a;fileExtension&&amplitude.track(DEFAULT_FILE_DOWNLOAD_EVENT,((_a={})[FILE_EXTENSION]=fileExtension,_a[FILE_NAME]=url.pathname,_a[LINK_ID]=a.id,_a[LINK_TEXT]=a.text,_a[LINK_URL]=a.href,_a))}))},ext=/\.(pdf|xlsx?|docx?|txt|rtf|csv|exe|key|pp(s|t|tx)|7z|pkg|rar|gz|zip|avi|mov|mp4|mpe?g|wmv|midi?|mp3|wav|wma)$/,Array.from(document.getElementsByTagName("a")).forEach(addFileDownloadListener),"undefined"!=typeof MutationObserver&&(observer=new MutationObserver((function(mutations){mutations.forEach((function(mutation){mutation.addedNodes.forEach((function(node){"A"===node.nodeName&&addFileDownloadListener(node),"querySelectorAll"in node&&"function"==typeof node.querySelectorAll&&Array.from(node.querySelectorAll("a")).map(addFileDownloadListener)}))}))}))).observe(document.body,{subtree:!0,childList:!0})),[2]):(config.loggerProvider.warn("File download tracking requires a later version of @amplitude/analytics-browser. File download events are not tracked."),[2])}))}))},execute:function(event){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,event]}))}))},teardown:function(){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(_a){return null==observer||observer.disconnect(),eventListeners.forEach((function(_a){var element=_a.element,type=_a.type,handler=_a.handler;null==element||element.removeEventListener(type,handler)})),eventListeners=[],[2]}))}))}}};