import{__assign,__awaiter,__extends,__generator,__values}from"tslib";import{TransportType}from"@amplitude/analytics-types";import{Config,MemoryStorage,UUID}from"@amplitude/analytics-core";import{CookieStorage,getCookieName,FetchTransport}from"@amplitude/analytics-client-common";import{LocalStorage}from"./storage/local-storage";import{XHRTransport}from"./transports/xhr";import{SendBeaconTransport}from"./transports/send-beacon";export var getDefaultConfig=function(){return{cookieExpiration:365,cookieSameSite:"Lax",cookieSecure:!1,cookieStorage:new MemoryStorage,cookieUpgrade:!0,disableCookies:!1,domain:"",sessionTimeout:18e5,trackingOptions:{deviceManufacturer:!0,deviceModel:!0,ipAddress:!0,language:!0,osName:!0,osVersion:!0,platform:!0},transportProvider:new FetchTransport}};var BrowserConfig=function(_super){function BrowserConfig(apiKey,options){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_this=this,defaultConfig=getDefaultConfig();return(_this=_super.call(this,__assign(__assign({flushIntervalMillis:1e3,flushMaxRetries:5,flushQueueSize:30,transportProvider:defaultConfig.transportProvider},options),{apiKey:apiKey}))||this)._optOut=!1,_this.cookieStorage=null!==(_a=null==options?void 0:options.cookieStorage)&&void 0!==_a?_a:defaultConfig.cookieStorage,_this.deviceId=null==options?void 0:options.deviceId,_this.lastEventId=null==options?void 0:options.lastEventId,_this.lastEventTime=null==options?void 0:options.lastEventTime,_this.optOut=Boolean(null==options?void 0:options.optOut),_this.sessionId=null==options?void 0:options.sessionId,_this.userId=null==options?void 0:options.userId,_this.appVersion=null==options?void 0:options.appVersion,_this.attribution=null==options?void 0:options.attribution,_this.cookieExpiration=null!==(_b=null==options?void 0:options.cookieExpiration)&&void 0!==_b?_b:defaultConfig.cookieExpiration,_this.cookieSameSite=null!==(_c=null==options?void 0:options.cookieSameSite)&&void 0!==_c?_c:defaultConfig.cookieSameSite,_this.cookieSecure=null!==(_d=null==options?void 0:options.cookieSecure)&&void 0!==_d?_d:defaultConfig.cookieSecure,_this.cookieUpgrade=null!==(_e=null==options?void 0:options.cookieUpgrade)&&void 0!==_e?_e:defaultConfig.cookieUpgrade,_this.defaultTracking=null==options?void 0:options.defaultTracking,_this.disableCookies=null!==(_f=null==options?void 0:options.disableCookies)&&void 0!==_f?_f:defaultConfig.disableCookies,_this.defaultTracking=null==options?void 0:options.defaultTracking,_this.domain=null!==(_g=null==options?void 0:options.domain)&&void 0!==_g?_g:defaultConfig.domain,_this.partnerId=null==options?void 0:options.partnerId,_this.sessionTimeout=null!==(_h=null==options?void 0:options.sessionTimeout)&&void 0!==_h?_h:defaultConfig.sessionTimeout,_this.trackingOptions=null!==(_j=null==options?void 0:options.trackingOptions)&&void 0!==_j?_j:defaultConfig.trackingOptions,_this}return __extends(BrowserConfig,_super),Object.defineProperty(BrowserConfig.prototype,"deviceId",{get:function(){return this._deviceId},set:function(deviceId){this._deviceId!==deviceId&&(this._deviceId=deviceId,this.updateStorage())},enumerable:!1,configurable:!0}),Object.defineProperty(BrowserConfig.prototype,"userId",{get:function(){return this._userId},set:function(userId){this._userId!==userId&&(this._userId=userId,this.updateStorage())},enumerable:!1,configurable:!0}),Object.defineProperty(BrowserConfig.prototype,"sessionId",{get:function(){return this._sessionId},set:function(sessionId){this._sessionId!==sessionId&&(this._sessionId=sessionId,this.updateStorage())},enumerable:!1,configurable:!0}),Object.defineProperty(BrowserConfig.prototype,"optOut",{get:function(){return this._optOut},set:function(optOut){this._optOut!==optOut&&(this._optOut=optOut,this.updateStorage())},enumerable:!1,configurable:!0}),Object.defineProperty(BrowserConfig.prototype,"lastEventTime",{get:function(){return this._lastEventTime},set:function(lastEventTime){this._lastEventTime!==lastEventTime&&(this._lastEventTime=lastEventTime,this.updateStorage())},enumerable:!1,configurable:!0}),Object.defineProperty(BrowserConfig.prototype,"lastEventId",{get:function(){return this._lastEventId},set:function(lastEventId){this._lastEventId!==lastEventId&&(this._lastEventId=lastEventId,this.updateStorage())},enumerable:!1,configurable:!0}),BrowserConfig.prototype.updateStorage=function(){var _a,cache={deviceId:this._deviceId,userId:this._userId,sessionId:this._sessionId,optOut:this._optOut,lastEventTime:this._lastEventTime,lastEventId:this._lastEventId};null===(_a=this.cookieStorage)||void 0===_a||_a.set(getCookieName(this.apiKey),cache)},BrowserConfig}(Config);export{BrowserConfig};export var useBrowserConfig=function(apiKey,options){return __awaiter(void 0,void 0,void 0,(function(){var defaultConfig,deviceId,lastEventId,lastEventTime,optOut,sessionId,userId,cookieStorage,domain,_a,_b,_c,_d,_e,_f;return __generator(this,(function(_g){switch(_g.label){case 0:return defaultConfig=getDefaultConfig(),deviceId=null!==(_e=null==options?void 0:options.deviceId)&&void 0!==_e?_e:UUID(),lastEventId=null==options?void 0:options.lastEventId,lastEventTime=null==options?void 0:options.lastEventTime,optOut=null==options?void 0:options.optOut,sessionId=null==options?void 0:options.sessionId,userId=null==options?void 0:options.userId,cookieStorage=null==options?void 0:options.cookieStorage,domain=null==options?void 0:options.domain,_a=BrowserConfig.bind,_b=[void 0,apiKey],_c=[__assign({},options)],_d={cookieStorage:cookieStorage,deviceId:deviceId,domain:domain,lastEventId:lastEventId,lastEventTime:lastEventTime,optOut:optOut,sessionId:sessionId},[4,createEventsStorage(options)];case 1:return[2,new(_a.apply(BrowserConfig,_b.concat([__assign.apply(void 0,_c.concat([(_d.storageProvider=_g.sent(),_d.trackingOptions=__assign(__assign({},defaultConfig.trackingOptions),null==options?void 0:options.trackingOptions),_d.transportProvider=null!==(_f=null==options?void 0:options.transportProvider)&&void 0!==_f?_f:createTransport(null==options?void 0:options.transport),_d.userId=userId,_d)]))])))]}}))}))};export var createCookieStorage=function(overrides,baseConfig){return void 0===baseConfig&&(baseConfig=getDefaultConfig()),__awaiter(void 0,void 0,void 0,(function(){var options,cookieStorage,_a;return __generator(this,(function(_b){switch(_b.label){case 0:return options=__assign(__assign({},baseConfig),overrides),cookieStorage=null==overrides?void 0:overrides.cookieStorage,(_a=!cookieStorage)?[3,2]:[4,cookieStorage.isEnabled()];case 1:_a=!_b.sent(),_b.label=2;case 2:return _a?[2,createFlexibleStorage(options)]:[2,cookieStorage]}}))}))};var createFlexibleStorage=function(options){return __awaiter(void 0,void 0,void 0,(function(){var storage,_a;return __generator(this,(function(_b){switch(_b.label){case 0:return storage=new CookieStorage({domain:options.domain,expirationDays:options.cookieExpiration,sameSite:options.cookieSameSite,secure:options.cookieSecure}),(_a=options.disableCookies)?[3,2]:[4,storage.isEnabled()];case 1:_a=!_b.sent(),_b.label=2;case 2:return _a?[4,(storage=new LocalStorage).isEnabled()]:[3,4];case 3:_b.sent()||(storage=new MemoryStorage),_b.label=4;case 4:return[2,storage]}}))}))};export var createEventsStorage=function(overrides){return __awaiter(void 0,void 0,void 0,(function(){var _a,_b,storage,_c,e_1_1,e_1,_d;return __generator(this,(function(_e){switch(_e.label){case 0:if(overrides&&Object.prototype.hasOwnProperty.call(overrides,"storageProvider")&&!overrides.storageProvider)return[3,9];_e.label=1;case 1:_e.trys.push([1,7,8,9]),_a=__values([null==overrides?void 0:overrides.storageProvider,new LocalStorage]),_b=_a.next(),_e.label=2;case 2:return _b.done?[3,6]:(storage=_b.value,(_c=storage)?[4,storage.isEnabled()]:[3,4]);case 3:_c=_e.sent(),_e.label=4;case 4:if(_c)return[2,storage];_e.label=5;case 5:return _b=_a.next(),[3,2];case 6:return[3,9];case 7:return e_1_1=_e.sent(),e_1={error:e_1_1},[3,9];case 8:try{_b&&!_b.done&&(_d=_a.return)&&_d.call(_a)}finally{if(e_1)throw e_1.error}return[7];case 9:return[2,void 0]}}))}))};export var createTransport=function(transport){return transport===TransportType.XHR?new XHRTransport:transport===TransportType.SendBeacon?new SendBeaconTransport:getDefaultConfig().transportProvider};export var getTopLevelDomain=function(url){return __awaiter(void 0,void 0,void 0,(function(){var host,parts,levels,storageKey,i,domain,storage;return __generator(this,(function(_a){switch(_a.label){case 0:return[4,(new CookieStorage).isEnabled()];case 1:if(!_a.sent()||!url&&"undefined"==typeof location)return[2,""];for(host=null!=url?url:location.hostname,parts=host.split("."),levels=[],storageKey="AMP_TLDTEST",i=parts.length-2;i>=0;--i)levels.push(parts.slice(i).join("."));i=0,_a.label=2;case 2:return i<levels.length?(domain=levels[i],[4,(storage=new CookieStorage({domain:"."+domain})).set(storageKey,1)]):[3,7];case 3:return _a.sent(),[4,storage.get(storageKey)];case 4:return _a.sent()?[4,storage.remove(storageKey)]:[3,6];case 5:return _a.sent(),[2,"."+domain];case 6:return i++,[3,2];case 7:return[2,""]}}))}))};