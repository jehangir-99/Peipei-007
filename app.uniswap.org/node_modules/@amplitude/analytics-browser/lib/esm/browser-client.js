import{__assign,__awaiter,__extends,__generator}from"tslib";import{AmplitudeCore,Destination,Identify,returnWrapper,Revenue,UUID}from"@amplitude/analytics-core";import{getAnalyticsConnector,getPageViewTrackingConfig,IdentityEventSender,isSessionTrackingEnabled,isFileDownloadTrackingEnabled,isFormInteractionTrackingEnabled,getCookieName,getQueryParams,setConnectorDeviceId,setConnectorUserId}from"@amplitude/analytics-client-common";import{convertProxyObjectToRealObject,isInstanceProxy}from"./utils/snippet-helper";import{Context}from"./plugins/context";import{useBrowserConfig,createTransport,getTopLevelDomain,createCookieStorage}from"./config";import{parseLegacyCookies}from"./cookie-migration";import{webAttributionPlugin}from"@amplitude/plugin-web-attribution-browser";import{pageViewTrackingPlugin}from"@amplitude/plugin-page-view-tracking-browser";import{formInteractionTracking}from"./plugins/form-interaction-tracking";import{fileDownloadTracking}from"./plugins/file-download-tracking";import{DEFAULT_PAGE_VIEW_EVENT,DEFAULT_SESSION_END_EVENT,DEFAULT_SESSION_START_EVENT}from"./constants";import{defaultPageViewEventEnrichment}from"./plugins/default-page-view-event-enrichment";var AmplitudeBrowser=function(_super){function AmplitudeBrowser(){return null!==_super&&_super.apply(this,arguments)||this}return __extends(AmplitudeBrowser,_super),AmplitudeBrowser.prototype.init=function(apiKey,userId,options){return void 0===apiKey&&(apiKey=""),returnWrapper(this._init(__assign(__assign({},options),{userId:userId,apiKey:apiKey})))},AmplitudeBrowser.prototype._init=function(options){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l,_m,_o,_p,_r,_s,_t,_u,_v,_w;return __awaiter(this,void 0,void 0,(function(){var _x,_y,_z,legacyCookies,cookieStorage,previousCookies,queryParams,deviceId,sessionId,optOut,lastEventId,lastEventTime,userId,browserOptions,isNewSession,connector,webAttribution,pageViewTrackingOptions,_this=this;return __generator(this,(function(_0){switch(_0.label){case 0:return this.initializing?[2]:(this.initializing=!0,_x=options,options.disableCookies?(_y="",[3,5]):[3,1]);case 1:return null===(_a=options.domain)||void 0===_a?[3,2]:(_z=_a,[3,4]);case 2:return[4,getTopLevelDomain()];case 3:_z=_0.sent(),_0.label=4;case 4:_y=_z,_0.label=5;case 5:return _x.domain=_y,[4,parseLegacyCookies(options.apiKey,options)];case 6:return legacyCookies=_0.sent(),[4,createCookieStorage(options)];case 7:return[4,(cookieStorage=_0.sent()).get(getCookieName(options.apiKey))];case 8:return previousCookies=_0.sent(),queryParams=getQueryParams(),deviceId=null!==(_d=null!==(_c=null!==(_b=options.deviceId)&&void 0!==_b?_b:queryParams.deviceId)&&void 0!==_c?_c:null==previousCookies?void 0:previousCookies.deviceId)&&void 0!==_d?_d:legacyCookies.deviceId,sessionId=null!==(_e=null==previousCookies?void 0:previousCookies.sessionId)&&void 0!==_e?_e:legacyCookies.sessionId,optOut=null!==(_g=null!==(_f=options.optOut)&&void 0!==_f?_f:null==previousCookies?void 0:previousCookies.optOut)&&void 0!==_g?_g:legacyCookies.optOut,lastEventId=null!==(_h=null==previousCookies?void 0:previousCookies.lastEventId)&&void 0!==_h?_h:legacyCookies.lastEventId,lastEventTime=null!==(_j=null==previousCookies?void 0:previousCookies.lastEventTime)&&void 0!==_j?_j:legacyCookies.lastEventTime,userId=null!==(_l=null!==(_k=options.userId)&&void 0!==_k?_k:null==previousCookies?void 0:previousCookies.userId)&&void 0!==_l?_l:legacyCookies.userId,this.previousSessionDeviceId=null!==(_m=null==previousCookies?void 0:previousCookies.deviceId)&&void 0!==_m?_m:legacyCookies.deviceId,this.previousSessionUserId=null!==(_o=null==previousCookies?void 0:previousCookies.userId)&&void 0!==_o?_o:legacyCookies.userId,[4,useBrowserConfig(options.apiKey,__assign(__assign({},options),{deviceId:deviceId,sessionId:sessionId,optOut:optOut,lastEventId:lastEventId,lastEventTime:lastEventTime,userId:userId,cookieStorage:cookieStorage}))];case 9:return browserOptions=_0.sent(),[4,_super.prototype._init.call(this,browserOptions)];case 10:return _0.sent(),isNewSession=!1,(!this.config.lastEventTime||!this.config.sessionId||this.config.lastEventTime&&Date.now()-this.config.lastEventTime>this.config.sessionTimeout)&&(this.setSessionId(null!==(_r=null!==(_p=options.sessionId)&&void 0!==_p?_p:this.config.sessionId)&&void 0!==_r?_r:Date.now()),isNewSession=!0),(connector=getAnalyticsConnector(options.instanceName)).identityStore.setIdentity({userId:this.config.userId,deviceId:this.config.deviceId}),[4,this.add(new Destination).promise];case 11:return _0.sent(),[4,this.add(new Context).promise];case 12:return _0.sent(),[4,this.add(new IdentityEventSender).promise];case 13:return _0.sent(),isFileDownloadTrackingEnabled(this.config.defaultTracking)?[4,this.add(fileDownloadTracking()).promise]:[3,15];case 14:_0.sent(),_0.label=15;case 15:return isFormInteractionTrackingEnabled(this.config.defaultTracking)?[4,this.add(formInteractionTracking()).promise]:[3,17];case 16:_0.sent(),_0.label=17;case 17:return(null===(_s=this.config.attribution)||void 0===_s?void 0:_s.disabled)?[3,19]:((webAttribution=webAttributionPlugin({excludeReferrers:null===(_t=this.config.attribution)||void 0===_t?void 0:_t.excludeReferrers,initialEmptyValue:null===(_u=this.config.attribution)||void 0===_u?void 0:_u.initialEmptyValue,resetSessionOnNewCampaign:null===(_v=this.config.attribution)||void 0===_v?void 0:_v.resetSessionOnNewCampaign})).__pluginEnabledOverride=!(!isNewSession&&!(null===(_w=this.config.attribution)||void 0===_w?void 0:_w.trackNewCampaigns))&&void 0,[4,this.add(webAttribution).promise]);case 18:_0.sent(),_0.label=19;case 19:return(pageViewTrackingOptions=getPageViewTrackingConfig(this.config)).eventType=pageViewTrackingOptions.eventType||DEFAULT_PAGE_VIEW_EVENT,[4,this.add(pageViewTrackingPlugin(pageViewTrackingOptions)).promise];case 20:return _0.sent(),[4,this.add(defaultPageViewEventEnrichment()).promise];case 21:return _0.sent(),this.initializing=!1,[4,this.runQueuedFunctions("dispatchQ")];case 22:return _0.sent(),connector.eventBridge.setEventReceiver((function(event){_this.track(event.eventType,event.eventProperties)})),[2]}}))}))},AmplitudeBrowser.prototype.getUserId=function(){var _a;return null===(_a=this.config)||void 0===_a?void 0:_a.userId},AmplitudeBrowser.prototype.setUserId=function(userId){this.config?userId===this.config.userId&&void 0!==userId||(this.config.userId=userId,setConnectorUserId(userId,this.config.instanceName)):this.q.push(this.setUserId.bind(this,userId))},AmplitudeBrowser.prototype.getDeviceId=function(){var _a;return null===(_a=this.config)||void 0===_a?void 0:_a.deviceId},AmplitudeBrowser.prototype.setDeviceId=function(deviceId){this.config?(this.config.deviceId=deviceId,setConnectorDeviceId(deviceId,this.config.instanceName)):this.q.push(this.setDeviceId.bind(this,deviceId))},AmplitudeBrowser.prototype.reset=function(){this.setDeviceId(UUID()),this.setUserId(void 0)},AmplitudeBrowser.prototype.getSessionId=function(){var _a;return null===(_a=this.config)||void 0===_a?void 0:_a.sessionId},AmplitudeBrowser.prototype.setSessionId=function(sessionId){var _a;if(this.config){if(sessionId!==this.config.sessionId){var previousSessionId=this.getSessionId(),lastEventTime=this.config.lastEventTime,lastEventId=null!==(_a=this.config.lastEventId)&&void 0!==_a?_a:-1;this.config.sessionId=sessionId,this.config.lastEventTime=void 0,isSessionTrackingEnabled(this.config.defaultTracking)&&(previousSessionId&&lastEventTime&&this.track(DEFAULT_SESSION_END_EVENT,void 0,{device_id:this.previousSessionDeviceId,event_id:++lastEventId,session_id:previousSessionId,time:lastEventTime+1,user_id:this.previousSessionUserId}),this.config.lastEventTime=this.config.sessionId,this.track(DEFAULT_SESSION_START_EVENT,void 0,{event_id:++lastEventId,session_id:this.config.sessionId,time:this.config.lastEventTime})),this.previousSessionDeviceId=this.config.deviceId,this.previousSessionUserId=this.config.userId}}else this.q.push(this.setSessionId.bind(this,sessionId))},AmplitudeBrowser.prototype.extendSession=function(){this.config?this.config.lastEventTime=Date.now():this.q.push(this.extendSession.bind(this))},AmplitudeBrowser.prototype.setTransport=function(transport){this.config?this.config.transportProvider=createTransport(transport):this.q.push(this.setTransport.bind(this,transport))},AmplitudeBrowser.prototype.identify=function(identify,eventOptions){if(isInstanceProxy(identify)){var queue=identify._q;identify._q=[],identify=convertProxyObjectToRealObject(new Identify,queue)}return(null==eventOptions?void 0:eventOptions.user_id)&&this.setUserId(eventOptions.user_id),(null==eventOptions?void 0:eventOptions.device_id)&&this.setDeviceId(eventOptions.device_id),_super.prototype.identify.call(this,identify,eventOptions)},AmplitudeBrowser.prototype.groupIdentify=function(groupType,groupName,identify,eventOptions){if(isInstanceProxy(identify)){var queue=identify._q;identify._q=[],identify=convertProxyObjectToRealObject(new Identify,queue)}return _super.prototype.groupIdentify.call(this,groupType,groupName,identify,eventOptions)},AmplitudeBrowser.prototype.revenue=function(revenue,eventOptions){if(isInstanceProxy(revenue)){var queue=revenue._q;revenue._q=[],revenue=convertProxyObjectToRealObject(new Revenue,queue)}return _super.prototype.revenue.call(this,revenue,eventOptions)},AmplitudeBrowser.prototype.process=function(event){return __awaiter(this,void 0,void 0,(function(){var currentTime,lastEventTime,timeSinceLastEvent;return __generator(this,(function(_a){return currentTime=Date.now(),lastEventTime=this.config.lastEventTime||Date.now(),timeSinceLastEvent=currentTime-lastEventTime,event.event_type!==DEFAULT_SESSION_START_EVENT&&event.event_type!==DEFAULT_SESSION_END_EVENT&&(!event.session_id||event.session_id===this.getSessionId())&&timeSinceLastEvent>this.config.sessionTimeout&&this.setSessionId(currentTime),[2,_super.prototype.process.call(this,event)]}))}))},AmplitudeBrowser}(AmplitudeCore);export{AmplitudeBrowser};