import{__assign,__awaiter,__generator,__read,__spreadArray}from"tslib";import{CampaignParser,getGlobalScope}from"@amplitude/analytics-client-common";import{IdentifyOperation,PluginType}from"@amplitude/analytics-types";import{BASE_CAMPAIGN}from"@amplitude/analytics-client-common";import{omitUndefined}from"./utils";export var pageViewTrackingPlugin=function(){for(var amplitude,args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];var pushState,options={},globalScope=getGlobalScope(),loggerProvider=void 0,_a=__read(args,2),clientOrOptions=_a[0],configOrUndefined=_a[1];clientOrOptions&&"init"in clientOrOptions?(amplitude=clientOrOptions,configOrUndefined&&(options=configOrUndefined)):clientOrOptions&&(options=clientOrOptions);var createPageViewEvent=function(){return __awaiter(void 0,void 0,void 0,(function(){var _a,_b,_c;return __generator(this,(function(_d){switch(_d.label){case 0:return _b={event_type:null!==(_c=options.eventType)&&void 0!==_c?_c:"Page View"},_a=[{}],[4,getCampaignParams()];case 1:return[2,(_b.event_properties=__assign.apply(void 0,[__assign.apply(void 0,_a.concat([_d.sent()])),{page_domain:"undefined"!=typeof location&&location.hostname||"",page_location:"undefined"!=typeof location&&location.href||"",page_path:"undefined"!=typeof location&&location.pathname||"",page_title:"undefined"!=typeof document&&document.title||"",page_url:"undefined"!=typeof location&&location.href.split("?")[0]||""}]),_b)]}}))}))},shouldTrackOnPageLoad=function(){return void 0===options.trackOn||"function"==typeof options.trackOn&&options.trackOn()},previousURL="undefined"!=typeof location?location.href:null,trackHistoryPageView=function(){return __awaiter(void 0,void 0,void 0,(function(){var newURL,shouldTrackPageView,_b,_c;return __generator(this,(function(_d){switch(_d.label){case 0:return newURL=location.href,shouldTrackPageView=shouldTrackHistoryPageView(options.trackHistoryChanges,newURL,previousURL||"")&&shouldTrackOnPageLoad(),previousURL=newURL,shouldTrackPageView?(null==loggerProvider||loggerProvider.log("Tracking page view event"),null!=amplitude?[3,1]:(void 0,[3,3])):[3,4];case 1:return _c=(_b=amplitude).track,[4,createPageViewEvent()];case 2:_c.apply(_b,[_d.sent()]),_d.label=3;case 3:_d.label=4;case 4:return[2]}}))}))},trackHistoryPageViewWrapper=function(){trackHistoryPageView()},plugin={name:"page-view-tracking",type:PluginType.ENRICHMENT,setup:function(config,client){return __awaiter(void 0,void 0,void 0,(function(){var receivedType,_a,_b,_c,_d;return __generator(this,(function(_e){switch(_e.label){case 0:return(amplitude=null!=amplitude?amplitude:client)?((loggerProvider=config.loggerProvider).log("Installing @amplitude/plugin-page-view-tracking-browser"),options.trackOn=(null===(_c=config.attribution)||void 0===_c?void 0:_c.trackPageViews)?"attribution":options.trackOn,!client&&(null===(_d=config.attribution)||void 0===_d?void 0:_d.trackPageViews)&&(loggerProvider.warn("@amplitude/plugin-page-view-tracking-browser overrides page view tracking behavior defined in @amplitude/analytics-browser. Resolve by disabling page view tracking in @amplitude/analytics-browser."),config.attribution.trackPageViews=!1),options.trackHistoryChanges&&globalScope&&(globalScope.addEventListener("popstate",trackHistoryPageViewWrapper),pushState=globalScope.history.pushState,globalScope.history.pushState=new Proxy(globalScope.history.pushState,{apply:function(target,thisArg,_a){var _b=__read(_a,3),state=_b[0],unused=_b[1],url=_b[2];target.apply(thisArg,[state,unused,url]),trackHistoryPageView()}})),shouldTrackOnPageLoad()?(loggerProvider.log("Tracking page view event"),_b=(_a=amplitude).track,[4,createPageViewEvent()]):[3,2]):(receivedType=clientOrOptions?"Options":"undefined",config.loggerProvider.error("Argument of type '".concat(receivedType,"' is not assignable to parameter of type 'BrowserClient'.")),[2]);case 1:_b.apply(_a,[_e.sent()]),_e.label=2;case 2:return[2]}}))}))},execute:function(event){return __awaiter(void 0,void 0,void 0,(function(){var pageViewEvent;return __generator(this,(function(_a){switch(_a.label){case 0:return"attribution"===options.trackOn&&isCampaignEvent(event)?(null==loggerProvider||loggerProvider.log("Enriching campaign event to page view event with campaign parameters"),[4,createPageViewEvent()]):[3,2];case 1:pageViewEvent=_a.sent(),event.event_type=pageViewEvent.event_type,event.event_properties=__assign(__assign({},event.event_properties),pageViewEvent.event_properties),_a.label=2;case 2:return[2,event]}}))}))},teardown:function(){return __awaiter(void 0,void 0,void 0,(function(){return __generator(this,(function(_a){return globalScope&&(globalScope.removeEventListener("popstate",trackHistoryPageViewWrapper),pushState&&(globalScope.history.pushState=pushState)),[2]}))}))}};return plugin.__trackHistoryPageView=trackHistoryPageView,plugin};var getCampaignParams=function(){return __awaiter(void 0,void 0,void 0,(function(){var _a;return __generator(this,(function(_b){switch(_b.label){case 0:return _a=omitUndefined,[4,(new CampaignParser).parse()];case 1:return[2,_a.apply(void 0,[_b.sent()])]}}))}))},isCampaignEvent=function(event){if("$identify"===event.event_type&&event.user_properties){var properties=event.user_properties,$set=properties[IdentifyOperation.SET]||{},$unset=properties[IdentifyOperation.UNSET]||{},userProperties_1=__spreadArray(__spreadArray([],__read(Object.keys($set)),!1),__read(Object.keys($unset)),!1);return Object.keys(BASE_CAMPAIGN).every((function(value){return userProperties_1.includes(value)}))}return!1};export var shouldTrackHistoryPageView=function(trackingOption,newURL,oldURL){return"pathOnly"===trackingOption?newURL.split("?")[0]!==oldURL.split("?")[0]:newURL!==oldURL};