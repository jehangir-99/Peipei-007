import{isString}from"./is.js";import{logger,CONSOLE_LEVELS,originalConsoleMethods}from"./logger.js";import{uuid4}from"./misc.js";import{fill,addNonEnumerableProperty}from"./object.js";import{getFunctionName}from"./stacktrace.js";import{supportsNativeFetch}from"./supports.js";import{getGlobalObject,GLOBAL_OBJ}from"./worldwide.js";import{supportsHistory}from"./vendor/supportsHistory.js";const WINDOW=getGlobalObject(),SENTRY_XHR_DATA_KEY="__sentry_xhr_v2__",handlers={},instrumented={};function instrument(type){if(!instrumented[type])switch(instrumented[type]=!0,type){case"console":instrumentConsole();break;case"dom":instrumentDOM();break;case"xhr":instrumentXHR();break;case"fetch":instrumentFetch();break;case"history":instrumentHistory();break;case"error":instrumentError();break;case"unhandledrejection":instrumentUnhandledRejection();break;default:return void(("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.warn("unknown instrumentation type:",type))}}function addInstrumentationHandler(type,callback){handlers[type]=handlers[type]||[],handlers[type].push(callback),instrument(type)}function resetInstrumentationHandlers(){Object.keys(handlers).forEach((key=>{handlers[key]=void 0}))}function triggerHandlers(type,data){if(type&&handlers[type])for(const handler of handlers[type]||[])try{handler(data)}catch(e){("undefined"==typeof __SENTRY_DEBUG__||__SENTRY_DEBUG__)&&logger.error(`Error while triggering instrumentation handler.\nType: ${type}\nName: ${getFunctionName(handler)}\nError:`,e)}}function instrumentConsole(){"console"in GLOBAL_OBJ&&CONSOLE_LEVELS.forEach((function(level){level in GLOBAL_OBJ.console&&fill(GLOBAL_OBJ.console,level,(function(originalConsoleMethod){return originalConsoleMethods[level]=originalConsoleMethod,function(...args){triggerHandlers("console",{args:args,level:level});const log=originalConsoleMethods[level];log&&log.apply(GLOBAL_OBJ.console,args)}}))}))}function instrumentFetch(){supportsNativeFetch()&&fill(GLOBAL_OBJ,"fetch",(function(originalFetch){return function(...args){const{method:method,url:url}=parseFetchArgs(args),handlerData={args:args,fetchData:{method:method,url:url},startTimestamp:Date.now()};return triggerHandlers("fetch",{...handlerData}),originalFetch.apply(GLOBAL_OBJ,args).then((response=>(triggerHandlers("fetch",{...handlerData,endTimestamp:Date.now(),response:response}),response)),(error=>{throw triggerHandlers("fetch",{...handlerData,endTimestamp:Date.now(),error:error}),error}))}}))}function hasProp(obj,prop){return!!obj&&"object"==typeof obj&&!!obj[prop]}function getUrlFromResource(resource){return"string"==typeof resource?resource:resource?hasProp(resource,"url")?resource.url:resource.toString?resource.toString():"":""}function parseFetchArgs(fetchArgs){if(0===fetchArgs.length)return{method:"GET",url:""};if(2===fetchArgs.length){const[url,options]=fetchArgs;return{url:getUrlFromResource(url),method:hasProp(options,"method")?String(options.method).toUpperCase():"GET"}}const arg=fetchArgs[0];return{url:getUrlFromResource(arg),method:hasProp(arg,"method")?String(arg.method).toUpperCase():"GET"}}function instrumentXHR(){if(!WINDOW.XMLHttpRequest)return;const xhrproto=XMLHttpRequest.prototype;fill(xhrproto,"open",(function(originalOpen){return function(...args){const startTimestamp=Date.now(),url=args[1],xhrInfo=this[SENTRY_XHR_DATA_KEY]={method:isString(args[0])?args[0].toUpperCase():args[0],url:args[1],request_headers:{}};isString(url)&&"POST"===xhrInfo.method&&url.match(/sentry_key/)&&(this.__sentry_own_request__=!0);const onreadystatechangeHandler=()=>{const xhrInfo=this[SENTRY_XHR_DATA_KEY];if(xhrInfo&&4===this.readyState){try{xhrInfo.status_code=this.status}catch(e){}triggerHandlers("xhr",{args:args,endTimestamp:Date.now(),startTimestamp:startTimestamp,xhr:this})}};return"onreadystatechange"in this&&"function"==typeof this.onreadystatechange?fill(this,"onreadystatechange",(function(original){return function(...readyStateArgs){return onreadystatechangeHandler(),original.apply(this,readyStateArgs)}})):this.addEventListener("readystatechange",onreadystatechangeHandler),fill(this,"setRequestHeader",(function(original){return function(...setRequestHeaderArgs){const[header,value]=setRequestHeaderArgs,xhrInfo=this[SENTRY_XHR_DATA_KEY];return xhrInfo&&(xhrInfo.request_headers[header.toLowerCase()]=value),original.apply(this,setRequestHeaderArgs)}})),originalOpen.apply(this,args)}})),fill(xhrproto,"send",(function(originalSend){return function(...args){const sentryXhrData=this[SENTRY_XHR_DATA_KEY];return sentryXhrData&&void 0!==args[0]&&(sentryXhrData.body=args[0]),triggerHandlers("xhr",{args:args,startTimestamp:Date.now(),xhr:this}),originalSend.apply(this,args)}}))}let lastHref;function instrumentHistory(){if(!supportsHistory())return;const oldOnPopState=WINDOW.onpopstate;function historyReplacementFunction(originalHistoryFunction){return function(...args){const url=args.length>2?args[2]:void 0;if(url){const from=lastHref,to=String(url);lastHref=to,triggerHandlers("history",{from:from,to:to})}return originalHistoryFunction.apply(this,args)}}WINDOW.onpopstate=function(...args){const to=WINDOW.location.href,from=lastHref;if(lastHref=to,triggerHandlers("history",{from:from,to:to}),oldOnPopState)try{return oldOnPopState.apply(this,args)}catch(_oO){}},fill(WINDOW.history,"pushState",historyReplacementFunction),fill(WINDOW.history,"replaceState",historyReplacementFunction)}const DEBOUNCE_DURATION=1e3;let debounceTimerID,lastCapturedEventType,lastCapturedEventTargetId;function isSimilarToLastCapturedEvent(event){if(event.type!==lastCapturedEventType)return!1;try{if(!event.target||event.target._sentryId!==lastCapturedEventTargetId)return!1}catch(e){}return!0}function shouldSkipDOMEvent(eventType,target){return"keypress"===eventType&&(!target||!target.tagName||"INPUT"!==target.tagName&&"TEXTAREA"!==target.tagName&&!target.isContentEditable)}function getEventTarget(event){try{return event.target}catch(e){return null}}function makeDOMEventHandler(handler,globalListener=!1){return event=>{if(!event||event._sentryCaptured)return;const target=getEventTarget(event);if(shouldSkipDOMEvent(event.type,target))return;addNonEnumerableProperty(event,"_sentryCaptured",!0),target&&!target._sentryId&&addNonEnumerableProperty(target,"_sentryId",uuid4());const name="keypress"===event.type?"input":event.type;isSimilarToLastCapturedEvent(event)||(handler({event:event,name:name,global:globalListener}),lastCapturedEventType=event.type,lastCapturedEventTargetId=target?target._sentryId:void 0),clearTimeout(debounceTimerID),debounceTimerID=WINDOW.setTimeout((()=>{lastCapturedEventTargetId=void 0,lastCapturedEventType=void 0}),DEBOUNCE_DURATION)}}function instrumentDOM(){if(!WINDOW.document)return;const triggerDOMHandler=triggerHandlers.bind(null,"dom"),globalDOMEventHandler=makeDOMEventHandler(triggerDOMHandler,!0);WINDOW.document.addEventListener("click",globalDOMEventHandler,!1),WINDOW.document.addEventListener("keypress",globalDOMEventHandler,!1),["EventTarget","Node"].forEach((target=>{const proto=WINDOW[target]&&WINDOW[target].prototype;proto&&proto.hasOwnProperty&&proto.hasOwnProperty("addEventListener")&&(fill(proto,"addEventListener",(function(originalAddEventListener){return function(type,listener,options){if("click"===type||"keypress"==type)try{const el=this,handlers=el.__sentry_instrumentation_handlers__=el.__sentry_instrumentation_handlers__||{},handlerForType=handlers[type]=handlers[type]||{refCount:0};if(!handlerForType.handler){const handler=makeDOMEventHandler(triggerDOMHandler);handlerForType.handler=handler,originalAddEventListener.call(this,type,handler,options)}handlerForType.refCount++}catch(e){}return originalAddEventListener.call(this,type,listener,options)}})),fill(proto,"removeEventListener",(function(originalRemoveEventListener){return function(type,listener,options){if("click"===type||"keypress"==type)try{const el=this,handlers=el.__sentry_instrumentation_handlers__||{},handlerForType=handlers[type];handlerForType&&(handlerForType.refCount--,handlerForType.refCount<=0&&(originalRemoveEventListener.call(this,type,handlerForType.handler,options),handlerForType.handler=void 0,delete handlers[type]),0===Object.keys(handlers).length&&delete el.__sentry_instrumentation_handlers__)}catch(e){}return originalRemoveEventListener.call(this,type,listener,options)}})))}))}let _oldOnErrorHandler=null;function instrumentError(){_oldOnErrorHandler=WINDOW.onerror,WINDOW.onerror=function(msg,url,line,column,error){return triggerHandlers("error",{column:column,error:error,line:line,msg:msg,url:url}),!(!_oldOnErrorHandler||_oldOnErrorHandler.__SENTRY_LOADER__)&&_oldOnErrorHandler.apply(this,arguments)},WINDOW.onerror.__SENTRY_INSTRUMENTED__=!0}let _oldOnUnhandledRejectionHandler=null;function instrumentUnhandledRejection(){_oldOnUnhandledRejectionHandler=WINDOW.onunhandledrejection,WINDOW.onunhandledrejection=function(e){return triggerHandlers("unhandledrejection",e),!(_oldOnUnhandledRejectionHandler&&!_oldOnUnhandledRejectionHandler.__SENTRY_LOADER__)||_oldOnUnhandledRejectionHandler.apply(this,arguments)},WINDOW.onunhandledrejection.__SENTRY_INSTRUMENTED__=!0}export{SENTRY_XHR_DATA_KEY,addInstrumentationHandler,instrumentDOM,instrumentXHR,parseFetchArgs,resetInstrumentationHandlers};