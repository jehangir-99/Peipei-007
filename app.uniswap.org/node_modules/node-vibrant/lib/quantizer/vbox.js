"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("../util"),VBox=function(){function VBox(r1,r2,g1,g2,b1,b2,hist){this._volume=-1,this._count=-1,this.dimension={r1:r1,r2:r2,g1:g1,g2:g2,b1:b1,b2:b2},this.hist=hist}return VBox.build=function(pixels,shouldIgnore){var rmax,rmin,gmax,gmin,bmax,bmin,r,g,b,hn=1<<3*util_1.SIGBITS,hist=new Uint32Array(hn);rmax=gmax=bmax=0,rmin=gmin=bmin=Number.MAX_VALUE;for(var n=pixels.length/4,i=0;i<n;){var offset=4*i;if(i++,r=pixels[offset+0],g=pixels[offset+1],b=pixels[offset+2],0!==pixels[offset+3])r>>=util_1.RSHIFT,g>>=util_1.RSHIFT,b>>=util_1.RSHIFT,hist[util_1.getColorIndex(r,g,b)]+=1,r>rmax&&(rmax=r),r<rmin&&(rmin=r),g>gmax&&(gmax=g),g<gmin&&(gmin=g),b>bmax&&(bmax=b),b<bmin&&(bmin=b)}return new VBox(rmin,rmax,gmin,gmax,bmin,bmax,hist)},VBox.prototype.invalidate=function(){this._volume=this._count=-1,this._avg=null},VBox.prototype.volume=function(){if(this._volume<0){var _a=this.dimension,r1=_a.r1,r2=_a.r2,g1=_a.g1,g2=_a.g2,b1=_a.b1,b2=_a.b2;this._volume=(r2-r1+1)*(g2-g1+1)*(b2-b1+1)}return this._volume},VBox.prototype.count=function(){if(this._count<0){for(var hist=this.hist,_a=this.dimension,r1=_a.r1,r2=_a.r2,g1=_a.g1,g2=_a.g2,b1=_a.b1,b2=_a.b2,c=0,r=r1;r<=r2;r++)for(var g=g1;g<=g2;g++)for(var b=b1;b<=b2;b++){c+=hist[util_1.getColorIndex(r,g,b)]}this._count=c}return this._count},VBox.prototype.clone=function(){var hist=this.hist,_a=this.dimension;return new VBox(_a.r1,_a.r2,_a.g1,_a.g2,_a.b1,_a.b2,hist)},VBox.prototype.avg=function(){if(!this._avg){var hist=this.hist,_a=this.dimension,r1=_a.r1,r2=_a.r2,g1=_a.g1,g2=_a.g2,b1=_a.b1,b2=_a.b2,ntot=0,mult=1<<8-util_1.SIGBITS,rsum=void 0,gsum=void 0,bsum=void 0;rsum=gsum=bsum=0;for(var r=r1;r<=r2;r++)for(var g=g1;g<=g2;g++)for(var b=b1;b<=b2;b++){var h=hist[util_1.getColorIndex(r,g,b)];ntot+=h,rsum+=h*(r+.5)*mult,gsum+=h*(g+.5)*mult,bsum+=h*(b+.5)*mult}this._avg=ntot?[~~(rsum/ntot),~~(gsum/ntot),~~(bsum/ntot)]:[~~(mult*(r1+r2+1)/2),~~(mult*(g1+g2+1)/2),~~(mult*(b1+b2+1)/2)]}return this._avg},VBox.prototype.contains=function(rgb){var r=rgb[0],g=rgb[1],b=rgb[2],_a=this.dimension,r1=_a.r1,r2=_a.r2,g1=_a.g1,g2=_a.g2,b1=_a.b1,b2=_a.b2;return r>>=util_1.RSHIFT,g>>=util_1.RSHIFT,b>>=util_1.RSHIFT,r>=r1&&r<=r2&&g>=g1&&g<=g2&&b>=b1&&b<=b2},VBox.prototype.split=function(){var hist=this.hist,_a=this.dimension,r1=_a.r1,r2=_a.r2,g1=_a.g1,g2=_a.g2,b1=_a.b1,b2=_a.b2,count=this.count();if(!count)return[];if(1===count)return[this.clone()];var sum,total,rw=r2-r1+1,gw=g2-g1+1,bw=b2-b1+1,maxw=Math.max(rw,gw,bw),accSum=null;sum=total=0;var maxd=null;if(maxw===rw){maxd="r",accSum=new Uint32Array(r2+1);for(var r=r1;r<=r2;r++){sum=0;for(var g=g1;g<=g2;g++)for(var b=b1;b<=b2;b++){sum+=hist[util_1.getColorIndex(r,g,b)]}total+=sum,accSum[r]=total}}else if(maxw===gw){maxd="g",accSum=new Uint32Array(g2+1);for(g=g1;g<=g2;g++){sum=0;for(r=r1;r<=r2;r++)for(b=b1;b<=b2;b++){sum+=hist[util_1.getColorIndex(r,g,b)]}total+=sum,accSum[g]=total}}else{maxd="b",accSum=new Uint32Array(b2+1);for(b=b1;b<=b2;b++){sum=0;for(r=r1;r<=r2;r++)for(g=g1;g<=g2;g++){sum+=hist[util_1.getColorIndex(r,g,b)]}total+=sum,accSum[b]=total}}for(var splitPoint=-1,reverseSum=new Uint32Array(accSum.length),i=0;i<accSum.length;i++){var d=accSum[i];splitPoint<0&&d>total/2&&(splitPoint=i),reverseSum[i]=total-d}var vbox=this;return function(d){var dim1=d+"1",dim2=d+"2",d1=vbox.dimension[dim1],d2=vbox.dimension[dim2],vbox1=vbox.clone(),vbox2=vbox.clone(),left=splitPoint-d1,right=d2-splitPoint;for(left<=right?(d2=Math.min(d2-1,~~(splitPoint+right/2)),d2=Math.max(0,d2)):(d2=Math.max(d1,~~(splitPoint-1-left/2)),d2=Math.min(vbox.dimension[dim2],d2));!accSum[d2];)d2++;for(var c2=reverseSum[d2];!c2&&accSum[d2-1];)c2=reverseSum[--d2];return vbox1.dimension[dim2]=d2,vbox2.dimension[dim1]=d2+1,[vbox1,vbox2]}(maxd)},VBox}();exports.default=VBox;