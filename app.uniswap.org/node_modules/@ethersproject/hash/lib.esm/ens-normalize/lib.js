import{toUtf8CodePoints}from"@ethersproject/strings";import{getData}from"./include.js";const r=getData();import{read_member_array,read_mapped_map,read_emoji_trie}from"./decoder.js";const VALID=new Set(read_member_array(r)),IGNORED=new Set(read_member_array(r)),MAPPED=read_mapped_map(r),EMOJI_ROOT=read_emoji_trie(r),HYPHEN=45,UNDERSCORE=95;function explode_cp(name){return toUtf8CodePoints(name)}function filter_fe0f(cps){return cps.filter((cp=>65039!=cp))}export function ens_normalize_post_check(name){for(let label of name.split(".")){let cps=explode_cp(label);try{for(let i=cps.lastIndexOf(UNDERSCORE)-1;i>=0;i--)if(cps[i]!==UNDERSCORE)throw new Error("underscore only allowed at start");if(cps.length>=4&&cps.every((cp=>cp<128))&&cps[2]===HYPHEN&&cps[3]===HYPHEN)throw new Error("invalid label extension")}catch(err){throw new Error(`Invalid label "${label}": ${err.message}`)}}return name}export function ens_normalize(name){return ens_normalize_post_check(normalize(name,filter_fe0f))}function normalize(name,emoji_filter){let input=explode_cp(name).reverse(),output=[];for(;input.length;){let emoji=consume_emoji_reversed(input);if(emoji){output.push(...emoji_filter(emoji));continue}let cp=input.pop();if(VALID.has(cp)){output.push(cp);continue}if(IGNORED.has(cp))continue;let cps=MAPPED[cp];if(!cps)throw new Error(`Disallowed codepoint: 0x${cp.toString(16).toUpperCase()}`);output.push(...cps)}return ens_normalize_post_check(nfc(String.fromCodePoint(...output)))}function nfc(s){return s.normalize("NFC")}function consume_emoji_reversed(cps,eaten){var _a;let emoji,saved,node=EMOJI_ROOT,stack=[],pos=cps.length;for(eaten&&(eaten.length=0);pos;){let cp=cps[--pos];if(node=null===(_a=node.branches.find((x=>x.set.has(cp))))||void 0===_a?void 0:_a.node,!node)break;if(node.save)saved=cp;else if(node.check&&cp===saved)break;stack.push(cp),node.fe0f&&(stack.push(65039),pos>0&&65039==cps[pos-1]&&pos--),node.valid&&(emoji=stack.slice(),2==node.valid&&emoji.splice(1,1),eaten&&eaten.push(...cps.slice(pos).reverse()),cps.length=pos)}return emoji}