"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var constant_time_1=require("@stablelib/constant-time"),wipe_1=require("@stablelib/wipe");exports.DIGEST_LENGTH=16;var Poly1305=function(){function Poly1305(key){this.digestLength=exports.DIGEST_LENGTH,this._buffer=new Uint8Array(16),this._r=new Uint16Array(10),this._h=new Uint16Array(10),this._pad=new Uint16Array(8),this._leftover=0,this._fin=0,this._finished=!1;var t0=key[0]|key[1]<<8;this._r[0]=8191&t0;var t1=key[2]|key[3]<<8;this._r[1]=8191&(t0>>>13|t1<<3);var t2=key[4]|key[5]<<8;this._r[2]=7939&(t1>>>10|t2<<6);var t3=key[6]|key[7]<<8;this._r[3]=8191&(t2>>>7|t3<<9);var t4=key[8]|key[9]<<8;this._r[4]=255&(t3>>>4|t4<<12),this._r[5]=t4>>>1&8190;var t5=key[10]|key[11]<<8;this._r[6]=8191&(t4>>>14|t5<<2);var t6=key[12]|key[13]<<8;this._r[7]=8065&(t5>>>11|t6<<5);var t7=key[14]|key[15]<<8;this._r[8]=8191&(t6>>>8|t7<<8),this._r[9]=t7>>>5&127,this._pad[0]=key[16]|key[17]<<8,this._pad[1]=key[18]|key[19]<<8,this._pad[2]=key[20]|key[21]<<8,this._pad[3]=key[22]|key[23]<<8,this._pad[4]=key[24]|key[25]<<8,this._pad[5]=key[26]|key[27]<<8,this._pad[6]=key[28]|key[29]<<8,this._pad[7]=key[30]|key[31]<<8}return Poly1305.prototype._blocks=function(m,mpos,bytes){for(var hibit=this._fin?0:2048,h0=this._h[0],h1=this._h[1],h2=this._h[2],h3=this._h[3],h4=this._h[4],h5=this._h[5],h6=this._h[6],h7=this._h[7],h8=this._h[8],h9=this._h[9],r0=this._r[0],r1=this._r[1],r2=this._r[2],r3=this._r[3],r4=this._r[4],r5=this._r[5],r6=this._r[6],r7=this._r[7],r8=this._r[8],r9=this._r[9];bytes>=16;){var t0=m[mpos+0]|m[mpos+1]<<8;h0+=8191&t0;var t1=m[mpos+2]|m[mpos+3]<<8;h1+=8191&(t0>>>13|t1<<3);var t2=m[mpos+4]|m[mpos+5]<<8;h2+=8191&(t1>>>10|t2<<6);var t3=m[mpos+6]|m[mpos+7]<<8;h3+=8191&(t2>>>7|t3<<9);var t4=m[mpos+8]|m[mpos+9]<<8;h4+=8191&(t3>>>4|t4<<12),h5+=t4>>>1&8191;var t5=m[mpos+10]|m[mpos+11]<<8;h6+=8191&(t4>>>14|t5<<2);var t6=m[mpos+12]|m[mpos+13]<<8;h7+=8191&(t5>>>11|t6<<5);var t7=m[mpos+14]|m[mpos+15]<<8,c=0,d0=c;d0+=h0*r0,d0+=h1*(5*r9),d0+=h2*(5*r8),d0+=h3*(5*r7),c=(d0+=h4*(5*r6))>>>13,d0&=8191,d0+=h5*(5*r5),d0+=h6*(5*r4),d0+=h7*(5*r3),d0+=(h8+=8191&(t6>>>8|t7<<8))*(5*r2);var d1=c+=(d0+=(h9+=t7>>>5|hibit)*(5*r1))>>>13;d1+=h0*r1,d1+=h1*r0,d1+=h2*(5*r9),d1+=h3*(5*r8),c=(d1+=h4*(5*r7))>>>13,d1&=8191,d1+=h5*(5*r6),d1+=h6*(5*r5),d1+=h7*(5*r4),d1+=h8*(5*r3),c+=(d1+=h9*(5*r2))>>>13,d1&=8191;var d2=c;d2+=h0*r2,d2+=h1*r1,d2+=h2*r0,d2+=h3*(5*r9),c=(d2+=h4*(5*r8))>>>13,d2&=8191,d2+=h5*(5*r7),d2+=h6*(5*r6),d2+=h7*(5*r5),d2+=h8*(5*r4);var d3=c+=(d2+=h9*(5*r3))>>>13;d3+=h0*r3,d3+=h1*r2,d3+=h2*r1,d3+=h3*r0,c=(d3+=h4*(5*r9))>>>13,d3&=8191,d3+=h5*(5*r8),d3+=h6*(5*r7),d3+=h7*(5*r6),d3+=h8*(5*r5);var d4=c+=(d3+=h9*(5*r4))>>>13;d4+=h0*r4,d4+=h1*r3,d4+=h2*r2,d4+=h3*r1,c=(d4+=h4*r0)>>>13,d4&=8191,d4+=h5*(5*r9),d4+=h6*(5*r8),d4+=h7*(5*r7),d4+=h8*(5*r6);var d5=c+=(d4+=h9*(5*r5))>>>13;d5+=h0*r5,d5+=h1*r4,d5+=h2*r3,d5+=h3*r2,c=(d5+=h4*r1)>>>13,d5&=8191,d5+=h5*r0,d5+=h6*(5*r9),d5+=h7*(5*r8),d5+=h8*(5*r7);var d6=c+=(d5+=h9*(5*r6))>>>13;d6+=h0*r6,d6+=h1*r5,d6+=h2*r4,d6+=h3*r3,c=(d6+=h4*r2)>>>13,d6&=8191,d6+=h5*r1,d6+=h6*r0,d6+=h7*(5*r9),d6+=h8*(5*r8);var d7=c+=(d6+=h9*(5*r7))>>>13;d7+=h0*r7,d7+=h1*r6,d7+=h2*r5,d7+=h3*r4,c=(d7+=h4*r3)>>>13,d7&=8191,d7+=h5*r2,d7+=h6*r1,d7+=h7*r0,d7+=h8*(5*r9);var d8=c+=(d7+=h9*(5*r8))>>>13;d8+=h0*r8,d8+=h1*r7,d8+=h2*r6,d8+=h3*r5,c=(d8+=h4*r4)>>>13,d8&=8191,d8+=h5*r3,d8+=h6*r2,d8+=h7*r1,d8+=h8*r0;var d9=c+=(d8+=h9*(5*r9))>>>13;d9+=h0*r9,d9+=h1*r8,d9+=h2*r7,d9+=h3*r6,c=(d9+=h4*r5)>>>13,d9&=8191,d9+=h5*r4,d9+=h6*r3,d9+=h7*r2,d9+=h8*r1,h0=d0=8191&(c=(c=((c+=(d9+=h9*r0)>>>13)<<2)+c|0)+(d0&=8191)|0),h1=d1+=c>>>=13,h2=d2&=8191,h3=d3&=8191,h4=d4&=8191,h5=d5&=8191,h6=d6&=8191,h7=d7&=8191,h8=d8&=8191,h9=d9&=8191,mpos+=16,bytes-=16}this._h[0]=h0,this._h[1]=h1,this._h[2]=h2,this._h[3]=h3,this._h[4]=h4,this._h[5]=h5,this._h[6]=h6,this._h[7]=h7,this._h[8]=h8,this._h[9]=h9},Poly1305.prototype.finish=function(mac,macpos){void 0===macpos&&(macpos=0);var c,mask,f,i,g=new Uint16Array(10);if(this._leftover){for(i=this._leftover,this._buffer[i++]=1;i<16;i++)this._buffer[i]=0;this._fin=1,this._blocks(this._buffer,0,16)}for(c=this._h[1]>>>13,this._h[1]&=8191,i=2;i<10;i++)this._h[i]+=c,c=this._h[i]>>>13,this._h[i]&=8191;for(this._h[0]+=5*c,c=this._h[0]>>>13,this._h[0]&=8191,this._h[1]+=c,c=this._h[1]>>>13,this._h[1]&=8191,this._h[2]+=c,g[0]=this._h[0]+5,c=g[0]>>>13,g[0]&=8191,i=1;i<10;i++)g[i]=this._h[i]+c,c=g[i]>>>13,g[i]&=8191;for(g[9]-=8192,mask=(1^c)-1,i=0;i<10;i++)g[i]&=mask;for(mask=~mask,i=0;i<10;i++)this._h[i]=this._h[i]&mask|g[i];for(this._h[0]=65535&(this._h[0]|this._h[1]<<13),this._h[1]=65535&(this._h[1]>>>3|this._h[2]<<10),this._h[2]=65535&(this._h[2]>>>6|this._h[3]<<7),this._h[3]=65535&(this._h[3]>>>9|this._h[4]<<4),this._h[4]=65535&(this._h[4]>>>12|this._h[5]<<1|this._h[6]<<14),this._h[5]=65535&(this._h[6]>>>2|this._h[7]<<11),this._h[6]=65535&(this._h[7]>>>5|this._h[8]<<8),this._h[7]=65535&(this._h[8]>>>8|this._h[9]<<5),f=this._h[0]+this._pad[0],this._h[0]=65535&f,i=1;i<8;i++)f=(this._h[i]+this._pad[i]|0)+(f>>>16)|0,this._h[i]=65535&f;return mac[macpos+0]=this._h[0]>>>0,mac[macpos+1]=this._h[0]>>>8,mac[macpos+2]=this._h[1]>>>0,mac[macpos+3]=this._h[1]>>>8,mac[macpos+4]=this._h[2]>>>0,mac[macpos+5]=this._h[2]>>>8,mac[macpos+6]=this._h[3]>>>0,mac[macpos+7]=this._h[3]>>>8,mac[macpos+8]=this._h[4]>>>0,mac[macpos+9]=this._h[4]>>>8,mac[macpos+10]=this._h[5]>>>0,mac[macpos+11]=this._h[5]>>>8,mac[macpos+12]=this._h[6]>>>0,mac[macpos+13]=this._h[6]>>>8,mac[macpos+14]=this._h[7]>>>0,mac[macpos+15]=this._h[7]>>>8,this._finished=!0,this},Poly1305.prototype.update=function(m){var want,mpos=0,bytes=m.length;if(this._leftover){(want=16-this._leftover)>bytes&&(want=bytes);for(var i=0;i<want;i++)this._buffer[this._leftover+i]=m[mpos+i];if(bytes-=want,mpos+=want,this._leftover+=want,this._leftover<16)return this;this._blocks(this._buffer,0,16),this._leftover=0}if(bytes>=16&&(want=bytes-bytes%16,this._blocks(m,mpos,want),mpos+=want,bytes-=want),bytes){for(i=0;i<bytes;i++)this._buffer[this._leftover+i]=m[mpos+i];this._leftover+=bytes}return this},Poly1305.prototype.digest=function(){if(this._finished)throw new Error("Poly1305 was finished");var mac=new Uint8Array(16);return this.finish(mac),mac},Poly1305.prototype.clean=function(){return wipe_1.wipe(this._buffer),wipe_1.wipe(this._r),wipe_1.wipe(this._h),wipe_1.wipe(this._pad),this._leftover=0,this._fin=0,this._finished=!0,this},Poly1305}();function oneTimeAuth(key,data){var h=new Poly1305(key);h.update(data);var digest=h.digest();return h.clean(),digest}function equal(a,b){return a.length===exports.DIGEST_LENGTH&&b.length===exports.DIGEST_LENGTH&&constant_time_1.equal(a,b)}exports.Poly1305=Poly1305,exports.oneTimeAuth=oneTimeAuth,exports.equal=equal;