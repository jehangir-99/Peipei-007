import{clearInterval,setInterval}from"../../tools/timer";import{Observable}from"../../tools/observable";import{ONE_SECOND,dateNow}from"../../tools/utils/timeUtils";import{throttle}from"../../tools/utils/functionUtils";import{generateUUID}from"../../tools/utils/stringUtils";import{selectCookieStrategy,initCookieStrategy}from"./storeStrategies/sessionInCookie";import{getExpiredSessionState,isSessionInExpiredState,isSessionInNotStartedState,isSessionStarted}from"./sessionState";import{initLocalStorageStrategy,selectLocalStorageStrategy}from"./storeStrategies/sessionInLocalStorage";import{processSessionStoreOperations}from"./sessionStoreOperations";export var STORAGE_POLL_DELAY=ONE_SECOND;export function selectSessionStoreStrategyType(initConfiguration){var sessionStoreStrategyType=selectCookieStrategy(initConfiguration);return!sessionStoreStrategyType&&initConfiguration.allowFallbackToLocalStorage&&(sessionStoreStrategyType=selectLocalStorageStrategy()),sessionStoreStrategyType}export function startSessionStore(sessionStoreStrategyType,productKey,computeSessionState){var sessionCache,renewObservable=new Observable,expireObservable=new Observable,sessionStoreStrategy="Cookie"===sessionStoreStrategyType.type?initCookieStrategy(sessionStoreStrategyType.cookieOptions):initLocalStorageStrategy(),expireSession=sessionStoreStrategy.expireSession,watchSessionTimeoutId=setInterval((function(){processSessionStoreOperations({process:function(sessionState){return isSessionInExpiredState(sessionState)?getExpiredSessionState():void 0},after:synchronizeSession},sessionStoreStrategy)}),STORAGE_POLL_DELAY);startSession();var _a=throttle((function(){processSessionStoreOperations({process:function(sessionState){if(!isSessionInNotStartedState(sessionState)){var synchronizedSession=synchronizeSession(sessionState);return function(sessionState){if(isSessionInNotStartedState(sessionState))return!1;var _a=computeSessionState(sessionState[productKey]),trackingType=_a.trackingType,isTracked=_a.isTracked;sessionState[productKey]=trackingType,delete sessionState.isExpired,isTracked&&!sessionState.id&&(sessionState.id=generateUUID(),sessionState.created=String(dateNow()))}(synchronizedSession),synchronizedSession}},after:function(sessionState){isSessionStarted(sessionState)&&!hasSessionInCache()&&function(sessionState){sessionCache=sessionState,renewObservable.notify()}(sessionState),sessionCache=sessionState}},sessionStoreStrategy)}),STORAGE_POLL_DELAY),throttledExpandOrRenewSession=_a.throttled,cancelExpandOrRenewSession=_a.cancel;function synchronizeSession(sessionState){return isSessionInExpiredState(sessionState)&&(sessionState=getExpiredSessionState()),hasSessionInCache()&&(!function(sessionState){return sessionCache.id!==sessionState.id||sessionCache[productKey]!==sessionState[productKey]}(sessionState)?sessionCache=sessionState:(sessionCache=getExpiredSessionState(),expireObservable.notify())),sessionState}function startSession(){processSessionStoreOperations({process:function(sessionState){if(isSessionInNotStartedState(sessionState))return getExpiredSessionState()},after:function(sessionState){sessionCache=sessionState}},sessionStoreStrategy)}function hasSessionInCache(){return void 0!==sessionCache[productKey]}return{expandOrRenewSession:throttledExpandOrRenewSession,expandSession:function(){processSessionStoreOperations({process:function(sessionState){return hasSessionInCache()?synchronizeSession(sessionState):void 0}},sessionStoreStrategy)},getSession:function(){return sessionCache},renewObservable:renewObservable,expireObservable:expireObservable,restartSession:startSession,expire:function(){cancelExpandOrRenewSession(),expireSession(),synchronizeSession(getExpiredSessionState())},stop:function(){clearInterval(watchSessionTimeoutId)}}}