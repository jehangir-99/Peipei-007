import{ONE_KIBI_BYTE,computeBytesCount}from"../../tools/utils/byteUtils";import{throttle}from"../../tools/utils/functionUtils";import{jsonStringify}from"../../tools/serialisation/jsonStringify";import{DOCS_ORIGIN,display}from"../../tools/display";import{isEmptyObject}from"../../tools/utils/objectUtils";export var CUSTOMER_DATA_BYTES_LIMIT=3*ONE_KIBI_BYTE;export var CUSTOMER_COMPRESSED_DATA_BYTES_LIMIT=16*ONE_KIBI_BYTE;export var BYTES_COMPUTATION_THROTTLING_DELAY=200;export function createCustomerDataTrackerManager(compressionStatus){void 0===compressionStatus&&(compressionStatus=2);var customerDataTrackers=new Map,alreadyWarned=!1;function checkCustomerDataLimit(initialBytesCount){if(void 0===initialBytesCount&&(initialBytesCount=0),!alreadyWarned&&0!==compressionStatus){var bytesCountLimit=2===compressionStatus?CUSTOMER_DATA_BYTES_LIMIT:CUSTOMER_COMPRESSED_DATA_BYTES_LIMIT,bytesCount=initialBytesCount;customerDataTrackers.forEach((function(tracker){bytesCount+=tracker.getBytesCount()})),bytesCount>bytesCountLimit&&(displayCustomerDataLimitReachedWarning(bytesCountLimit),alreadyWarned=!0)}}return{createDetachedTracker:function(){var tracker=createCustomerDataTracker((function(){return checkCustomerDataLimit(tracker.getBytesCount())}));return tracker},getOrCreateTracker:function(type){return customerDataTrackers.has(type)||customerDataTrackers.set(type,createCustomerDataTracker(checkCustomerDataLimit)),customerDataTrackers.get(type)},setCompressionStatus:function(newCompressionStatus){0===compressionStatus&&(compressionStatus=newCompressionStatus,checkCustomerDataLimit())},getCompressionStatus:function(){return compressionStatus},stop:function(){customerDataTrackers.forEach((function(tracker){return tracker.stop()})),customerDataTrackers.clear()}}}export function createCustomerDataTracker(checkCustomerDataLimit){var bytesCountCache=0,_a=throttle((function(context){bytesCountCache=computeBytesCount(jsonStringify(context)),checkCustomerDataLimit()}),BYTES_COMPUTATION_THROTTLING_DELAY),computeBytesCountThrottled=_a.throttled,cancelComputeBytesCount=_a.cancel,resetBytesCount=function(){cancelComputeBytesCount(),bytesCountCache=0};return{updateCustomerData:function(context){isEmptyObject(context)?resetBytesCount():computeBytesCountThrottled(context)},resetCustomerData:resetBytesCount,getBytesCount:function(){return bytesCountCache},stop:function(){cancelComputeBytesCount()}}}function displayCustomerDataLimitReachedWarning(bytesCountLimit){display.warn("Customer data exceeds the recommended ".concat(bytesCountLimit/ONE_KIBI_BYTE,"KiB threshold. More details: ").concat(DOCS_ORIGIN,"/real_user_monitoring/browser/troubleshooting/#customer-data-exceeds-the-recommended-threshold-warning"))}