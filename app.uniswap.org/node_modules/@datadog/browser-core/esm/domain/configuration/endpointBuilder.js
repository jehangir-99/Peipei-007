import{timeStampNow}from"../../tools/utils/timeUtils";import{normalizeUrl}from"../../tools/utils/urlPolyfill";import{generateUUID}from"../../tools/utils/stringUtils";import{INTAKE_SITE_US1,INTAKE_SITE_FED_STAGING,PCI_INTAKE_HOST_US1}from"./intakeSites";export function createEndpointBuilder(initConfiguration,trackType,configurationTags){var buildUrlWithParameters=createEndpointUrlWithParametersBuilder(initConfiguration,trackType);return{build:function(api,payload){var parameters=buildEndpointParameters(initConfiguration,trackType,configurationTags,api,payload);return buildUrlWithParameters(parameters)},urlPrefix:buildUrlWithParameters(""),trackType:trackType}}function createEndpointUrlWithParametersBuilder(initConfiguration,trackType){var path="/api/v2/".concat(trackType),proxy=initConfiguration.proxy;if("string"==typeof proxy){var normalizedProxyUrl_1=normalizeUrl(proxy);return function(parameters){return"".concat(normalizedProxyUrl_1,"?ddforward=").concat(encodeURIComponent("".concat(path,"?").concat(parameters)))}}if("function"==typeof proxy)return function(parameters){return proxy({path:path,parameters:parameters})};var host=buildEndpointHost(trackType,initConfiguration);return function(parameters){return"https://".concat(host).concat(path,"?").concat(parameters)}}function buildEndpointHost(trackType,initConfiguration){var _a=initConfiguration.site,site=void 0===_a?INTAKE_SITE_US1:_a,internalAnalyticsSubdomain=initConfiguration.internalAnalyticsSubdomain;if("logs"===trackType&&initConfiguration.usePciIntake&&site===INTAKE_SITE_US1)return PCI_INTAKE_HOST_US1;if(internalAnalyticsSubdomain&&site===INTAKE_SITE_US1)return"".concat(internalAnalyticsSubdomain,".").concat(INTAKE_SITE_US1);if(site===INTAKE_SITE_FED_STAGING)return"http-intake.logs.".concat(site);var domainParts=site.split("."),extension=domainParts.pop();return"browser-intake-".concat(domainParts.join("-"),".").concat(extension)}function buildEndpointParameters(_a,trackType,configurationTags,api,_b){var clientToken=_a.clientToken,internalAnalyticsSubdomain=_a.internalAnalyticsSubdomain,retry=_b.retry,encoding=_b.encoding,tags=["sdk_version:".concat("5.20.0"),"api:".concat(api)].concat(configurationTags);retry&&tags.push("retry_count:".concat(retry.count),"retry_after:".concat(retry.lastFailureStatus));var parameters=["ddsource=browser","ddtags=".concat(encodeURIComponent(tags.join(","))),"dd-api-key=".concat(clientToken),"dd-evp-origin-version=".concat(encodeURIComponent("5.20.0")),"dd-evp-origin=browser","dd-request-id=".concat(generateUUID())];return encoding&&parameters.push("dd-evp-encoding=".concat(encoding)),"rum"===trackType&&parameters.push("batch_time=".concat(timeStampNow())),internalAnalyticsSubdomain&&parameters.reverse(),parameters.join("&")}