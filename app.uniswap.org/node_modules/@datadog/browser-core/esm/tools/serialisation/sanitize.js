import{display}from"../display";import{ONE_KIBI_BYTE}from"../utils/byteUtils";import{detachToJsonMethod}from"./jsonStringify";var SANITIZE_DEFAULT_MAX_CHARACTER_COUNT=220*ONE_KIBI_BYTE,JSON_PATH_ROOT_ELEMENT="$",KEY_DECORATION_LENGTH=3;export function sanitize(source,maxCharacterCount){var _a;void 0===maxCharacterCount&&(maxCharacterCount=SANITIZE_DEFAULT_MAX_CHARACTER_COUNT);var restoreObjectPrototypeToJson=detachToJsonMethod(Object.prototype),restoreArrayPrototypeToJson=detachToJsonMethod(Array.prototype),containerQueue=[],visitedObjectsWithPath=new WeakMap,sanitizedData=sanitizeProcessor(source,JSON_PATH_ROOT_ELEMENT,void 0,containerQueue,visitedObjectsWithPath),accumulatedCharacterCount=(null===(_a=JSON.stringify(sanitizedData))||void 0===_a?void 0:_a.length)||0;if(!(accumulatedCharacterCount>maxCharacterCount)){for(;containerQueue.length>0&&accumulatedCharacterCount<maxCharacterCount;){var containerToProcess=containerQueue.shift(),separatorLength=0;if(Array.isArray(containerToProcess.source))for(var key=0;key<containerToProcess.source.length;key++){if(accumulatedCharacterCount+=void 0!==(targetData=sanitizeProcessor(containerToProcess.source[key],containerToProcess.path,key,containerQueue,visitedObjectsWithPath))?JSON.stringify(targetData).length:4,accumulatedCharacterCount+=separatorLength,separatorLength=1,accumulatedCharacterCount>maxCharacterCount){warnOverCharacterLimit(maxCharacterCount,"truncated",source);break}containerToProcess.target[key]=targetData}else for(var key in containerToProcess.source)if(Object.prototype.hasOwnProperty.call(containerToProcess.source,key)){var targetData;if(void 0!==(targetData=sanitizeProcessor(containerToProcess.source[key],containerToProcess.path,key,containerQueue,visitedObjectsWithPath))&&(accumulatedCharacterCount+=JSON.stringify(targetData).length+separatorLength+key.length+KEY_DECORATION_LENGTH,separatorLength=1),accumulatedCharacterCount>maxCharacterCount){warnOverCharacterLimit(maxCharacterCount,"truncated",source);break}containerToProcess.target[key]=targetData}}return restoreObjectPrototypeToJson(),restoreArrayPrototypeToJson(),sanitizedData}warnOverCharacterLimit(maxCharacterCount,"discarded",source)}function sanitizeProcessor(source,parentPath,key,queue,visitedObjectsWithPath){var sourceToSanitize=tryToApplyToJSON(source);if(!sourceToSanitize||"object"!=typeof sourceToSanitize)return sanitizePrimitivesAndFunctions(sourceToSanitize);var sanitizedSource=sanitizeObjects(sourceToSanitize);if("[Object]"!==sanitizedSource&&"[Array]"!==sanitizedSource&&"[Error]"!==sanitizedSource)return sanitizedSource;var sourceAsObject=source;if(visitedObjectsWithPath.has(sourceAsObject))return"[Reference seen at ".concat(visitedObjectsWithPath.get(sourceAsObject),"]");var currentPath=void 0!==key?"".concat(parentPath,".").concat(key):parentPath,target=Array.isArray(sourceToSanitize)?[]:{};return visitedObjectsWithPath.set(sourceAsObject,currentPath),queue.push({source:sourceToSanitize,target:target,path:currentPath}),target}function sanitizePrimitivesAndFunctions(value){return"bigint"==typeof value?"[BigInt] ".concat(value.toString()):"function"==typeof value?"[Function] ".concat(value.name||"unknown"):"symbol"==typeof value?"[Symbol] ".concat(value.description||value.toString()):value}function sanitizeObjects(value){try{if(value instanceof Event)return{isTrusted:value.isTrusted};var match=Object.prototype.toString.call(value).match(/\[object (.*)\]/);if(match&&match[1])return"[".concat(match[1],"]")}catch(_a){}return"[Unserializable]"}function tryToApplyToJSON(value){var object=value;if(object&&"function"==typeof object.toJSON)try{return object.toJSON()}catch(_a){}return value}function warnOverCharacterLimit(maxCharacterCount,changeType,source){display.warn("The data provided has been ".concat(changeType," as it is over the limit of ").concat(maxCharacterCount," characters:"),source)}