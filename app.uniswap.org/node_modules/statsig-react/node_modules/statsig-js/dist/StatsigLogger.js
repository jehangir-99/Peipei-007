"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var LogEvent_1=__importDefault(require("./LogEvent")),StatsigNetwork_1=require("./StatsigNetwork"),Constants_1=require("./utils/Constants"),Diagnostics_1=__importDefault(require("./utils/Diagnostics")),StatsigAsyncStorage_1=__importDefault(require("./utils/StatsigAsyncStorage")),StatsigLocalStorage_1=__importDefault(require("./utils/StatsigLocalStorage")),INTERNAL_EVENT_PREFIX="statsig::",CONFIG_EXPOSURE_EVENT=INTERNAL_EVENT_PREFIX+"config_exposure",LAYER_EXPOSURE_EVENT=INTERNAL_EVENT_PREFIX+"layer_exposure",GATE_EXPOSURE_EVENT=INTERNAL_EVENT_PREFIX+"gate_exposure",LOG_FAILURE_EVENT=INTERNAL_EVENT_PREFIX+"log_event_failed",APP_ERROR_EVENT=INTERNAL_EVENT_PREFIX+"app_error",APP_METRICS_PAGE_LOAD_EVENT=INTERNAL_EVENT_PREFIX+"app_metrics::page_load_time",APP_METRICS_DOM_INTERACTIVE_EVENT=INTERNAL_EVENT_PREFIX+"app_metrics::dom_interactive_time",APP_METRICS_SCROLL_DEPTH_EVENT=INTERNAL_EVENT_PREFIX+"app_metrics::scroll_depth",APP_METRICS_SESSION_LENGTH_EVENT=INTERNAL_EVENT_PREFIX+"app_metrics::time_on_page_ms",DIAGNOSTICS_EVENT=INTERNAL_EVENT_PREFIX+"diagnostics",DEFAULT_VALUE_WARNING=INTERNAL_EVENT_PREFIX+"default_value_type_mismatch",MS_RETRY_LOGS_CUTOFF=432e6,MAX_BATCHES_TO_RETRY=100,MAX_FAILED_EVENTS=1e3,MAX_LOCAL_STORAGE_SIZE=1024*MAX_FAILED_EVENTS,MAX_ERRORS_TO_LOG=10,StatsigLogger=function(){function StatsigLogger(sdkInternal){this.failedLogEventCount=0,this.sdkInternal=sdkInternal,this.queue=[],this.flushInterval=null,this.loggedErrors=new Set,this.failedLogEvents=[],this.exposureDedupeKeys={},this.failedLogEventCount=0,this.init()}return StatsigLogger.prototype.init=function(){var _this=this;"undefined"!=typeof window&&"function"==typeof window.addEventListener&&(window.addEventListener("blur",(function(){return _this.flush(!0)})),window.addEventListener("beforeunload",(function(){return _this.flush(!0)})),window.addEventListener("load",(function(){setTimeout((function(){return _this.flush()}),100),setTimeout((function(){return _this.flush()}),1e3)}))),"undefined"!=typeof document&&"function"==typeof document.addEventListener&&document.addEventListener("visibilitychange",(function(){_this.flush("visible"!==document.visibilityState)})),(this.sdkInternal.getOptions().getIgnoreWindowUndefined()||"undefined"!=typeof window&&null!=window)&&(this.sdkInternal.getOptions().getLocalModeEnabled()||(this.flushInterval=setInterval((function(){_this.flush()}),this.sdkInternal.getOptions().getLoggingIntervalMillis()),setTimeout((function(){return _this.flush()}),100),setTimeout((function(){return _this.flush()}),1e3)))},StatsigLogger.prototype.log=function(event){if(!this.sdkInternal.getOptions().isAllLoggingDisabled()){try{if(!this.sdkInternal.getOptions().getDisableCurrentPageLogging()&&"undefined"!=typeof window&&null!=window&&"object"==typeof window.location&&"string"==typeof window.location.href){var parts=window.location.href.split(/[?#]/);(null==parts?void 0:parts.length)>0&&event.addStatsigMetadata("currentPage",parts[0])}}catch(_a){}this.queue.push(event.toJsonObject()),this.queue.length>=this.sdkInternal.getOptions().getLoggingBufferMaxSize()&&this.flush()}},StatsigLogger.prototype.resetDedupeKeys=function(){this.exposureDedupeKeys={}},StatsigLogger.prototype.shouldLogExposure=function(key){var lastTime=this.exposureDedupeKeys[key],now=Date.now();return!(null!=lastTime&&lastTime>=now-6e5||(this.exposureDedupeKeys[key]=now,0))},StatsigLogger.prototype.logGateExposure=function(user,gateName,gateValue,ruleID,secondaryExposures,details,isManualExposure){var dedupeKey=gateName+String(gateValue)+ruleID+details.reason;if(this.shouldLogExposure(dedupeKey)){var metadata={gate:gateName,gateValue:String(gateValue),ruleID:ruleID,reason:details.reason,time:details.time};isManualExposure&&(metadata.isManualExposure="true");var gateExposure=new LogEvent_1.default(GATE_EXPOSURE_EVENT);gateExposure.setUser(user),gateExposure.setMetadata(metadata),gateExposure.setSecondaryExposures(secondaryExposures),this.log(gateExposure)}},StatsigLogger.prototype.logConfigExposure=function(user,configName,ruleID,secondaryExposures,details,isManualExposure){var dedupeKey=configName+ruleID+details.reason;if(this.shouldLogExposure(dedupeKey)){var metadata={config:configName,ruleID:ruleID,reason:details.reason,time:details.time};isManualExposure&&(metadata.isManualExposure="true");var configExposure=new LogEvent_1.default(CONFIG_EXPOSURE_EVENT);configExposure.setUser(user),configExposure.setMetadata(metadata),configExposure.setSecondaryExposures(secondaryExposures),this.log(configExposure)}},StatsigLogger.prototype.logLayerExposure=function(user,configName,ruleID,secondaryExposures,allocatedExperiment,parameterName,isExplicitParameter,details,isManualExposure){var dedupeKey=[configName,ruleID,allocatedExperiment,parameterName,String(isExplicitParameter),details.reason].join("|");if(this.shouldLogExposure(dedupeKey)){var metadata={config:configName,ruleID:ruleID,allocatedExperiment:allocatedExperiment,parameterName:parameterName,isExplicitParameter:String(isExplicitParameter),reason:details.reason,time:details.time};isManualExposure&&(metadata.isManualExposure="true");var configExposure=new LogEvent_1.default(LAYER_EXPOSURE_EVENT);configExposure.setUser(user),configExposure.setMetadata(metadata),configExposure.setSecondaryExposures(secondaryExposures),this.log(configExposure)}},StatsigLogger.prototype.logConfigDefaultValueFallback=function(user,message,metadata){this.logGenericEvent(DEFAULT_VALUE_WARNING,user,message,metadata),this.loggedErrors.add(message),this.sdkInternal.getConsoleLogger().error(message)},StatsigLogger.prototype.logAppError=function(user,message,metadata){var trimmedMessage=message.substring(0,128);this.loggedErrors.has(trimmedMessage)||this.loggedErrors.size>MAX_ERRORS_TO_LOG||(this.logGenericEvent(APP_ERROR_EVENT,user,trimmedMessage,metadata),this.loggedErrors.add(trimmedMessage))},StatsigLogger.prototype.logDiagnostics=function(user,context){if(!Diagnostics_1.default.disabled){var markers=Diagnostics_1.default.getMarkers(context);Diagnostics_1.default.clearContext(context);var event=this.makeDiagnosticsEvent(user,{markers:markers,context:context});this.log(event)}},StatsigLogger.prototype.logAppMetrics=function(user){var _a,_this=this;if("function"==typeof(null===(_a=null===window||void 0===window?void 0:window.performance)||void 0===_a?void 0:_a.getEntriesByType)){var entries=window.performance.getEntriesByType("navigation");if(entries&&!(entries.length<1)){var navEntry=entries[0],metadata={url:navEntry.name};if(navEntry instanceof PerformanceNavigationTiming&&(this.logGenericEvent(APP_METRICS_PAGE_LOAD_EVENT,user,navEntry.duration,metadata),this.logGenericEvent(APP_METRICS_DOM_INTERACTIVE_EVENT,user,navEntry.domInteractive-navEntry.startTime,metadata)),"function"==typeof(null===window||void 0===window?void 0:window.addEventListener)&&(null===document||void 0===document?void 0:document.body)){var deepestScroll_1=0;window.addEventListener("scroll",(function(){var scrollHeight=document.body.scrollHeight||1,scrollDepth=Math.min(100,Math.round((window.scrollY+window.innerHeight)/scrollHeight*100));scrollDepth>deepestScroll_1&&(deepestScroll_1=scrollDepth)})),window.addEventListener("beforeunload",(function(){_this.logGenericEvent(APP_METRICS_SCROLL_DEPTH_EVENT,user,deepestScroll_1,metadata),_this.logGenericEvent(APP_METRICS_SESSION_LENGTH_EVENT,user,window.performance.now(),metadata)}))}}}},StatsigLogger.prototype.logGenericEvent=function(eventName,user,value,metadata){var evt=new LogEvent_1.default(eventName);return evt.setUser(user),evt.setValue(value),evt.setMetadata(metadata),this.log(evt),evt},StatsigLogger.prototype.shutdown=function(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null),this.flush(!0)},StatsigLogger.prototype.flush=function(isClosing){var _this=this;if(void 0===isClosing&&(isClosing=!1),this.addErrorBoundaryDiagnostics(),0!==this.queue.length){var oldQueue=this.queue;if(this.queue=[],!isClosing||this.sdkInternal.getNetwork().supportsKeepalive()||"undefined"==typeof navigator||null==(null===navigator||void 0===navigator?void 0:navigator.sendBeacon))this.sdkInternal.getNetwork().postToEndpoint(StatsigNetwork_1.StatsigEndpoint.Rgstr,{events:oldQueue,statsigMetadata:this.sdkInternal.getStatsigMetadata()},{retryOptions:{retryLimit:3,backoff:1e3},useKeepalive:isClosing}).then((function(response){if(!response.ok)throw response})).catch((function(error){"function"==typeof error.text?error.text().then((function(errorText){_this.sdkInternal.getErrorBoundary().logError(LOG_FAILURE_EVENT,error,(function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,{eventCount:oldQueue.length,error:errorText}]}))}))}))})):_this.sdkInternal.getErrorBoundary().logError(LOG_FAILURE_EVENT,error,(function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,{eventCount:oldQueue.length,error:error.message}]}))}))})),_this.newFailedRequest(LOG_FAILURE_EVENT,oldQueue)})).finally((function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return isClosing&&(this.queue.length>0&&(this.addFailedRequest({events:this.queue,statsigMetadata:this.sdkInternal.getStatsigMetadata(),time:Date.now()}),this.queue=[]),this.saveFailedRequests()),[2]}))}))}));else this.sdkInternal.getNetwork().sendLogBeacon({events:oldQueue,statsigMetadata:this.sdkInternal.getStatsigMetadata()})||(this.queue=oldQueue.concat(this.queue),this.queue.length>0&&(this.addFailedRequest({events:this.queue,statsigMetadata:this.sdkInternal.getStatsigMetadata(),time:Date.now()}),this.queue=[]),this.saveFailedRequests())}},StatsigLogger.prototype.saveFailedRequests=function(){var _this=this;if(this.failedLogEvents.length>0){var requestsCopy=JSON.stringify(this.failedLogEvents);if(requestsCopy.length>MAX_LOCAL_STORAGE_SIZE)return void this.clearLocalStorageRequests();if(StatsigAsyncStorage_1.default.asyncStorage)return void StatsigAsyncStorage_1.default.setItemAsync(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY,requestsCopy).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("saveFailedRequests",reason)}));StatsigLocalStorage_1.default.setItem(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY,requestsCopy)}},StatsigLogger.prototype.sendSavedRequests=function(){return __awaiter(this,void 0,void 0,(function(){var failedRequests,fireAndForget,requestBodies,_loop_1,this_1,_i,requestBodies_1,requestBody,_this=this;return __generator(this,(function(_a){switch(_a.label){case 0:return fireAndForget=!1,StatsigAsyncStorage_1.default.asyncStorage?[4,StatsigAsyncStorage_1.default.getItemAsync(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY)]:[3,2];case 1:return failedRequests=_a.sent(),[3,3];case 2:failedRequests=StatsigLocalStorage_1.default.getItem(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY),_a.label=3;case 3:if(null==failedRequests)return this.clearLocalStorageRequests(),[2];failedRequests.length>MAX_LOCAL_STORAGE_SIZE&&(fireAndForget=!0),requestBodies=[];try{for(requestBodies=JSON.parse(failedRequests),_loop_1=function(requestBody){null!=requestBody&&requestBody.events&&Array.isArray(requestBody.events)&&this_1.sdkInternal.getNetwork().postToEndpoint(StatsigNetwork_1.StatsigEndpoint.Rgstr,requestBody).then((function(response){if(!response.ok)throw Error(response.status+"")})).catch((function(){fireAndForget||_this.addFailedRequest(requestBody)}))},this_1=this,_i=0,requestBodies_1=requestBodies;_i<requestBodies_1.length;_i++)requestBody=requestBodies_1[_i],_loop_1(requestBody)}catch(e){this.sdkInternal.getErrorBoundary().logError("sendSavedRequests",e)}finally{this.clearLocalStorageRequests()}return[2]}}))}))},StatsigLogger.prototype.addFailedRequest=function(requestBody){if(!(requestBody.time<Date.now()-MS_RETRY_LOGS_CUTOFF||this.failedLogEvents.length>MAX_BATCHES_TO_RETRY)){var additionalEvents=requestBody.events.length;this.failedLogEventCount+additionalEvents>MAX_FAILED_EVENTS||(this.failedLogEvents.push(requestBody),this.failedLogEventCount+=additionalEvents)}},StatsigLogger.prototype.clearLocalStorageRequests=function(){var _this=this;StatsigAsyncStorage_1.default.asyncStorage?StatsigAsyncStorage_1.default.removeItemAsync(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("clearLocalStorageRequests",reason)})):StatsigLocalStorage_1.default.removeItem(Constants_1.STATSIG_LOCAL_STORAGE_LOGGING_REQUEST_KEY)},StatsigLogger.prototype.newFailedRequest=function(name,queue){this.loggedErrors.has(name)||(this.loggedErrors.add(name),this.failedLogEvents.push({events:queue,statsigMetadata:this.sdkInternal.getStatsigMetadata(),time:Date.now()}),this.saveFailedRequests())},StatsigLogger.prototype.makeDiagnosticsEvent=function(user,data){var latencyEvent=new LogEvent_1.default(DIAGNOSTICS_EVENT);return latencyEvent.setUser(user),latencyEvent.setMetadata(data),latencyEvent},StatsigLogger.prototype.addErrorBoundaryDiagnostics=function(){if(0!==Diagnostics_1.default.getMarkerCount("api_call")){var diagEvent=this.makeDiagnosticsEvent(this.sdkInternal.getCurrentUser(),{context:"api_call",markers:Diagnostics_1.default.getMarkers("api_call")});this.queue.push(diagEvent),Diagnostics_1.default.clearContext("api_call")}},StatsigLogger}();exports.default=StatsigLogger;