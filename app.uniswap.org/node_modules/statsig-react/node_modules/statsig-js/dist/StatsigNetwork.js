"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.StatsigEndpoint=void 0;var StatsigEndpoint,StatsigRuntime_1=__importDefault(require("./StatsigRuntime")),Diagnostics_1=__importDefault(require("./utils/Diagnostics"));!function(StatsigEndpoint){StatsigEndpoint.Initialize="initialize",StatsigEndpoint.Rgstr="rgstr",StatsigEndpoint.LogEventBeacon="log_event_beacon"}(StatsigEndpoint=exports.StatsigEndpoint||(exports.StatsigEndpoint={}));var NO_CONTENT=204,StatsigNetwork=function(){function StatsigNetwork(sdkInternal){this.retryCodes={408:!0,500:!0,502:!0,503:!0,504:!0,522:!0,524:!0,599:!0},this.canUseKeepalive=!1,this.sdkInternal=sdkInternal,this.leakyBucket={},this.init()}return StatsigNetwork.prototype.init=function(){if(!this.sdkInternal.getOptions().getDisableNetworkKeepalive())try{this.canUseKeepalive="keepalive"in new Request("")}catch(_e){this.canUseKeepalive=!1}},StatsigNetwork.prototype.fetchValues=function(args){var user=args.user,sinceTime=args.sinceTime,timeout=args.timeout,useDeltas=args.useDeltas,prefetchUsers=args.prefetchUsers,previousDerivedFields=args.previousDerivedFields,hadBadDeltaChecksum=args.hadBadDeltaChecksum,badChecksum=args.badChecksum,input={user:user,prefetchUsers:prefetchUsers,statsigMetadata:this.sdkInternal.getStatsigMetadata(),sinceTime:null!=sinceTime?sinceTime:void 0,canProcessDeltas:useDeltas,hash:"djb2",previousDerivedFields:previousDerivedFields,hadBadDeltaChecksum:hadBadDeltaChecksum,badChecksum:badChecksum};return this.postWithTimeout(StatsigEndpoint.Initialize,input,{timeout:timeout,retries:3,diagnostics:Diagnostics_1.default.mark.intialize.networkRequest})},StatsigNetwork.prototype.postWithTimeout=function(endpointName,body,options){var res,_this=this,_a=null!=options?options:{},_b=_a.timeout,timeout=void 0===_b?0:_b,_c=_a.retries,retries=void 0===_c?0:_c,_d=_a.backoff,backoff=void 0===_d?1e3:_d,_f=_a.diagnostics,diagnostics=void 0===_f?null:_f,hasTimedOut=!1,timer=null,cachedReturnValue=null,eventuals=[];0!=timeout&&(timer=new Promise((function(resolve,reject){setTimeout((function(){hasTimedOut=!0,reject(new Error("The initialization timeout of "+timeout+"ms has been hit before the network request has completed."))}),timeout)})));var boundScope,fetchPromise=this.postToEndpoint(endpointName,body,{retryOptions:{retryLimit:retries,backoff:backoff},diagnostics:diagnostics}).then((function(localRes){if(!(res=localRes).ok)return Promise.reject(new Error("Request to "+endpointName+" failed with status "+res.status));if("object"!=typeof res.data){var error=new Error("Request to "+endpointName+" received invalid response type. Expected 'object' but got '"+typeof res.data+"'");return _this.sdkInternal.getErrorBoundary().logError("postWithTimeoutInvalidRes",error,(function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.getErrorData(endpointName,body,retries,backoff,res)]}))}))})),Promise.reject(error)}var json=res.data;return _this.sdkInternal.getErrorBoundary().capture("postWithTimeout",(function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return cachedReturnValue=json,hasTimedOut&&(eventuals.forEach((function(fn){return fn(json)})),eventuals=[]),[2,Promise.resolve(json)]}))}))}),(function(){return Promise.resolve({})}),{getExtraData:function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return[2,this.getErrorData(endpointName,body,retries,backoff,res)]}))}))}})})).catch((function(e){return Promise.reject(e)})),racingPromise=timer?Promise.race([fetchPromise,timer]):fetchPromise;return racingPromise.eventually=(boundScope=racingPromise,function(fn){return hasTimedOut&&cachedReturnValue?fn(cachedReturnValue):eventuals.push(fn),boundScope}),racingPromise},StatsigNetwork.prototype.sendLogBeacon=function(payload){var statsigOpts=this.sdkInternal.getOptions();if(statsigOpts.getLocalModeEnabled())return!0;var url=new URL(statsigOpts.getEventLoggingApi()+StatsigEndpoint.LogEventBeacon);url.searchParams.append("k",this.sdkInternal.getSDKKey()),payload.clientTime=Date.now()+"";var stringPayload=null;try{stringPayload=JSON.stringify(payload)}catch(_e){return!1}return navigator.sendBeacon(url.toString(),stringPayload)},StatsigNetwork.prototype.postToEndpoint=function(endpointName,body,options){var _a;return __awaiter(this,void 0,void 0,(function(){var _b,_c,useKeepalive,_d,diagnostics,_f,_g,retryLimit,_h,attempt,_j,backoff,statsigOpts,api,url,counter,shouldEncode,postBody,encoded,params,res,isRetryCode,_this=this;return __generator(this,(function(_k){if(_c=(_b=null!=options?options:{}).useKeepalive,useKeepalive=void 0!==_c&&_c,_d=_b.diagnostics,diagnostics=void 0===_d?null:_d,_f=null!==(_a=null==options?void 0:options.retryOptions)&&void 0!==_a?_a:{},_g=_f.retryLimit,retryLimit=void 0===_g?0:_g,_h=_f.attempt,attempt=void 0===_h?1:_h,_j=_f.backoff,backoff=void 0===_j?1e3:_j,(statsigOpts=this.sdkInternal.getOptions()).getLocalModeEnabled())return[2,Promise.reject("no network requests in localMode")];if("function"!=typeof fetch)return[2,Promise.reject("fetch is not defined")];if("undefined"==typeof window&&!statsigOpts.getIgnoreWindowUndefined())return[2,Promise.reject("window is not defined")];if(api=[StatsigEndpoint.Initialize].includes(endpointName)?statsigOpts.getApi():statsigOpts.getEventLoggingApi(),url=api+endpointName,null!=(counter=this.leakyBucket[url])&&counter>=30)return[2,Promise.reject(new Error("Request failed because you are making the same request too frequently."))];if(this.leakyBucket[url]=null==counter?1:counter+1,shouldEncode=endpointName===StatsigEndpoint.Initialize&&StatsigRuntime_1.default.encodeInitializeCall&&"undefined"!=typeof window&&"function"==typeof(null===window||void 0===window?void 0:window.btoa),postBody=JSON.stringify(body),shouldEncode)try{encoded=window.btoa(postBody).split("").reverse().join(""),postBody=encoded}catch(_e){shouldEncode=!1}return params={method:"POST",body:postBody,headers:{"Content-type":"application/json; charset=UTF-8","STATSIG-API-KEY":this.sdkInternal.getSDKKey(),"STATSIG-CLIENT-TIME":Date.now()+"","STATSIG-SDK-TYPE":this.sdkInternal.getSDKType(),"STATSIG-SDK-VERSION":this.sdkInternal.getSDKVersion(),"STATSIG-ENCODED":shouldEncode?"1":"0"}},this.canUseKeepalive&&useKeepalive&&(params.keepalive=!0),null==diagnostics||diagnostics.start({attempt:attempt}),isRetryCode=!0,[2,fetch(url,params).then((function(localRes){return __awaiter(_this,void 0,void 0,(function(){var networkResponse,text,errorText;return __generator(this,(function(_a){switch(_a.label){case 0:return(res=localRes).ok?(networkResponse=res,res.status!==NO_CONTENT?[3,1]:(networkResponse.data={has_updates:!1,is_no_content:!0},[3,3])):[3,4];case 1:return[4,res.text()];case 2:text=_a.sent(),networkResponse.data=JSON.parse(text),_a.label=3;case 3:return null==diagnostics||diagnostics.end(this.getDiagnosticsData(res,attempt)),[2,Promise.resolve(networkResponse)];case 4:return this.retryCodes[res.status]||(isRetryCode=!1),[4,res.text()];case 5:return errorText=_a.sent(),[2,Promise.reject(new Error(res.status+": "+errorText))]}}))}))})).catch((function(e){return null==diagnostics||diagnostics.end(_this.getDiagnosticsData(res,attempt,e)),attempt<retryLimit&&isRetryCode?new Promise((function(resolve,reject){setTimeout((function(){_this.leakyBucket[url]=Math.max(_this.leakyBucket[url]-1,0),_this.postToEndpoint(endpointName,body,{retryOptions:{retryLimit:retryLimit,attempt:attempt+1,backoff:2*backoff},useKeepalive:useKeepalive,diagnostics:diagnostics}).then(resolve).catch(reject)}),backoff)})):Promise.reject(e)})).finally((function(){_this.leakyBucket[url]=Math.max(_this.leakyBucket[url]-1,0)}))]}))}))},StatsigNetwork.prototype.supportsKeepalive=function(){return this.canUseKeepalive},StatsigNetwork.prototype.getDiagnosticsData=function(res,attempt,e){var _a,_b;return{success:!0===(null==res?void 0:res.ok),statusCode:null==res?void 0:res.status,sdkRegion:null===(_a=null==res?void 0:res.headers)||void 0===_a?void 0:_a.get("x-statsig-region"),isDelta:!0===(null===(_b=null==res?void 0:res.data)||void 0===_b?void 0:_b.is_delta),attempt:attempt,error:Diagnostics_1.default.formatError(e)}},StatsigNetwork.prototype.getErrorData=function(endpointName,body,retries,backoff,res){var _a;return __awaiter(this,void 0,void 0,(function(){var headers_1;return __generator(this,(function(_b){try{return headers_1={},(null!==(_a=res.headers)&&void 0!==_a?_a:[]).forEach((function(value,key){headers_1[key]=value})),[2,{responseInfo:{headers:headers_1,status:res.status,statusText:res.statusText,type:res.type,url:res.url,redirected:res.redirected,bodySnippet:res.data?JSON.stringify(res.data).slice(0,500):null},requestInfo:{endpointName:endpointName,bodySnippet:JSON.stringify(body).slice(0,500),retries:retries,backoff:backoff}}]}catch(_e){return[2,{statusText:"statsig::failed to extract extra data"}]}return[2]}))}))},StatsigNetwork}();exports.default=StatsigNetwork;