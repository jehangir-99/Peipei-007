"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var DynamicConfig_1=__importDefault(require("./DynamicConfig")),Layer_1=__importDefault(require("./Layer")),BootstrapValidator_1=__importDefault(require("./utils/BootstrapValidator")),Constants_1=require("./utils/Constants"),Hashing_1=require("./utils/Hashing"),StatsigAsyncStorage_1=__importDefault(require("./utils/StatsigAsyncStorage")),StatsigLocalStorage_1=__importDefault(require("./utils/StatsigLocalStorage")),EvaluationReason_1=require("./utils/EvaluationReason"),MAX_USER_VALUE_CACHED=10,StatsigStore=function(){function StatsigStore(sdkInternal,initializeValues){this.overrides={gates:{},configs:{},layers:{}},this.sdkInternal=sdkInternal,this.userCacheKey=this.sdkInternal.getCurrentUserCacheKey(),this.values={},this.userValues={feature_gates:{},dynamic_configs:{},sticky_experiments:{},layer_configs:{},has_updates:!1,time:0,evaluation_time:0,derived_fields:{}},this.stickyDeviceExperiments={},this.loaded=!1,this.reason=EvaluationReason_1.EvaluationReason.Uninitialized,this.userPersistentStorageAdapter=this.sdkInternal.getOptions().getUserPersistentStorage(),this.userPersistentStorageData={experiments:{}},initializeValues?this.bootstrap(initializeValues):this.load()}return StatsigStore.prototype.load=function(){this.loadFromLocalStorage(),this.partialLoadFromPersistentStorageAdapter()},StatsigStore.prototype.loadAsync=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return[4,this.loadFromAsyncStorage()];case 1:return _a.sent(),this.partialLoadFromPersistentStorageAdapter(),[2]}}))}))},StatsigStore.prototype.updateUser=function(isUserPrefetched){this.userCacheKey=this.sdkInternal.getCurrentUserCacheKey();var evaluationTime=this.setUserValueFromCache(isUserPrefetched);return this.partialLoadFromPersistentStorageAdapter(),evaluationTime},StatsigStore.prototype.loadFromAsyncStorage=function(){return __awaiter(this,void 0,void 0,(function(){var _a,_b;return __generator(this,(function(_c){switch(_c.label){case 0:return _a=this.parseCachedValues,[4,StatsigAsyncStorage_1.default.getItemAsync(Constants_1.INTERNAL_STORE_KEY)];case 1:return _b=[_c.sent()],[4,StatsigAsyncStorage_1.default.getItemAsync(Constants_1.STICKY_DEVICE_EXPERIMENTS_KEY)];case 2:return _a.apply(this,_b.concat([_c.sent()])),this.userCacheKey=this.sdkInternal.getCurrentUserCacheKey(),this.loaded=!0,[2]}}))}))},StatsigStore.prototype.bootstrap=function(initializeValues){var _a,_b,_c,_d,_f,_g,key=this.sdkInternal.getCurrentUserCacheKey(),user=this.sdkInternal.getCurrentUser(),stableID=null!==(_c=null!==(_b=null===(_a=null==user?void 0:user.customIDs)||void 0===_a?void 0:_a.stableID)&&void 0!==_b?_b:this.sdkInternal.getStatsigMetadata().stableID)&&void 0!==_c?_c:null,reason=BootstrapValidator_1.default.getEvaluationReasonForBootstrap(user,initializeValues,stableID);this.loaded=!0;try{var values=initializeValues;this.userValues.feature_gates=null!==(_d=values.feature_gates)&&void 0!==_d?_d:{},this.userValues.dynamic_configs=null!==(_f=values.dynamic_configs)&&void 0!==_f?_f:{},this.userValues.layer_configs=null!==(_g=values.layer_configs)&&void 0!==_g?_g:{},this.userValues.evaluation_time=Date.now(),this.userValues.time=Date.now(),this.userValues.hash_used=values.hash_used,this.values[key.v2]=this.userValues,this.reason=reason,this.loadOverrides()}catch(_e){return}},StatsigStore.prototype.loadFromLocalStorage=function(){StatsigAsyncStorage_1.default.asyncStorage||(this.parseCachedValues(StatsigLocalStorage_1.default.getItem(Constants_1.INTERNAL_STORE_KEY),StatsigLocalStorage_1.default.getItem(Constants_1.STICKY_DEVICE_EXPERIMENTS_KEY)),this.loaded=!0)},StatsigStore.prototype.partialLoadFromPersistentStorageAdapter=function(){var _a;if(this.userPersistentStorageAdapter){var idType=null!==(_a=this.userPersistentStorageAdapter.userIDType)&&void 0!==_a?_a:"userID",unitID=this.sdkInternal.getCurrentUserUnitID(idType);if(unitID){try{this.userPersistentStorageData=JSON.parse(this.userPersistentStorageAdapter.load(unitID+":"+idType))}catch(e){console.warn("Failed to load from user persistent storage.",e)}this.userValues.sticky_experiments=this.userPersistentStorageData.experiments}}},StatsigStore.prototype.saveStickyExperimentsToPersistentStorageAdapter=function(){var _a;if(this.userPersistentStorageAdapter){var idType=null!==(_a=this.userPersistentStorageAdapter.userIDType)&&void 0!==_a?_a:"userID",unitID=this.sdkInternal.getCurrentUserUnitID(idType);if(unitID){var data=__assign(__assign({},this.userPersistentStorageData),{experiments:this.userValues.sticky_experiments});try{this.userPersistentStorageAdapter.save(unitID+":"+idType,JSON.stringify(data))}catch(e){console.warn("Failed to save user experiment values to persistent storage.",e)}}}},StatsigStore.prototype.isLoaded=function(){return this.loaded},StatsigStore.prototype.getLastUpdateTime=function(user){var userHash=(0,Hashing_1.djb2HashForObject)(user);return this.userValues.user_hash==userHash?this.userValues.time:null},StatsigStore.prototype.getPreviousDerivedFields=function(user){var userHash=(0,Hashing_1.djb2HashForObject)(user);if(this.userValues.user_hash==userHash)return this.userValues.derived_fields},StatsigStore.prototype.parseCachedValues=function(allValues,deviceExperiments){try{this.values=allValues?JSON.parse(allValues):this.values,this.setUserValueFromCache()}catch(e){this.removeFromStorage(Constants_1.INTERNAL_STORE_KEY)}try{var deviceExpParsed=deviceExperiments?JSON.parse(deviceExperiments):null;deviceExpParsed&&(this.stickyDeviceExperiments=deviceExpParsed)}catch(e){this.removeFromStorage(Constants_1.STICKY_DEVICE_EXPERIMENTS_KEY)}this.loadOverrides()},StatsigStore.prototype.getUserValues=function(key){var _a;return null!==(_a=this.values[key.v2])&&void 0!==_a?_a:this.values[key.v1]},StatsigStore.prototype.setUserValueFromCache=function(isUserPrefetched){var _a;void 0===isUserPrefetched&&(isUserPrefetched=!1);var cachedValues=this.getUserValues(this.userCacheKey);return null==cachedValues?(this.resetUserValues(),this.reason=EvaluationReason_1.EvaluationReason.Uninitialized,null):(this.userValues=cachedValues,this.reason=isUserPrefetched?EvaluationReason_1.EvaluationReason.Prefetch:EvaluationReason_1.EvaluationReason.Cache,null!==(_a=cachedValues.evaluation_time)&&void 0!==_a?_a:0)},StatsigStore.prototype.removeFromStorage=function(key){var _this=this;StatsigAsyncStorage_1.default.removeItemAsync(key).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("removeFromStorage",reason)})),StatsigLocalStorage_1.default.removeItem(key)},StatsigStore.prototype.loadOverrides=function(){if(!this.sdkInternal.getOptions().getDisableLocalOverrides()){var overrides=StatsigLocalStorage_1.default.getItem(Constants_1.OVERRIDES_STORE_KEY);if(null!=overrides)try{this.overrides=JSON.parse(overrides)}catch(e){StatsigLocalStorage_1.default.removeItem(Constants_1.OVERRIDES_STORE_KEY)}}},StatsigStore.prototype.setEvaluationReason=function(evalReason){this.reason=evalReason},StatsigStore.prototype.save=function(user,response,prefetchUsers){return __awaiter(this,void 0,void 0,(function(){var requestedUserCacheKey,initResponse,userValues,_a;return __generator(this,(function(_b){switch(_b.label){case 0:return requestedUserCacheKey=(0,Hashing_1.getUserCacheKey)(this.getStableID(),user),(initResponse=response).is_delta?[2,this.saveInitDeltas(user,response,!0,prefetchUsers)]:(this.mergeInitializeResponseIntoUserMap(initResponse,this.values,requestedUserCacheKey,user,(function(userValues){return userValues}),prefetchUsers),(userValues=this.getUserValues(requestedUserCacheKey))&&requestedUserCacheKey&&requestedUserCacheKey.v2===this.userCacheKey.v2&&(this.userValues=userValues,this.reason=EvaluationReason_1.EvaluationReason.Network),_a=this,[4,this.writeValuesToStorage(this.values)]);case 1:return _a.values=_b.sent(),[2]}}))}))},StatsigStore.prototype.saveWithoutUpdatingClientState=function(user,response,prefetchUsers){return __awaiter(this,void 0,void 0,(function(){var requestedUserCacheKey,initResponse,copiedValues;return __generator(this,(function(_a){switch(_a.label){case 0:return requestedUserCacheKey=(0,Hashing_1.getUserCacheKey)(this.getStableID(),user),(initResponse=response).is_delta?[2,this.saveInitDeltas(user,response,!1,prefetchUsers)]:(copiedValues=JSON.parse(JSON.stringify(this.values)),this.mergeInitializeResponseIntoUserMap(initResponse,copiedValues,requestedUserCacheKey,user,(function(userValues){return userValues}),prefetchUsers),[4,this.writeValuesToStorage(copiedValues)]);case 1:return _a.sent(),[2]}}))}))},StatsigStore.prototype.saveInitDeltas=function(user,response,updateState,prefetchUsers){var _a,_b;return __awaiter(this,void 0,void 0,(function(){var requestedUserCacheKey,initResponse,mergedValues,hasBadHash,badChecksum,hashChanged,userValues,expectedFullHash,currentFullHash,_c,_this=this;return __generator(this,(function(_d){switch(_d.label){case 0:return requestedUserCacheKey=(0,Hashing_1.getUserCacheKey)(this.getStableID(),user),initResponse=response,mergedValues=JSON.parse(JSON.stringify(this.values)),this.mergeInitializeResponseIntoUserMap(initResponse,mergedValues,requestedUserCacheKey,user,(function(deltas,key){var _a,baseValues=null!==(_a=mergedValues[key])&&void 0!==_a?_a:_this.getDefaultUserCacheValues();return _this.mergeUserCacheValues(baseValues,deltas)}),prefetchUsers),hasBadHash=!1,badChecksum=void 0,hashChanged=!1,Object.keys(null!==(_a=initResponse.prefetched_user_values)&&void 0!==_a?_a:{}).forEach((function(userKey){var _a,user=mergedValues[userKey],reponseForUser=null===(_a=initResponse.prefetched_user_values)||void 0===_a?void 0:_a[userKey];if(user&&reponseForUser){removeDeletedKeysFromUserValues(reponseForUser,user);var expectedFullHash_1=reponseForUser.checksum,currentFullHash_1=(0,Hashing_1.djb2HashForObject)({feature_gates:mergedValues[userKey].feature_gates,dynamic_configs:mergedValues[userKey].dynamic_configs,layer_configs:mergedValues[userKey].layer_configs});expectedFullHash_1&&expectedFullHash_1!==currentFullHash_1&&(hasBadHash=!0,badChecksum=currentFullHash_1),userValues.hash_used!==initResponse.hash_used&&(hashChanged=!0)}})),userValues=null!==(_b=mergedValues[requestedUserCacheKey.v2])&&void 0!==_b?_b:mergedValues[requestedUserCacheKey.v1],removeDeletedKeysFromUserValues(initResponse,userValues),expectedFullHash=initResponse.checksum,currentFullHash=(0,Hashing_1.djb2HashForObject)({feature_gates:userValues.feature_gates,dynamic_configs:userValues.dynamic_configs,layer_configs:userValues.layer_configs}),expectedFullHash&&expectedFullHash!==currentFullHash&&(hasBadHash=!0,badChecksum=currentFullHash),userValues.hash_used!==initResponse.hash_used&&(hashChanged=!0),hasBadHash||hashChanged?(this.refetchAndSaveValues(user,prefetchUsers,void 0,badChecksum,hasBadHash).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("refetchAndSaveValues",reason)})),[2]):updateState?(userValues&&requestedUserCacheKey.v2===this.userCacheKey.v2&&(this.userValues=userValues,this.reason=EvaluationReason_1.EvaluationReason.Network),_c=this,[4,this.writeValuesToStorage(mergedValues)]):[3,2];case 1:return _c.values=_d.sent(),[3,4];case 2:return[4,this.writeValuesToStorage(mergedValues)];case 3:_d.sent(),_d.label=4;case 4:return[2]}}))}))},StatsigStore.prototype.refetchAndSaveValues=function(user,prefetchUsers,timeout,badChecksum,hadBadChecksum){return void 0===timeout&&(timeout=this.sdkInternal.getOptions().getInitTimeoutMs()),__awaiter(this,void 0,void 0,(function(){var sinceTime,previousDerivedFields,_this=this;return __generator(this,(function(_a){return sinceTime=this.getLastUpdateTime(user),previousDerivedFields=this.getPreviousDerivedFields(user),[2,this.sdkInternal.getNetwork().fetchValues({user:user,sinceTime:sinceTime,timeout:timeout,useDeltas:!1,prefetchUsers:prefetchUsers,previousDerivedFields:previousDerivedFields,hadBadDeltaChecksum:hadBadChecksum,badChecksum:badChecksum}).then((function(json){(null==json?void 0:json.has_updates)&&_this.saveWithoutUpdatingClientState(user,json,prefetchUsers).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("refetchAndSaveValues:then",reason)}))})).catch((function(reason){return _this.sdkInternal.getErrorBoundary().logError("refetchAndSaveValues",reason)}))]}))}))},StatsigStore.prototype.getStableID=function(){return this.sdkInternal.getStableID()},StatsigStore.prototype.mergeInitializeResponseIntoUserMap=function(data,configMap,requestedUserCacheKey,user,mergeFn,prefetchUsers){if(data.prefetched_user_values)for(var _i=0,cacheKeys_1=Object.keys(data.prefetched_user_values);_i<cacheKeys_1.length;_i++){var key=cacheKeys_1[_i],prefetched=data.prefetched_user_values[key],values=mergeFn(this.convertAPIDataToCacheValues(prefetched,key),key);if(data.has_updates&&data.time&&prefetchUsers){var userHash=(0,Hashing_1.djb2HashForObject)(prefetchUsers[key]);values.user_hash=userHash}configMap[key]=values}if(requestedUserCacheKey){var requestedUserValues=this.convertAPIDataToCacheValues(data,requestedUserCacheKey.v2);if(data.has_updates&&data.time){userHash=(0,Hashing_1.djb2HashForObject)(user);requestedUserValues.user_hash=userHash}configMap[requestedUserCacheKey.v2]=mergeFn(requestedUserValues,requestedUserCacheKey.v2)}},StatsigStore.prototype.getDefaultUserCacheValues=function(){return{feature_gates:{},layer_configs:{},dynamic_configs:{},sticky_experiments:{},time:0,evaluation_time:0,derived_fields:{}}},StatsigStore.prototype.mergeUserCacheValues=function(baseValues,valuesToMerge){return{feature_gates:__assign(__assign({},baseValues.feature_gates),valuesToMerge.feature_gates),layer_configs:__assign(__assign({},baseValues.layer_configs),valuesToMerge.layer_configs),dynamic_configs:__assign(__assign({},baseValues.dynamic_configs),valuesToMerge.dynamic_configs),sticky_experiments:baseValues.sticky_experiments,time:valuesToMerge.time,evaluation_time:valuesToMerge.evaluation_time,derived_fields:valuesToMerge.derived_fields,hash_used:valuesToMerge.hash_used,user_hash:valuesToMerge.user_hash}},StatsigStore.prototype.writeValuesToStorage=function(valuesToWrite){return __awaiter(this,void 0,void 0,(function(){var filteredValues;return __generator(this,(function(_a){switch(_a.label){case 0:return valuesToWrite[this.userCacheKey.v2]&&delete valuesToWrite[this.userCacheKey.v1],filteredValues=Object.entries(valuesToWrite).sort((function(_a,_b){var _c,_d,a=_a[1],b=_b[1];return null==a?1:null==b?-1:(null!==(_c=null==b?void 0:b.evaluation_time)&&void 0!==_c?_c:null==b?void 0:b.time)-(null!==(_d=null==a?void 0:a.evaluation_time)&&void 0!==_d?_d:null==a?void 0:a.time)})).slice(0,MAX_USER_VALUE_CACHED),valuesToWrite=Object.fromEntries(filteredValues),StatsigAsyncStorage_1.default.asyncStorage?[4,StatsigAsyncStorage_1.default.setItemAsync(Constants_1.INTERNAL_STORE_KEY,JSON.stringify(valuesToWrite))]:[3,2];case 1:return _a.sent(),[3,3];case 2:StatsigLocalStorage_1.default.setItem(Constants_1.INTERNAL_STORE_KEY,JSON.stringify(valuesToWrite)),_a.label=3;case 3:return[2,valuesToWrite]}}))}))},StatsigStore.prototype.checkGate=function(gateName,ignoreOverrides){var _a;void 0===ignoreOverrides&&(ignoreOverrides=!1);var details,gateNameHash=this.getHashedSpecName(gateName),gateValue={name:gateName,value:!1,rule_id:"",secondary_exposures:[]};if(ignoreOverrides||null==this.overrides.gates[gateName]){var value=null===(_a=this.userValues)||void 0===_a?void 0:_a.feature_gates[gateNameHash];value&&(gateValue=value),details=this.getEvaluationDetails(null!=value)}else gateValue={name:gateName,value:this.overrides.gates[gateName],rule_id:"override",secondary_exposures:[]},details=this.getEvaluationDetails(!1,EvaluationReason_1.EvaluationReason.LocalOverride);return{evaluationDetails:details,gate:gateValue}},StatsigStore.prototype.getConfig=function(configName,ignoreOverrides){var _a,_b;void 0===ignoreOverrides&&(ignoreOverrides=!1);var configValue,details,configNameHash=this.getHashedSpecName(configName);if(ignoreOverrides||null==this.overrides.configs[configName])if(null!=(null===(_a=this.userValues)||void 0===_a?void 0:_a.dynamic_configs[configNameHash])){var rawConfigValue=null===(_b=this.userValues)||void 0===_b?void 0:_b.dynamic_configs[configNameHash];details=this.getEvaluationDetails(!0),configValue=this.createDynamicConfig(configName,rawConfigValue,details)}else details=this.getEvaluationDetails(!1),configValue=new DynamicConfig_1.default(configName,{},"",details);else details=this.getEvaluationDetails(!1,EvaluationReason_1.EvaluationReason.LocalOverride),configValue=new DynamicConfig_1.default(configName,this.overrides.configs[configName],"override",details,[],"",this.makeOnConfigDefaultValueFallback(this.sdkInternal.getCurrentUser()));return configValue},StatsigStore.prototype.getExperiment=function(expName,keepDeviceValue,ignoreOverrides){var exp,details;if(void 0===keepDeviceValue&&(keepDeviceValue=!1),void 0===ignoreOverrides&&(ignoreOverrides=!1),ignoreOverrides||null==this.overrides.configs[expName]){var latestValue=this.getLatestValue(expName,"dynamic_configs");details=this.getEvaluationDetails(null!=latestValue);var finalValue=this.getPossiblyStickyValue(expName,latestValue,keepDeviceValue,!1,details);exp=this.createDynamicConfig(expName,finalValue,details)}else details=this.getEvaluationDetails(!1,EvaluationReason_1.EvaluationReason.LocalOverride),exp=new DynamicConfig_1.default(expName,this.overrides.configs[expName],"override",details);return exp},StatsigStore.prototype.getLayer=function(logParameterFunction,layerName,keepDeviceValue){var _a,_b,_c,_d;if(null!=this.overrides.layers[layerName]){var details_1=this.getEvaluationDetails(!1,EvaluationReason_1.EvaluationReason.LocalOverride);return Layer_1.default._create(layerName,null!==(_a=this.overrides.layers[layerName])&&void 0!==_a?_a:{},"override",details_1,logParameterFunction)}var latestValue=this.getLatestValue(layerName,"layer_configs"),details=this.getEvaluationDetails(null!=latestValue),finalValue=this.getPossiblyStickyValue(layerName,latestValue,keepDeviceValue,!0,details);return Layer_1.default._create(layerName,null!==(_b=null==finalValue?void 0:finalValue.value)&&void 0!==_b?_b:{},null!==(_c=null==finalValue?void 0:finalValue.rule_id)&&void 0!==_c?_c:"",details,logParameterFunction,null==finalValue?void 0:finalValue.secondary_exposures,null==finalValue?void 0:finalValue.undelegated_secondary_exposures,null!==(_d=null==finalValue?void 0:finalValue.allocated_experiment_name)&&void 0!==_d?_d:"",null==finalValue?void 0:finalValue.explicit_parameters,null==finalValue?void 0:finalValue.group_name)},StatsigStore.prototype.overrideConfig=function(configName,value){try{JSON.stringify(value)}catch(e){return void console.warn("Failed to stringify given config override.  Dropping",e)}this.overrides.configs[configName]=value,this.saveOverrides()},StatsigStore.prototype.overrideLayer=function(layerName,value){try{JSON.stringify(value)}catch(e){return void console.warn("Failed to stringify given layer override.  Dropping",e)}this.overrides.layers[layerName]=value,this.saveOverrides()},StatsigStore.prototype.overrideGate=function(gateName,value){this.overrides.gates[gateName]=value,this.saveOverrides()},StatsigStore.prototype.removeGateOverride=function(gateName){null==gateName?this.overrides.gates={}:delete this.overrides.gates[gateName],this.saveOverrides()},StatsigStore.prototype.removeConfigOverride=function(configName){null==configName?this.overrides.configs={}:delete this.overrides.configs[configName],this.saveOverrides()},StatsigStore.prototype.removeLayerOverride=function(layerName){null==layerName?this.overrides.layers={}:delete this.overrides.layers[layerName],this.saveOverrides()},StatsigStore.prototype.getAllOverrides=function(){return this.overrides},StatsigStore.prototype.saveOverrides=function(){try{StatsigLocalStorage_1.default.setItem(Constants_1.OVERRIDES_STORE_KEY,JSON.stringify(this.overrides))}catch(e){console.warn("Failed to persist gate/config overrides")}},StatsigStore.prototype.getLatestValue=function(name,topLevelKey){var _a,_b,_c,_d,_f,hash=this.getHashedSpecName(name);return null!==(_c=null===(_b=null===(_a=this.userValues)||void 0===_a?void 0:_a[topLevelKey])||void 0===_b?void 0:_b[hash])&&void 0!==_c?_c:null===(_f=null===(_d=this.userValues)||void 0===_d?void 0:_d[topLevelKey])||void 0===_f?void 0:_f[name]},StatsigStore.prototype.getPossiblyStickyValue=function(name,latestValue,keepDeviceValue,isLayer,details){var _a,key=this.getHashedSpecName(name);if(!keepDeviceValue)return this.removeStickyValue(key),latestValue;var stickyValue=this.getStickyValue(key);if(!stickyValue)return this.attemptToSaveStickyValue(key,latestValue),latestValue;var latestExperimentValue=null;return 1==(null==(latestExperimentValue=isLayer?this.getLatestValue(null!==(_a=null==stickyValue?void 0:stickyValue.allocated_experiment_name)&&void 0!==_a?_a:"","dynamic_configs"):latestValue)?void 0:latestExperimentValue.is_experiment_active)?(details.reason=EvaluationReason_1.EvaluationReason.Sticky,stickyValue):(1==(null==latestValue?void 0:latestValue.is_experiment_active)?this.attemptToSaveStickyValue(key,latestValue):this.removeStickyValue(key),latestValue)},StatsigStore.prototype.createDynamicConfig=function(name,apiConfig,details){var _a,_b,_c;return new DynamicConfig_1.default(name,null!==(_a=null==apiConfig?void 0:apiConfig.value)&&void 0!==_a?_a:{},null!==(_b=null==apiConfig?void 0:apiConfig.rule_id)&&void 0!==_b?_b:"",details,null==apiConfig?void 0:apiConfig.secondary_exposures,null!==(_c=null==apiConfig?void 0:apiConfig.allocated_experiment_name)&&void 0!==_c?_c:"",this.makeOnConfigDefaultValueFallback(this.sdkInternal.getCurrentUser()),null==apiConfig?void 0:apiConfig.group_name,null==apiConfig?void 0:apiConfig.id_type,null==apiConfig?void 0:apiConfig.is_experiment_active)},StatsigStore.prototype.getStickyValue=function(key){var _a,_b;return null!==(_b=null===(_a=this.userValues)||void 0===_a?void 0:_a.sticky_experiments[key])&&void 0!==_b?_b:this.stickyDeviceExperiments[key]},StatsigStore.prototype.attemptToSaveStickyValue=function(key,config){var _a;config&&config.is_user_in_experiment&&config.is_experiment_active&&(!0===config.is_device_based?this.stickyDeviceExperiments[key]=config:(null===(_a=this.userValues)||void 0===_a?void 0:_a.sticky_experiments)&&(this.userValues.sticky_experiments[key]=config),this.saveStickyValuesToStorage())},StatsigStore.prototype.removeStickyValue=function(key){var _a,_b,_c,_d;0===Object.keys(null!==(_b=null===(_a=this.userValues)||void 0===_a?void 0:_a.sticky_experiments)&&void 0!==_b?_b:{}).length&&0===Object.keys(null!==(_c=this.stickyDeviceExperiments)&&void 0!==_c?_c:{}).length||(null===(_d=this.userValues)||void 0===_d||delete _d.sticky_experiments[key],delete this.stickyDeviceExperiments[key],this.saveStickyValuesToStorage())},StatsigStore.prototype.saveStickyValuesToStorage=function(){this.userPersistentStorageAdapter?this.saveStickyExperimentsToPersistentStorageAdapter():(this.values[this.userCacheKey.v2]=this.userValues,this.setItemToStorage(Constants_1.INTERNAL_STORE_KEY,JSON.stringify(this.values)),this.setItemToStorage(Constants_1.STICKY_DEVICE_EXPERIMENTS_KEY,JSON.stringify(this.stickyDeviceExperiments)))},StatsigStore.prototype.getGlobalEvaluationDetails=function(){var _a,_b;return{reason:null!==(_a=this.reason)&&void 0!==_a?_a:EvaluationReason_1.EvaluationReason.Uninitialized,time:null!==(_b=this.userValues.evaluation_time)&&void 0!==_b?_b:0}},StatsigStore.prototype.getEvaluationDetails=function(valueExists,reasonOverride){var _a;return valueExists?{reason:this.reason,time:null!==(_a=this.userValues.evaluation_time)&&void 0!==_a?_a:Date.now()}:{reason:null!=reasonOverride?reasonOverride:this.reason==EvaluationReason_1.EvaluationReason.Uninitialized?EvaluationReason_1.EvaluationReason.Uninitialized:EvaluationReason_1.EvaluationReason.Unrecognized,time:Date.now()}},StatsigStore.prototype.resetUserValues=function(){this.userValues={feature_gates:{},dynamic_configs:{},sticky_experiments:{},layer_configs:{},time:0,evaluation_time:0,derived_fields:{}}},StatsigStore.prototype.getHashedSpecName=function(input){switch(this.userValues.hash_used){case"djb2":return(0,Hashing_1.djb2Hash)(input);case"none":return input;default:return(0,Hashing_1.sha256Hash)(input)}},StatsigStore.prototype.convertAPIDataToCacheValues=function(data,cacheKey){var _a,_b;return{feature_gates:data.feature_gates,layer_configs:data.layer_configs,dynamic_configs:data.dynamic_configs,sticky_experiments:null!==(_b=null===(_a=this.values[cacheKey])||void 0===_a?void 0:_a.sticky_experiments)&&void 0!==_b?_b:{},time:null==data.time||isNaN(data.time)?0:data.time,evaluation_time:Date.now(),hash_used:data.hash_used,derived_fields:data.derived_fields}},StatsigStore.prototype.setItemToStorage=function(key,value){var _this=this;StatsigAsyncStorage_1.default.asyncStorage?StatsigAsyncStorage_1.default.setItemAsync(key,value).catch((function(reason){_this.sdkInternal.getErrorBoundary().logError("setItemToStorage",reason)})):StatsigLocalStorage_1.default.setItem(key,value)},StatsigStore.prototype.makeOnConfigDefaultValueFallback=function(user){var _this=this;return function(config,parameter,defaultValueType,valueType){_this.isLoaded()&&_this.sdkInternal.getLogger().logConfigDefaultValueFallback(user,"Parameter "+parameter+" is a value of type "+valueType+".\n          Returning requested defaultValue type "+defaultValueType,{name:config.getName(),ruleID:config.getRuleID(),parameter:parameter,defaultValueType:defaultValueType,valueType:valueType})}},StatsigStore}();function removeDeletedKeysFromUserValues(initResponse,userValues){var _a,_b,_c;(null!==(_a=initResponse.deleted_configs)&&void 0!==_a?_a:[]).forEach((function(key){delete userValues.dynamic_configs[key]})),(null!==(_b=initResponse.deleted_gates)&&void 0!==_b?_b:[]).forEach((function(key){delete userValues.feature_gates[key]})),(null!==(_c=initResponse.deleted_layers)&&void 0!==_c?_c:[]).forEach((function(key){delete userValues.layer_configs[key]}))}exports.default=StatsigStore;