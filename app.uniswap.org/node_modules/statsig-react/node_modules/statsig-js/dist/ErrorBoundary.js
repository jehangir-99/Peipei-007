"use strict";var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExceptionEndpoint=void 0;var Errors_1=require("./Errors"),Diagnostics_1=__importDefault(require("./utils/Diagnostics")),parseError_1=__importDefault(require("./utils/parseError"));exports.ExceptionEndpoint="https://statsigapi.net/v1/sdk_exception";var MAX_DIAGNOSTICS_MARKERS=30,SAMPLING_RATE=1e4,ErrorBoundary=function(){function ErrorBoundary(sdkKey){this.sdkKey=sdkKey,this.seen=new Set;var sampling=Math.floor(Math.random()*SAMPLING_RATE);this.setupDiagnostics(0===sampling?MAX_DIAGNOSTICS_MARKERS:0)}return ErrorBoundary.prototype.setStatsigMetadata=function(statsigMetadata){this.statsigMetadata=statsigMetadata},ErrorBoundary.prototype.swallow=function(tag,task,options){void 0===options&&(options={}),this.capture(tag,task,(function(){}),options)},ErrorBoundary.prototype.capture=function(tag,task,recover,_a){var _this=this,_b=void 0===_a?{}:_a,getExtraData=_b.getExtraData,configName=_b.configName,markerID=null;try{markerID=this.beginMarker(tag);var result=task(),wasSuccessful_1=!0;return result instanceof Promise?result.catch((function(e){return wasSuccessful_1=!1,_this.onCaught(tag,e,recover,getExtraData)})).then((function(possiblyRecoveredResult){return _this.endMarker(tag,wasSuccessful_1,markerID),possiblyRecoveredResult})):(this.endMarker(tag,!0,markerID,configName),result)}catch(error){return this.endMarker(tag,!1,markerID,configName),this.onCaught(tag,error,recover,getExtraData)}},ErrorBoundary.prototype.logError=function(tag,error,getExtraData){__awaiter(this,void 0,void 0,(function(){var extra,_a,_b,name_1,info,metadata,body,_c;return __generator(this,(function(_d){switch(_d.label){case 0:return _d.trys.push([0,4,,5]),"function"!=typeof getExtraData?[3,2]:[4,getExtraData()];case 1:return _a=_d.sent(),[3,3];case 2:_a=null,_d.label=3;case 3:return extra=_a,_b=(0,parseError_1.default)(error),name_1=_b.name,info=_b.trace,this.seen.has(name_1)?[2]:(this.seen.add(name_1),metadata=null!==(_c=this.statsigMetadata)&&void 0!==_c?_c:{},body=JSON.stringify({tag:tag,exception:name_1,info:info,statsigMetadata:metadata,extra:null!=extra?extra:{}}),[2,fetch(exports.ExceptionEndpoint,{method:"POST",headers:{"STATSIG-API-KEY":this.sdkKey,"STATSIG-SDK-TYPE":String(metadata.sdkType),"STATSIG-SDK-VERSION":String(metadata.sdkVersion),"Content-Type":"application/json; charset=UTF-8"},body:body})]);case 4:return _d.sent(),[3,5];case 5:return[2]}}))})).catch((function(){}))},ErrorBoundary.prototype.setupDiagnostics=function(maxMarkers){Diagnostics_1.default.setMaxMarkers("api_call",maxMarkers)},ErrorBoundary.prototype.beginMarker=function(tag){var diagnostics=Diagnostics_1.default.mark.api_call(tag);if(!diagnostics)return null;var markerID=tag+"_"+Diagnostics_1.default.getMarkerCount("api_call");return diagnostics.start({markerID:markerID},"api_call")?markerID:null},ErrorBoundary.prototype.endMarker=function(tag,wasSuccessful,markerID,configName){var diagnostics=Diagnostics_1.default.mark.api_call(tag);markerID&&diagnostics&&diagnostics.end({markerID:markerID,success:wasSuccessful,configName:configName},"api_call")},ErrorBoundary.prototype.onCaught=function(tag,error,recover,getExtraData){if(error instanceof Errors_1.StatsigUninitializedError||error instanceof Errors_1.StatsigInvalidArgumentError)throw error;return console.error("[Statsig] An unexpected exception occurred.",error),this.logError(tag,error,getExtraData),recover()},ErrorBoundary}();exports.default=ErrorBoundary;