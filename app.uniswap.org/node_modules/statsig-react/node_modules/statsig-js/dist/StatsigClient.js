"use strict";var __assign=this&&this.__assign||function(){return __assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t},__assign.apply(this,arguments)},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){var value;result.done?resolve(result.value):(value=result.value,value instanceof P?value:new P((function(resolve){resolve(value)}))).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))},__generator=this&&this.__generator||function(thisArg,body){var f,y,t,g,_={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return g={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return function(op){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,y&&(t=2&op[0]?y.return:op[0]?y.throw||((t=y.return)&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;switch(y=0,t&&(op=[2&op[0],t.value]),op[0]){case 0:case 1:t=op;break;case 4:return _.label++,{value:op[1],done:!1};case 5:_.label++,y=op[1],op=[0];continue;case 7:op=_.ops.pop(),_.trys.pop();continue;default:if(!(t=_.trys,(t=t.length>0&&t[t.length-1])||6!==op[0]&&2!==op[0])){_=0;continue}if(3===op[0]&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(6===op[0]&&_.label<t[1]){_.label=t[1],t=op;break}if(t&&_.label<t[2]){_.label=t[2],_.ops.push(op);break}t[2]&&_.ops.pop(),_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e],y=0}finally{f=t=0}if(5&op[0])throw op[1];return{value:op[0]?op[1]:void 0,done:!0}}([n,v])}}},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var DynamicConfig_1=__importDefault(require("./DynamicConfig")),ErrorBoundary_1=__importDefault(require("./ErrorBoundary")),Errors_1=require("./Errors"),Layer_1=__importDefault(require("./Layer")),LogEvent_1=__importDefault(require("./LogEvent")),StatsigIdentity_1=__importDefault(require("./StatsigIdentity")),StatsigLogger_1=__importDefault(require("./StatsigLogger")),StatsigNetwork_1=__importDefault(require("./StatsigNetwork")),StatsigSDKOptions_1=__importDefault(require("./StatsigSDKOptions")),StatsigStore_1=__importDefault(require("./StatsigStore")),EvaluationReason_1=require("./utils/EvaluationReason"),Hashing_1=require("./utils/Hashing"),StatsigAsyncStorage_1=__importDefault(require("./utils/StatsigAsyncStorage")),StatsigLocalStorage_1=__importDefault(require("./utils/StatsigLocalStorage")),Diagnostics_1=__importDefault(require("./utils/Diagnostics")),ConsoleLogger_1=__importDefault(require("./utils/ConsoleLogger")),Timing_1=require("./utils/Timing"),MAX_VALUE_SIZE=64,MAX_OBJ_SIZE=2048,StatsigClient=function(){function StatsigClient(sdkKey,user,options){var _this=this;if(this.appState=null,this.currentAppState=null,this.onCacheLoadedForReact=null,this.initCalled=!1,this.pendingInitPromise=null,this.optionalLoggingSetup=!1,this.prefetchedUsersByCacheKey={},this.logLayerParameterExposureForLayer=function(layer,parameterName,isManualExposure){void 0===isManualExposure&&(isManualExposure=!1);var allocatedExperiment="",exposures=layer._getUndelegatedSecondaryExposures(),isExplicit=layer._getExplicitParameters().includes(parameterName);isExplicit&&(allocatedExperiment=layer._getAllocatedExperimentName(),exposures=layer._getSecondaryExposures()),_this.logger.logLayerExposure(_this.getCurrentUser(),layer.getName(),layer.getRuleID(),exposures,allocatedExperiment,parameterName,isExplicit,layer._getEvaluationDetails(),isManualExposure)},!0!==(null==options?void 0:options.localMode)&&("string"!=typeof sdkKey||!sdkKey.startsWith("client-")))throw new Errors_1.StatsigInvalidArgumentError("Invalid key provided.  You must use a Client SDK Key from the Statsig console to initialize the sdk");if(this.startTime=(0,Timing_1.now)(),this.options=new StatsigSDKOptions_1.default(options),this.logger=new StatsigLogger_1.default(this),Diagnostics_1.default.initialize({options:this.options}),this.errorBoundary=new ErrorBoundary_1.default(sdkKey),this.ready=!1,this.sdkKey=sdkKey,this.consoleLogger=new ConsoleLogger_1.default(this.options.getLogLevel()),StatsigLocalStorage_1.default.disabled=this.options.getDisableLocalStorage(),this.identity=new StatsigIdentity_1.default(this.normalizeUser(null!=user?user:null),this.options.getOverrideStableID(),StatsigClient.reactNativeUUID),this.network=new StatsigNetwork_1.default(this),this.store=new StatsigStore_1.default(this,this.options.getInitializeValues()),this.errorBoundary.setStatsigMetadata(this.getStatsigMetadata()),null!=this.options.getInitializeValues()){var cb=this.options.getInitCompletionCallback();this.ready=!0,this.initCalled=!0,setTimeout((function(){return _this.delayedSetup()}),20),this.handleOptionalLogging(),cb&&cb((0,Timing_1.now)()-this.startTime,!0,null)}}return StatsigClient.prototype.getErrorBoundary=function(){return this.errorBoundary},StatsigClient.prototype.getNetwork=function(){return this.network},StatsigClient.prototype.getStore=function(){return this.store},StatsigClient.prototype.getLogger=function(){return this.logger},StatsigClient.prototype.getOptions=function(){return this.options},StatsigClient.prototype.getSDKKey=function(){var _this=this;return this.errorBoundary.capture("getSDKKey",(function(){var _a;return null!==(_a=_this.sdkKey)&&void 0!==_a?_a:""}),(function(){return""}))},StatsigClient.prototype.getCurrentUser=function(){var _this=this;return this.errorBoundary.capture("getCurrentUser",(function(){return _this.identity.getUser()}),(function(){return null}))},StatsigClient.prototype.getCurrentUserCacheKey=function(){var _this=this;return this.errorBoundary.capture("getCurrentUserCacheKey",(function(){return(0,Hashing_1.getUserCacheKey)(_this.getStableID(),_this.getCurrentUser())}),(function(){return{v1:"",v2:""}}))},StatsigClient.prototype.getCurrentUserUnitID=function(idType){var _this=this;return this.errorBoundary.capture("getCurrentUserUnitID",(function(){return _this.getUnitID(_this.getCurrentUser(),idType)}),(function(){return""}))},StatsigClient.prototype.getCurrentUserID=function(){var _this=this;return this.errorBoundary.capture("getCurrentUserID",(function(){return _this.getUnitID(_this.getCurrentUser(),"userid")}),(function(){return""}))},StatsigClient.prototype.getUnitID=function(user,idType){var _a,_b,_c;return user?"userid"===idType.toLowerCase()?null!==(_b=null===(_a=user.userID)||void 0===_a?void 0:_a.toString())&&void 0!==_b?_b:null:user.customIDs?null!==(_c=user.customIDs[idType])&&void 0!==_c?_c:user.customIDs[idType.toLowerCase()]:null:null},StatsigClient.prototype.getStatsigMetadata=function(){var _this=this;return this.errorBoundary.capture("getStatsigMetadata",(function(){return _this.identity.getStatsigMetadata()}),(function(){return{}}))},StatsigClient.prototype.getSDKType=function(){var _this=this;return this.errorBoundary.capture("getSDKType",(function(){return _this.identity.getSDKType()}),(function(){return""}))},StatsigClient.prototype.getSDKVersion=function(){var _this=this;return this.errorBoundary.capture("getSDKVersion",(function(){return _this.identity.getSDKVersion()}),(function(){return""}))},StatsigClient.prototype.getConsoleLogger=function(){return this.consoleLogger},StatsigClient.prototype.delayedSetup=function(){var _this=this;this.errorBoundary.swallow("delayedSetup",(function(){null!=_this.options.getInitializeValues()&&_this.fireAndForgetPrefechUsers(),_this.identity.saveStableID(),_this.logger.sendSavedRequests().catch((function(reason){return _this.errorBoundary.logError("sendSavedRequests:delayedSetup",reason)}))}))},StatsigClient.prototype.setInitializeValues=function(initializeValues){var _this=this;this.errorBoundary.capture("setInitializeValues",(function(){_this.store.bootstrap(initializeValues);var cb=null;_this.ready||(_this.ready=!0,_this.initCalled=!0,cb=_this.options.getInitCompletionCallback()),_this.handleOptionalLogging(),_this.logger.sendSavedRequests().catch((function(reason){return _this.errorBoundary.logError("sendSavedRequests:setInitializeValues",reason)})),cb&&cb((0,Timing_1.now)()-_this.startTime,!0,null)}),(function(){_this.ready=!0,_this.initCalled=!0;var cb=_this.options.getInitCompletionCallback();cb&&cb((0,Timing_1.now)()-_this.startTime,!1,"Caught an exception during setInitializeValues")}))},StatsigClient.prototype.initializeAsync=function(){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return[2,this.errorBoundary.capture("initializeAsync",(function(){return __awaiter(_this,void 0,void 0,(function(){var user,_a,_this=this;return __generator(this,(function(_b){switch(_b.label){case 0:return null!=this.pendingInitPromise?[2,this.pendingInitPromise]:this.ready?[2,Promise.resolve()]:(Diagnostics_1.default.mark.overall.start({}),this.initCalled=!0,StatsigAsyncStorage_1.default.asyncStorage?[4,this.identity.initAsync()]:[3,3]);case 1:return _b.sent(),[4,this.store.loadAsync()];case 2:_b.sent(),_b.label=3;case 3:return null===(_a=this.onCacheLoadedForReact)||void 0===_a||_a.call(this),this.appState&&this.appState.addEventListener&&"function"==typeof this.appState.addEventListener&&(this.currentAppState=this.appState.currentState,this.appState.addEventListener("change",this.handleAppStateChange.bind(this))),this.options.getLocalModeEnabled()?[2,Promise.resolve()]:(user=this.identity.getUser(),this.pendingInitPromise=this.fetchAndSaveValues({user:user,prefetchUsers:this.options.getPrefetchUsers(),timeout:this.options.getInitTimeoutMs()}).then((function(){return Diagnostics_1.default.mark.overall.end({success:!0,evaluationDetails:_this.store.getGlobalEvaluationDetails()}),{success:!0,message:null}})).catch((function(e){var _a;return _this.errorBoundary.logError("initializeAsync:fetchAndSaveValues",e),Diagnostics_1.default.mark.overall.end({success:!1,error:Diagnostics_1.default.formatError(e),evaluationDetails:_this.store.getGlobalEvaluationDetails()}),{success:!1,message:null!==(_a=e.message)&&void 0!==_a?_a:null}})).then((function(_a){var success=_a.success,message=_a.message,cb=_this.options.getInitCompletionCallback();cb&&cb((0,Timing_1.now)()-_this.startTime,success,message)})).finally((function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){return this.pendingInitPromise=null,this.ready=!0,this.delayedSetup(),this.logger.logDiagnostics(user,"initialize"),[2]}))}))})),this.handleOptionalLogging(),[2,this.pendingInitPromise])}}))}))}),(function(){return _this.ready=!0,_this.initCalled=!0,Promise.resolve()}))]}))}))},StatsigClient.prototype.prefetchUsers=function(users){return __awaiter(this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return[2,this.errorBoundary.capture("prefetchUsers",(function(){if(users&&0!=users.length)return _this.fetchAndSaveValues({user:null,prefetchUsers:users,timeout:0})}),(function(){return Promise.resolve()}))]}))}))},StatsigClient.prototype.getEvaluationDetails=function(){var _this=this;return this.errorBoundary.capture("getEvaluationDetails",(function(){return _this.store.getGlobalEvaluationDetails()}),(function(){return{time:Date.now(),reason:EvaluationReason_1.EvaluationReason.Error}}))},StatsigClient.prototype.checkGate=function(gateName,ignoreOverrides){var _this=this;return void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("checkGate",(function(){var result=_this.checkGateImpl(gateName,ignoreOverrides);_this.logGateExposureImpl(gateName,result);var cb=_this.options.getGateEvaluationCallback();return cb&&cb(gateName,result.gate.value,{withExposureLoggingDisabled:!1}),!0===result.gate.value}),(function(){return!1}),{configName:gateName})},StatsigClient.prototype.checkGateWithExposureLoggingDisabled=function(gateName,ignoreOverrides){var _this=this;return void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("checkGateWithExposureLoggingDisabled",(function(){var result=_this.checkGateImpl(gateName,ignoreOverrides),cb=_this.options.getGateEvaluationCallback();return cb&&cb(gateName,result.gate.value,{withExposureLoggingDisabled:!0}),!0===result.gate.value}),(function(){return!1}))},StatsigClient.prototype.logGateExposure=function(gateName){var _this=this;this.errorBoundary.swallow("logGateExposure",(function(){_this.logGateExposureImpl(gateName)}))},StatsigClient.prototype.getConfig=function(configName,ignoreOverrides){var _this=this;return void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("getConfig",(function(){var result=_this.getConfigImpl(configName,ignoreOverrides);return _this.logConfigExposureImpl(configName,result),result}),(function(){return _this.getEmptyConfig(configName)}),{configName:configName})},StatsigClient.prototype.getConfigWithExposureLoggingDisabled=function(configName,ignoreOverrides){var _this=this;return void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("getConfig",(function(){return _this.getConfigImpl(configName,ignoreOverrides)}),(function(){return _this.getEmptyConfig(configName)}))},StatsigClient.prototype.logConfigExposure=function(configName){var _this=this;this.errorBoundary.swallow("logConfigExposure",(function(){_this.logConfigExposureImpl(configName)}))},StatsigClient.prototype.getExperiment=function(experimentName,keepDeviceValue,ignoreOverrides){var _this=this;return void 0===keepDeviceValue&&(keepDeviceValue=!1),void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("getExperiment",(function(){var result=_this.getExperimentImpl(experimentName,keepDeviceValue,ignoreOverrides);return _this.logExperimentExposureImpl(experimentName,keepDeviceValue,result),result}),(function(){return _this.getEmptyConfig(experimentName)}),{configName:experimentName})},StatsigClient.prototype.getExperimentWithExposureLoggingDisabled=function(experimentName,keepDeviceValue,ignoreOverrides){var _this=this;return void 0===keepDeviceValue&&(keepDeviceValue=!1),void 0===ignoreOverrides&&(ignoreOverrides=!1),this.errorBoundary.capture("getExperimentWithExposureLoggingDisabled",(function(){return _this.getExperimentImpl(experimentName,keepDeviceValue,ignoreOverrides)}),(function(){return _this.getEmptyConfig(experimentName)}))},StatsigClient.prototype.logExperimentExposure=function(experimentName,keepDeviceValue){var _this=this;this.errorBoundary.swallow("logExperimentExposure",(function(){_this.logExperimentExposureImpl(experimentName,keepDeviceValue)}))},StatsigClient.prototype.getLayer=function(layerName,keepDeviceValue){var _this=this;return void 0===keepDeviceValue&&(keepDeviceValue=!1),this.errorBoundary.capture("getLayer",(function(){return _this.getLayerImpl(_this.logLayerParameterExposureForLayer,layerName,keepDeviceValue)}),(function(){return Layer_1.default._create(layerName,{},"",_this.getEvalutionDetailsForError())}),{configName:layerName})},StatsigClient.prototype.getLayerWithExposureLoggingDisabled=function(layerName,keepDeviceValue){var _this=this;return void 0===keepDeviceValue&&(keepDeviceValue=!1),this.errorBoundary.capture("getLayerWithExposureLoggingDisabled",(function(){return _this.getLayerImpl(null,layerName,keepDeviceValue)}),(function(){return Layer_1.default._create(layerName,{},"",_this.getEvalutionDetailsForError())}))},StatsigClient.prototype.logLayerParameterExposure=function(layerName,parameterName,keepDeviceValue){var _this=this;void 0===keepDeviceValue&&(keepDeviceValue=!1),this.errorBoundary.swallow("logLayerParameterExposure",(function(){var layer=_this.getLayerImpl(null,layerName,keepDeviceValue);_this.logLayerParameterExposureForLayer(layer,parameterName,!0)}))},StatsigClient.prototype.logEvent=function(eventName,value,metadata){var _this=this;void 0===value&&(value=null),void 0===metadata&&(metadata=null),this.errorBoundary.swallow("logEvent",(function(){if(!_this.logger||!_this.sdkKey)throw new Errors_1.StatsigUninitializedError("Must initialize() before logging events.");if("string"==typeof eventName&&0!==eventName.length){_this.shouldTrimParam(eventName,MAX_VALUE_SIZE)&&(_this.consoleLogger.info("eventName is too long, trimming to "+MAX_VALUE_SIZE+" characters."),eventName=eventName.substring(0,MAX_VALUE_SIZE)),"string"==typeof value&&_this.shouldTrimParam(value,MAX_VALUE_SIZE)&&(_this.consoleLogger.info("value is too long, trimming to "+MAX_VALUE_SIZE+"."),value=value.substring(0,MAX_VALUE_SIZE)),_this.shouldTrimParam(metadata,MAX_OBJ_SIZE)&&(_this.consoleLogger.info("metadata is too big. Dropping the metadata."),metadata={error:"not logged due to size too large"});var event=new LogEvent_1.default(eventName);event.setValue(value),event.setMetadata(metadata),event.setUser(_this.getCurrentUser()),_this.logger.log(event)}else _this.consoleLogger.error("Event not logged. No valid eventName passed.")}))},StatsigClient.prototype.updateUserWithValues=function(user,values){var fireCompletionCallback,_this=this;return this.errorBoundary.capture("updateUserWithValues",(function(){var updateStartTime=Date.now();if(!_this.initializeCalled())throw new Errors_1.StatsigUninitializedError("Call initialize() first.");return fireCompletionCallback=function(success,error){var cb=_this.options.getUpdateUserCompletionCallback();null==cb||cb(Date.now()-updateStartTime,success,error)},_this.identity.updateUser(_this.normalizeUser(user)),_this.store.bootstrap(values),fireCompletionCallback(!0,null),!0}),(function(){return null==fireCompletionCallback||fireCompletionCallback(!1,"Failed to update user. An unexpected error occured."),!1}))},StatsigClient.prototype.updateUser=function(user){return __awaiter(this,void 0,void 0,(function(){var fireCompletionCallback,_this=this;return __generator(this,(function(_a){return[2,this.errorBoundary.capture("updateUser",(function(){return __awaiter(_this,void 0,void 0,(function(){var updateStartTime,userCacheKey,isUserPrefetched,cachedTime,currentUser,_this=this;return __generator(this,(function(_a){switch(_a.label){case 0:if(updateStartTime=Date.now(),!this.initializeCalled())throw new Errors_1.StatsigUninitializedError("Call initialize() first.");return fireCompletionCallback=function(success,error){var cb=_this.options.getUpdateUserCompletionCallback();null==cb||cb(Date.now()-updateStartTime,success,error)},this.identity.updateUser(this.normalizeUser(user)),userCacheKey=this.getCurrentUserCacheKey(),isUserPrefetched=Boolean(this.prefetchedUsersByCacheKey[userCacheKey.v2]),cachedTime=this.store.updateUser(isUserPrefetched),Diagnostics_1.default.clearContext("api_call"),this.logger.resetDedupeKeys(),null!=cachedTime&&(isUserPrefetched||this.isCacheValidForFetchMode(cachedTime))?(fireCompletionCallback(!0,null),[2,Promise.resolve(!0)]):null==this.pendingInitPromise?[3,2]:[4,this.pendingInitPromise];case 1:_a.sent(),_a.label=2;case 2:return this.options.getLocalModeEnabled()?(fireCompletionCallback(!0,null),[2,Promise.resolve(!0)]):(currentUser=this.identity.getUser(),this.pendingInitPromise=this.fetchAndSaveValues({user:currentUser,prefetchUsers:[],timeout:void 0}).finally((function(){_this.pendingInitPromise=null})),[2,this.pendingInitPromise.then((function(){return fireCompletionCallback(!0,null),Promise.resolve(!0)})).catch((function(error){return fireCompletionCallback(!1,"Failed to update user: "+error),Promise.resolve(!1)}))])}}))}))}),(function(){return null==fireCompletionCallback||fireCompletionCallback(!1,"Failed to update user. An unexpected error occured."),Promise.resolve(!1)}))]}))}))},StatsigClient.prototype.shutdown=function(){var _this=this;this.errorBoundary.swallow("shutdown",(function(){_this.logger.shutdown(),_this.appState&&_this.appState.removeEventListener&&"function"==typeof _this.appState.removeEventListener&&_this.appState.removeEventListener("change",_this.handleAppStateChange.bind(_this)),StatsigLocalStorage_1.default.cleanup()}))},StatsigClient.prototype.overrideGate=function(gateName,value){var _this=this;this.errorBoundary.swallow("overrideGate",(function(){_this.ensureStoreLoaded(),_this.store.overrideGate(gateName,value)}))},StatsigClient.prototype.overrideConfig=function(configName,value){var _this=this;this.errorBoundary.swallow("overrideConfig",(function(){_this.ensureStoreLoaded(),_this.store.overrideConfig(configName,value)}))},StatsigClient.prototype.overrideLayer=function(layerName,value){var _this=this;this.errorBoundary.swallow("overrideLayer",(function(){_this.ensureStoreLoaded(),_this.store.overrideLayer(layerName,value)}))},StatsigClient.prototype.removeGateOverride=function(gateName){var _this=this;this.errorBoundary.swallow("removeGateOverride",(function(){_this.ensureStoreLoaded(),_this.store.removeGateOverride(gateName)}))},StatsigClient.prototype.removeConfigOverride=function(configName){var _this=this;this.errorBoundary.swallow("removeConfigOverride",(function(){_this.ensureStoreLoaded(),_this.store.removeConfigOverride(configName)}))},StatsigClient.prototype.removeLayerOverride=function(layerName){var _this=this;this.errorBoundary.swallow("removeLayerOverride",(function(){_this.ensureStoreLoaded(),_this.store.removeLayerOverride(layerName)}))},StatsigClient.prototype.removeOverride=function(gateName){var _this=this;this.errorBoundary.swallow("removeOverride",(function(){_this.ensureStoreLoaded(),_this.store.removeGateOverride(gateName)}))},StatsigClient.prototype.getOverrides=function(){var _this=this;return this.errorBoundary.capture("getOverrides",(function(){return _this.ensureStoreLoaded(),_this.store.getAllOverrides().gates}),(function(){return{}}))},StatsigClient.prototype.getAllOverrides=function(){var _this=this;return this.errorBoundary.capture("getAllOverrides",(function(){return _this.ensureStoreLoaded(),_this.store.getAllOverrides()}),(function(){return{gates:{},configs:{},layers:{}}}))},StatsigClient.prototype.getStableID=function(){var _this=this;return this.errorBoundary.capture("getStableID",(function(){return _this.identity.getStatsigMetadata().stableID}),(function(){return""}))},StatsigClient.prototype.initializeCalled=function(){return this.initCalled},StatsigClient.prototype.setSDKPackageInfo=function(sdkPackageInfo){null!=sdkPackageInfo&&(this.identity.setSDKPackageInfo(sdkPackageInfo),this.errorBoundary.setStatsigMetadata(this.getStatsigMetadata()))},StatsigClient.setAsyncStorage=function(asyncStorage){null!=asyncStorage&&(StatsigAsyncStorage_1.default.asyncStorage=asyncStorage)},StatsigClient.prototype.setOnCacheLoadedReactCallback=function(fn){this.onCacheLoadedForReact=null!=fn?fn:null},StatsigClient.setReactNativeUUID=function(uuid){null!=uuid&&(StatsigClient.reactNativeUUID=uuid)},StatsigClient.prototype.setAppState=function(appState){null!=appState&&(this.appState=appState)},StatsigClient.prototype.setNativeModules=function(nativeModules){null!=nativeModules&&this.identity.setNativeModules(nativeModules)},StatsigClient.prototype.setPlatform=function(platform){null!=platform&&this.identity.setPlatform(platform)},StatsigClient.prototype.setRNDeviceInfo=function(deviceInfo){null!=deviceInfo&&this.identity.setRNDeviceInfo(deviceInfo)},StatsigClient.prototype.setExpoConstants=function(expoConstants){null!=expoConstants&&this.identity.setExpoConstants(expoConstants)},StatsigClient.prototype.setExpoDevice=function(expoDevice){null!=expoDevice&&this.identity.setExpoDevice(expoDevice)},StatsigClient.prototype.flushEvents=function(){this.logger.flush()},StatsigClient.prototype.reenableAllLogging=function(){this.getOptions().reenableAllLogging()},StatsigClient.prototype.isCacheValidForFetchMode=function(cachedTime){return"cache-or-network"===this.options.getFetchMode()&&cachedTime>this.startTime},StatsigClient.prototype.handleOptionalLogging=function(){var _this=this,isErrorLoggingDisabled=this.options.getDisableErrorLogging(),isAutoMetricsLoggingDisabled=this.options.getDisableAutoMetricsLogging();if((!isErrorLoggingDisabled||!isAutoMetricsLoggingDisabled)&&!this.optionalLoggingSetup&&"undefined"!=typeof window&&window&&window.addEventListener){var user=this.identity.getUser();if(isErrorLoggingDisabled||window.addEventListener("error",(function(e){var _a,errorObj=e.error;if(null!=errorObj&&"object"==typeof errorObj)try{errorObj=JSON.stringify(errorObj)}catch(e){errorObj="Failed to stringify Error"}_this.logger.logAppError(user,null!==(_a=e.message)&&void 0!==_a?_a:"",{filename:e.filename,lineno:e.lineno,colno:e.colno,error_obj:errorObj})})),!isAutoMetricsLoggingDisabled){if("undefined"==typeof document||!document||"undefined"==typeof setTimeout||!setTimeout)return;var work_1=function(){setTimeout((function(){_this.logger.logAppMetrics(user)}),1e3)};"complete"===document.readyState?work_1():window.addEventListener("load",(function(){return work_1()}))}this.optionalLoggingSetup=!0}},StatsigClient.prototype.handleAppStateChange=function(nextAppState){var _a,_this=this;"active"===this.currentAppState&&nextAppState.match(/inactive|background/)?this.logger.flush(!0):(null===(_a=this.currentAppState)||void 0===_a?void 0:_a.match(/inactive|background/))&&"active"===nextAppState&&this.logger.sendSavedRequests().catch((function(reason){return _this.errorBoundary.logError("sendSavedRequests:handleAppStateChange",reason)})),this.currentAppState=nextAppState},StatsigClient.prototype.shouldTrimParam=function(entity,size){return null!=entity&&("string"==typeof entity?entity.length>size:"object"==typeof entity?JSON.stringify(entity).length>size:"number"==typeof entity&&entity.toString().length>size)},StatsigClient.prototype.normalizePrefetchUsers=function(users){var _this=this;return null==users?[]:users.map((function(user){return _this.normalizeUser(user)}))},StatsigClient.prototype.normalizeUser=function(user){var userCopy={};try{userCopy=JSON.parse(JSON.stringify(user))}catch(error){throw new Errors_1.StatsigInvalidArgumentError("User object must be convertable to JSON string.")}return userCopy=this.trimUserObjIfNeeded(userCopy),null!=this.options.getEnvironment()&&(userCopy.statsigEnvironment=this.options.getEnvironment()),userCopy},StatsigClient.prototype.trimUserObjIfNeeded=function(user){var _a,_b;return null==user?{}:(this.shouldTrimParam(null!==(_a=user.userID)&&void 0!==_a?_a:null,MAX_VALUE_SIZE)&&(this.consoleLogger.info("User ID is too large, trimming to "+MAX_VALUE_SIZE+"characters"),user.userID=null===(_b=user.userID)||void 0===_b?void 0:_b.toString().substring(0,MAX_VALUE_SIZE)),this.shouldTrimParam(user,MAX_OBJ_SIZE)&&(user.custom={},this.shouldTrimParam(user,MAX_OBJ_SIZE)?(this.consoleLogger.info("User object is too large, only keeping the user ID."),user={userID:user.userID}):this.consoleLogger.info("User object is too large, dropping the custom property.")),user)},StatsigClient.prototype.ensureStoreLoaded=function(){if(!this.store.isLoaded())throw new Errors_1.StatsigUninitializedError("Call and wait for initialize() to finish first.")},StatsigClient.prototype.getEvalutionDetailsForError=function(){return{time:Date.now(),reason:EvaluationReason_1.EvaluationReason.Error}},StatsigClient.prototype.fetchAndSaveValues=function(args){var _a,_b;return __awaiter(this,void 0,void 0,(function(){var user,prefetchUsers,timeout,keyedPrefetchUsers,sinceTime,previousDerivedFields,_this=this;return __generator(this,(function(_c){return user=args.user,prefetchUsers=null!==(_a=args.prefetchUsers)&&void 0!==_a?_a:[],timeout=null!==(_b=args.timeout)&&void 0!==_b?_b:this.options.getInitTimeoutMs(),prefetchUsers.length>5&&this.consoleLogger.info("Cannot prefetch more than 5 users."),keyedPrefetchUsers=this.normalizePrefetchUsers(prefetchUsers).slice(0,5).reduce((function(acc,curr){return acc[(0,Hashing_1.getUserCacheKey)(_this.getStableID(),curr).v2]=curr,acc}),{}),sinceTime=null,0===prefetchUsers.length&&(sinceTime=this.store.getLastUpdateTime(user)),previousDerivedFields=this.store.getPreviousDerivedFields(user),[2,this.network.fetchValues({user:user,sinceTime:sinceTime,timeout:timeout,useDeltas:null!=sinceTime,prefetchUsers:prefetchUsers.length>0?keyedPrefetchUsers:void 0,previousDerivedFields:previousDerivedFields}).eventually((function(json){(null==json?void 0:json.has_updates)&&_this.store.saveWithoutUpdatingClientState(user,json,prefetchUsers.length>0?keyedPrefetchUsers:void 0).catch((function(reason){return _this.errorBoundary.logError("fetchAndSaveValues:eventually",reason)}))})).then((function(json){return __awaiter(_this,void 0,void 0,(function(){var _this=this;return __generator(this,(function(_a){return[2,this.errorBoundary.swallow("fetchAndSaveValues",(function(){return __awaiter(_this,void 0,void 0,(function(){return __generator(this,(function(_a){switch(_a.label){case 0:return Diagnostics_1.default.mark.intialize.process.start({}),(null==json?void 0:json.has_updates)?[4,this.store.save(user,json,prefetchUsers.length>0?keyedPrefetchUsers:void 0)]:[3,2];case 1:return _a.sent(),[3,3];case 2:(null==json?void 0:json.is_no_content)&&this.store.setEvaluationReason(EvaluationReason_1.EvaluationReason.NetworkNotModified),_a.label=3;case 3:return this.prefetchedUsersByCacheKey=__assign(__assign({},this.prefetchedUsersByCacheKey),keyedPrefetchUsers),Diagnostics_1.default.mark.intialize.process.end({success:!0}),[2]}}))}))}))]}))}))}))]}))}))},StatsigClient.prototype.checkGateImpl=function(gateName,ignoreOverrides){if(this.ensureStoreLoaded(),"string"!=typeof gateName||0===gateName.length)throw new Errors_1.StatsigInvalidArgumentError("Must pass a valid string as the gateName.");return this.store.checkGate(gateName,ignoreOverrides)},StatsigClient.prototype.logGateExposureImpl=function(gateName,fetchResult){var isManualExposure=!fetchResult,result=null!=fetchResult?fetchResult:this.checkGateImpl(gateName,!1),gate=result.gate;this.logger.logGateExposure(this.getCurrentUser(),gateName,gate.value,gate.rule_id,gate.secondary_exposures,result.evaluationDetails,isManualExposure)},StatsigClient.prototype.getConfigImpl=function(configName,ignoreOverrides){if(this.ensureStoreLoaded(),"string"!=typeof configName||0===configName.length)throw new Errors_1.StatsigInvalidArgumentError("Must pass a valid string as the configName.");return this.store.getConfig(configName,ignoreOverrides)},StatsigClient.prototype.logConfigExposureImpl=function(configName,config){var isManualExposure=!config,localConfig=null!=config?config:this.getConfigImpl(configName,!1);this.logger.logConfigExposure(this.getCurrentUser(),configName,localConfig.getRuleID(),localConfig._getSecondaryExposures(),localConfig.getEvaluationDetails(),isManualExposure)},StatsigClient.prototype.getExperimentImpl=function(experimentName,keepDeviceValue,ignoreOverrides){if(this.ensureStoreLoaded(),"string"!=typeof experimentName||0===experimentName.length)throw new Errors_1.StatsigInvalidArgumentError("Must pass a valid string as the experimentName.");return this.store.getExperiment(experimentName,keepDeviceValue,ignoreOverrides)},StatsigClient.prototype.logExperimentExposureImpl=function(experimentName,keepDeviceValue,config){var isManualExposure=!config,localConfig=null!=config?config:this.getExperimentImpl(experimentName,keepDeviceValue,!1);this.logger.logConfigExposure(this.getCurrentUser(),experimentName,localConfig.getRuleID(),localConfig._getSecondaryExposures(),localConfig.getEvaluationDetails(),isManualExposure)},StatsigClient.prototype.getLayerImpl=function(logParameterFunction,layerName,keepDeviceValue){if(this.ensureStoreLoaded(),"string"!=typeof layerName||0===layerName.length)throw new Errors_1.StatsigInvalidArgumentError("Must pass a valid string as the layerName.");return this.store.getLayer(logParameterFunction,layerName,keepDeviceValue)},StatsigClient.prototype.getEmptyConfig=function(configName){return new DynamicConfig_1.default(configName,{},"",this.getEvalutionDetailsForError())},StatsigClient.prototype.fireAndForgetPrefechUsers=function(){this.prefetchUsers(this.options.getPrefetchUsers()).catch((function(){}))},StatsigClient}();exports.default=StatsigClient;