"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){void 0===k2&&(k2=k),Object.defineProperty(o,k2,{enumerable:!0,get:function(){return m[k]}})}:function(o,m,k,k2){void 0===k2&&(k2=k),o[k2]=m[k]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,"default",{enumerable:!0,value:v})}:function(o,v){o.default=v}),__importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(null!=mod)for(var k in mod)"default"!==k&&Object.prototype.hasOwnProperty.call(mod,k)&&__createBinding(result,mod,k);return __setModuleDefault(result,mod),result},__importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{default:mod}};Object.defineProperty(exports,"__esModule",{value:!0});var react_1=__importStar(require("react")),StatsigContext_1=__importDefault(require("./StatsigContext")),statsig_js_1=__importDefault(require("statsig-js")),Statsig_1=__importDefault(require("./Statsig")),SDKVersion_1=require("./SDKVersion");function usePrevious(value){var ref=(0,react_1.useRef)(null);return(0,react_1.useEffect)((function(){ref.current=value}),[value]),ref.current}function StatsigProvider(_a){var children=_a.children,sdkKey=_a.sdkKey,user=_a.user,setUser=_a.setUser,options=_a.options,waitForCache=_a.waitForCache,waitForInitialization=_a.waitForInitialization,initializingComponent=_a.initializingComponent,mountKey=_a.mountKey,_b=_a.shutdownOnUnmount,shutdownOnUnmount=void 0!==_b&&_b,rnDeps=_a._reactNativeDependencies,isReactNative=!!rnDeps,_c=(0,react_1.useState)(!1),hasCacheValues=_c[0],setHasCacheValues=_c[1],_d=(0,react_1.useState)(!1),hasNetworkValues=_d[0],setHasNetworkValues=_d[1],resolver=(0,react_1.useRef)(null),_e=(0,react_1.useState)(0),userVersion=_e[0],setUserVersion=_e[1],statsigPromise=(0,react_1.useRef)(new Promise((function(resolve){resolver.current=resolve}))),userMemo=(0,react_1.useMemo)((function(){return user}),[JSON.stringify(user)]),prevMountKey=usePrevious(null!=mountKey?mountKey:null);(0,react_1.useEffect)((function(){if(Statsig_1.default.initializeCalled()){statsigPromise.current=new Promise((function(resolve){resolver.current=resolve}));var unmount_1=void 0===mountKey||prevMountKey!==mountKey;return unmount_1&&(setHasNetworkValues(!1),setHasCacheValues(!1)),void Statsig_1.default.updateUser(user).then((function(){resolver.current&&resolver.current(),setUserVersion((function(version){return version+1})),unmount_1&&(setHasNetworkValues(!0),setHasCacheValues(!0))}))}Statsig_1.default.setSDKPackageInfo({sdkType:"react-client",sdkVersion:SDKVersion_1.version}),isReactNative&&(Statsig_1.default.setSDKPackageInfo(rnDeps.SDKPackageInfo),Statsig_1.default.setAppState(rnDeps.AppState),Statsig_1.default.setAsyncStorage(rnDeps.AsyncStorage),Statsig_1.default.setNativeModules(rnDeps.NativeModules),Statsig_1.default.setPlatform(rnDeps.Platform),Statsig_1.default.setRNDeviceInfo(rnDeps.RNDevice),Statsig_1.default.setReactNativeUUID(rnDeps.ReactNativeUUID),Statsig_1.default.setExpoConstants(rnDeps.Constants),Statsig_1.default.setExpoDevice(rnDeps.ExpoDevice)),Statsig_1.default.setOnCacheLoadedCallback((function(){setHasCacheValues(!0)})),Statsig_1.default.initialize(sdkKey,userMemo,options).then((function(){setHasNetworkValues(!0),resolver.current&&resolver.current()})),"undefined"!=typeof window&&(window.__STATSIG_SDK__=Statsig_1.default,window.__STATSIG_JS_SDK__=statsig_js_1.default,window.__STATSIG_RERENDER_OVERRIDE__=function(){setUserVersion(userVersion+1)})}),[userMemo]),(0,react_1.useEffect)((function(){return Statsig_1.default.setReactContextUpdater((function(){return setUserVersion((function(version){return version+1}))})),function(){shutdownOnUnmount&&Statsig_1.default.shutdown(),Statsig_1.default.setReactContextUpdater(null)}}),[]);var child=pickChildToRender(!0===waitForCache,!0===waitForInitialization,hasNetworkValues,hasCacheValues,children,initializingComponent),contextValue=(0,react_1.useMemo)((function(){return{initialized:hasNetworkValues,statsigPromise:statsigPromise,userVersion:userVersion,initStarted:Statsig_1.default.initializeCalled(),updateUser:null!=setUser?setUser:function(){}}}),[hasNetworkValues,statsigPromise,userVersion,Statsig_1.default.initializeCalled(),setUser]);return react_1.default.createElement(StatsigContext_1.default.Provider,{value:contextValue},child)}function pickChildToRender(waitForCache,waitForInitialization,hasNetworkValues,hasCacheValues,children,initializingComponent){return hasNetworkValues||!0!==waitForInitialization&&!0!==waitForCache||waitForCache&&hasCacheValues||waitForInitialization&&hasNetworkValues?children:(waitForInitialization||waitForCache)&&null!=initializingComponent?initializingComponent:null}exports.default=StatsigProvider;