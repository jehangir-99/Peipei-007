"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.validateUnion=exports.validateArray=exports.usePattern=exports.callValidateCode=exports.schemaProperties=exports.allSchemaProperties=exports.noPropertyInData=exports.propertyInData=exports.isOwnProperty=exports.hasPropFunc=exports.reportMissingProp=exports.checkMissingProp=exports.checkReportMissingProp=void 0;const codegen_1=require("../compile/codegen"),util_1=require("../compile/util"),names_1=require("../compile/names"),util_2=require("../compile/util");function checkReportMissingProp(cxt,prop){const{gen:gen,data:data,it:it}=cxt;gen.if(noPropertyInData(gen,data,prop,it.opts.ownProperties),(()=>{cxt.setParams({missingProperty:codegen_1._`${prop}`},!0),cxt.error()}))}function checkMissingProp({gen:gen,data:data,it:{opts:opts}},properties,missing){return(0,codegen_1.or)(...properties.map((prop=>(0,codegen_1.and)(noPropertyInData(gen,data,prop,opts.ownProperties),codegen_1._`${missing} = ${prop}`))))}function reportMissingProp(cxt,missing){cxt.setParams({missingProperty:missing},!0),cxt.error()}function hasPropFunc(gen){return gen.scopeValue("func",{ref:Object.prototype.hasOwnProperty,code:codegen_1._`Object.prototype.hasOwnProperty`})}function isOwnProperty(gen,data,property){return codegen_1._`${hasPropFunc(gen)}.call(${data}, ${property})`}function propertyInData(gen,data,property,ownProperties){const cond=codegen_1._`${data}${(0,codegen_1.getProperty)(property)} !== undefined`;return ownProperties?codegen_1._`${cond} && ${isOwnProperty(gen,data,property)}`:cond}function noPropertyInData(gen,data,property,ownProperties){const cond=codegen_1._`${data}${(0,codegen_1.getProperty)(property)} === undefined`;return ownProperties?(0,codegen_1.or)(cond,(0,codegen_1.not)(isOwnProperty(gen,data,property))):cond}function allSchemaProperties(schemaMap){return schemaMap?Object.keys(schemaMap).filter((p=>"__proto__"!==p)):[]}function schemaProperties(it,schemaMap){return allSchemaProperties(schemaMap).filter((p=>!(0,util_1.alwaysValidSchema)(it,schemaMap[p])))}function callValidateCode({schemaCode:schemaCode,data:data,it:{gen:gen,topSchemaRef:topSchemaRef,schemaPath:schemaPath,errorPath:errorPath},it:it},func,context,passSchema){const dataAndSchema=passSchema?codegen_1._`${schemaCode}, ${data}, ${topSchemaRef}${schemaPath}`:data,valCxt=[[names_1.default.instancePath,(0,codegen_1.strConcat)(names_1.default.instancePath,errorPath)],[names_1.default.parentData,it.parentData],[names_1.default.parentDataProperty,it.parentDataProperty],[names_1.default.rootData,names_1.default.rootData]];it.opts.dynamicRef&&valCxt.push([names_1.default.dynamicAnchors,names_1.default.dynamicAnchors]);const args=codegen_1._`${dataAndSchema}, ${gen.object(...valCxt)}`;return context!==codegen_1.nil?codegen_1._`${func}.call(${context}, ${args})`:codegen_1._`${func}(${args})`}exports.checkReportMissingProp=checkReportMissingProp,exports.checkMissingProp=checkMissingProp,exports.reportMissingProp=reportMissingProp,exports.hasPropFunc=hasPropFunc,exports.isOwnProperty=isOwnProperty,exports.propertyInData=propertyInData,exports.noPropertyInData=noPropertyInData,exports.allSchemaProperties=allSchemaProperties,exports.schemaProperties=schemaProperties,exports.callValidateCode=callValidateCode;const newRegExp=codegen_1._`new RegExp`;function usePattern({gen:gen,it:{opts:opts}},pattern){const u=opts.unicodeRegExp?"u":"",{regExp:regExp}=opts.code,rx=regExp(pattern,u);return gen.scopeValue("pattern",{key:rx.toString(),ref:rx,code:codegen_1._`${"new RegExp"===regExp.code?newRegExp:(0,util_2.useFunc)(gen,regExp)}(${pattern}, ${u})`})}function validateArray(cxt){const{gen:gen,data:data,keyword:keyword,it:it}=cxt,valid=gen.name("valid");if(it.allErrors){const validArr=gen.let("valid",!0);return validateItems((()=>gen.assign(validArr,!1))),validArr}return gen.var(valid,!0),validateItems((()=>gen.break())),valid;function validateItems(notValid){const len=gen.const("len",codegen_1._`${data}.length`);gen.forRange("i",0,len,(i=>{cxt.subschema({keyword:keyword,dataProp:i,dataPropType:util_1.Type.Num},valid),gen.if((0,codegen_1.not)(valid),notValid)}))}}function validateUnion(cxt){const{gen:gen,schema:schema,keyword:keyword,it:it}=cxt;if(!Array.isArray(schema))throw new Error("ajv implementation error");if(schema.some((sch=>(0,util_1.alwaysValidSchema)(it,sch)))&&!it.opts.unevaluated)return;const valid=gen.let("valid",!1),schValid=gen.name("_valid");gen.block((()=>schema.forEach(((_sch,i)=>{const schCxt=cxt.subschema({keyword:keyword,schemaProp:i,compositeRule:!0},schValid);gen.assign(valid,codegen_1._`${valid} || ${schValid}`);cxt.mergeValidEvaluated(schCxt,schValid)||gen.if((0,codegen_1.not)(valid))})))),cxt.result(valid,(()=>cxt.reset()),(()=>cxt.error(!0)))}exports.usePattern=usePattern,exports.validateArray=validateArray,exports.validateUnion=validateUnion;