import React,{useMemo,useEffect,useRef,useState}from"react";import{useSelector,useDispatch,batch}from"react-redux";import{BigNumber}from"@ethersproject/bignumber";import{createSlice}from"@reduxjs/toolkit";var DEFAULT_BLOCKS_PER_FETCH=1,DEFAULT_CALL_GAS_REQUIRED=1e6,DEFAULT_CHUNK_GAS_REQUIRED=2e5,CHUNK_GAS_LIMIT=1e8,CONSERVATIVE_BLOCK_GAS_LIMIT=1e7,INVALID_RESULT={valid:!1,blockNumber:void 0,data:void 0},NEVER_RELOAD={blocksPerFetch:1/0},INVALID_CALL_STATE={valid:!1,result:void 0,loading:!1,syncing:!1,error:!1},LOADING_CALL_STATE={valid:!0,result:void 0,loading:!0,syncing:!0,error:!1};function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _extends(){return _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target},_extends.apply(this,arguments)}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _construct(Parent,args,Class){return _construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance},_construct.apply(null,arguments)}function _isNativeFunction(fn){return-1!==Function.toString.call(fn).indexOf("[native code]")}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;return _wrapNativeSuper=function(Class){if(null===Class||!_isNativeFunction(Class))return Class;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)},_wrapNativeSuper(Class)}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _createForOfIteratorHelperLoose(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(it)return(it=it.call(o)).next.bind(it);if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0;return function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function toCallKey(call){var key=call.address+"-"+call.callData;if(call.gasRequired){if(!Number.isSafeInteger(call.gasRequired))throw new Error("Invalid number: "+call.gasRequired);key+="-"+call.gasRequired}return key}function parseCallKey(callKey){var pcs=callKey.split("-");if(![2,3].includes(pcs.length))throw new Error("Invalid call key: "+callKey);return _extends({address:pcs[0],callData:pcs[1]},pcs[2]?{gasRequired:Number.parseInt(pcs[2])}:{})}function callsToCallKeys(calls){var _calls$filter$map$sor,_calls$filter,_calls$filter$map;return null!=(_calls$filter$map$sor=null==calls||null==(_calls$filter=calls.filter((function(c){return Boolean(c)})))||null==(_calls$filter$map=_calls$filter.map(toCallKey))?void 0:_calls$filter$map.sort())?_calls$filter$map$sor:[]}function callKeysToCalls(callKeys){return null!=callKeys&&callKeys.length?callKeys.map((function(key){return parseCallKey(key)})):null}function toCallState(callResult,contractInterface,fragment,latestBlockNumber){if(!callResult)return INVALID_CALL_STATE;var valid=callResult.valid,data=callResult.data,blockNumber=callResult.blockNumber;if(!valid)return INVALID_CALL_STATE;if(valid&&!blockNumber)return LOADING_CALL_STATE;if(!contractInterface||!fragment||!latestBlockNumber)return LOADING_CALL_STATE;var success=data&&data.length>2,syncing=(null!=blockNumber?blockNumber:0)<latestBlockNumber,result=void 0;if(success&&data)try{result=contractInterface.decodeFunctionResult(fragment,data)}catch(error){return console.debug("Result data parsing failed",fragment,data),{valid:!0,loading:!1,error:!0,syncing:syncing,result:result}}return{valid:!0,loading:!1,syncing:syncing,result:result,error:!success}}function isMethodArg(x){return BigNumber.isBigNumber(x)||-1!==["string","number"].indexOf(typeof x)}function isValidMethodArgs(x){return void 0===x||Array.isArray(x)&&x.every((function(xi){return isMethodArg(xi)||Array.isArray(xi)&&xi.every(isMethodArg)}))}function useCallsDataSubscription(context,chainId,calls,listenerOptions){var reducerPath=context.reducerPath,actions=context.actions,callResults=useSelector((function(state){return state[reducerPath].callResults})),defaultListenerOptions=useSelector((function(state){return state[reducerPath].listenerOptions})),dispatch=useDispatch(),serializedCallKeys=useMemo((function(){return JSON.stringify(callsToCallKeys(calls))}),[calls]);useEffect((function(){var _chainId,_ref,_listenerOptions$bloc,calls=callKeysToCalls(JSON.parse(serializedCallKeys));if(chainId&&calls){var blocksPerFetchFromState=null==(_chainId=(null!=defaultListenerOptions?defaultListenerOptions:{})[chainId])?void 0:_chainId.blocksPerFetch,blocksPerFetchForChain=null!=(_ref=null!=(_listenerOptions$bloc=null==listenerOptions?void 0:listenerOptions.blocksPerFetch)?_listenerOptions$bloc:blocksPerFetchFromState)?_ref:DEFAULT_BLOCKS_PER_FETCH;return dispatch(actions.addMulticallListeners({chainId:chainId,calls:calls,options:{blocksPerFetch:blocksPerFetchForChain}})),function(){dispatch(actions.removeMulticallListeners({chainId:chainId,calls:calls,options:{blocksPerFetch:blocksPerFetchForChain}}))}}}),[actions,chainId,dispatch,listenerOptions,serializedCallKeys,defaultListenerOptions]);var stableResults=useRef([]);return useMemo((function(){for(var results=[],i=0;i<calls.length;++i){var _callResults$chainId,call=calls[i];if(chainId&&call){var result=null==(_callResults$chainId=callResults[chainId])?void 0:_callResults$chainId[toCallKey(call)],data=null!=result&&result.data&&"0x"!==result.data?result.data:void 0;results.push({valid:!0,data:data,blockNumber:null==result?void 0:result.blockNumber})}else results.push(INVALID_RESULT)}return areCallResultsEqual(results,stableResults.current)||(stableResults.current=results),stableResults.current}),[callResults,calls,chainId])}function areCallResultsEqual(a,b){return a.length===b.length&&a.every((function(_,i){return a[i].valid===b[i].valid&&a[i].data===b[i].data&&a[i].blockNumber===b[i].blockNumber}))}function useMultichainCallsDataSubscription(context,chainToCalls,listenerOptions){var reducerPath=context.reducerPath,actions=context.actions,callResults=useSelector((function(state){return state[reducerPath].callResults})),defaultListenerOptions=useSelector((function(state){return state[reducerPath].listenerOptions})),dispatch=useDispatch(),serializedCallKeys=useMemo((function(){var chainCallKeysTuple=getChainIds(chainToCalls).sort().map((function(chainId){return[chainId,callsToCallKeys(chainToCalls[chainId])]}));return JSON.stringify(chainCallKeysTuple)}),[chainToCalls]);return useEffect((function(){var chainCallKeysTuples=JSON.parse(serializedCallKeys);if(null!=chainCallKeysTuples&&chainCallKeysTuples.length)return batch((function(){for(var _step,_iterator=_createForOfIteratorHelperLoose(chainCallKeysTuples);!(_step=_iterator()).done;){var _chainId2,_ref2,_listenerOptions$bloc2,_step$value=_step.value,chainId=_step$value[0],calls=callKeysToCalls(_step$value[1]);if(null!=calls&&calls.length){var blocksPerFetchFromState=null==(_chainId2=(null!=defaultListenerOptions?defaultListenerOptions:{})[chainId])?void 0:_chainId2.blocksPerFetch,blocksPerFetchForChain=null!=(_ref2=null!=(_listenerOptions$bloc2=null==listenerOptions?void 0:listenerOptions.blocksPerFetch)?_listenerOptions$bloc2:blocksPerFetchFromState)?_ref2:DEFAULT_BLOCKS_PER_FETCH;dispatch(actions.addMulticallListeners({chainId:chainId,calls:calls,options:{blocksPerFetch:blocksPerFetchForChain}}))}}})),function(){batch((function(){for(var _step2,_iterator2=_createForOfIteratorHelperLoose(chainCallKeysTuples);!(_step2=_iterator2()).done;){var _chainId3,_ref3,_listenerOptions$bloc3,_step2$value=_step2.value,chainId=_step2$value[0],calls=callKeysToCalls(_step2$value[1]);if(null!=calls&&calls.length){var blocksPerFetchFromState=null==(_chainId3=(null!=defaultListenerOptions?defaultListenerOptions:{})[chainId])?void 0:_chainId3.blocksPerFetch,blocksPerFetchForChain=null!=(_ref3=null!=(_listenerOptions$bloc3=null==listenerOptions?void 0:listenerOptions.blocksPerFetch)?_listenerOptions$bloc3:blocksPerFetchFromState)?_ref3:DEFAULT_BLOCKS_PER_FETCH;dispatch(actions.removeMulticallListeners({chainId:chainId,calls:calls,options:{blocksPerFetch:blocksPerFetchForChain}}))}}}))}}),[actions,dispatch,listenerOptions,serializedCallKeys,defaultListenerOptions]),useMemo((function(){return getChainIds(chainToCalls).reduce((function(result,chainId){var calls=chainToCalls[chainId];return result[chainId]=calls.map((function(call){var _callResults$chainId2;if(!chainId||!call)return INVALID_RESULT;var result=null==(_callResults$chainId2=callResults[chainId])?void 0:_callResults$chainId2[toCallKey(call)];return{valid:!0,data:null!=result&&result.data&&"0x"!==result.data?result.data:void 0,blockNumber:null==result?void 0:result.blockNumber}})),result}),{})}),[callResults,chainToCalls])}function useSingleContractMultipleData(context,chainId,latestBlockNumber,contract,methodName,callInputs,options){var gasRequired=(null!=options?options:{}).gasRequired,fragment=useMemo((function(){var _contract$interface;return null==contract||null==(_contract$interface=contract.interface)?void 0:_contract$interface.getFunction(methodName)}),[contract,methodName]),callDatas=useMemo((function(){return contract&&fragment?callInputs.map((function(callInput){return isValidMethodArgs(callInput)?contract.interface.encodeFunctionData(fragment,callInput):void 0})):[]}),[callInputs,contract,fragment]),results=useCallsDataSubscription(context,chainId,useMemo((function(){return contract?callDatas.map((function(callData){if(callData)return{address:contract.address,callData:callData,gasRequired:gasRequired}})):[]}),[contract,callDatas,gasRequired]),options);return useMemo((function(){return results.map((function(result){return toCallState(result,null==contract?void 0:contract.interface,fragment,latestBlockNumber)}))}),[results,contract,fragment,latestBlockNumber])}function useMultipleContractSingleData(context,chainId,latestBlockNumber,addresses,contractInterface,methodName,callInputs,options){var gasRequired=(null!=options?options:{}).gasRequired,_useCallData=useCallData(methodName,contractInterface,callInputs),fragment=_useCallData.fragment,callData=_useCallData.callData,results=useCallsDataSubscription(context,chainId,useMemo((function(){return callData?addresses.map((function(address){if(address)return{address:address,callData:callData,gasRequired:gasRequired}})):[]}),[addresses,callData,gasRequired]),options);return useMemo((function(){return results.map((function(result){return toCallState(result,contractInterface,fragment,latestBlockNumber)}))}),[fragment,results,contractInterface,latestBlockNumber])}function useSingleCallResult(context,chainId,latestBlockNumber,contract,methodName,inputs,options){var _useSingleContractMul;return null!=(_useSingleContractMul=useSingleContractMultipleData(context,chainId,latestBlockNumber,contract,methodName,useMemo((function(){return[inputs]}),[inputs]),options)[0])?_useSingleContractMul:INVALID_CALL_STATE}function useSingleContractWithCallData(context,chainId,latestBlockNumber,contract,callDatas,options){var gasRequired=(null!=options?options:{}).gasRequired,results=useCallsDataSubscription(context,chainId,useMemo((function(){return contract?callDatas.map((function(callData){return{address:contract.address,callData:callData,gasRequired:gasRequired}})):[]}),[contract,callDatas,gasRequired]),options);return useMemo((function(){return results.map((function(result,i){var _contract$interface2;return toCallState(result,null==contract?void 0:contract.interface,null==contract||null==(_contract$interface2=contract.interface)?void 0:_contract$interface2.getFunction(callDatas[i].substring(0,10)),latestBlockNumber)}))}),[results,contract,callDatas,latestBlockNumber])}function useMultiChainMultiContractSingleData(context,chainToBlockNumber,chainToAddresses,contractInterface,methodName,callInputs,options){var gasRequired=(null!=options?options:{}).gasRequired,_useCallData2=useCallData(methodName,contractInterface,callInputs),fragment=_useCallData2.fragment,callData=_useCallData2.callData,chainIdToResults=useMultichainCallsDataSubscription(context,useMemo((function(){return callData&&chainToAddresses?getChainIds(chainToAddresses).reduce((function(result,chainId){var calls=chainToAddresses[chainId].map((function(address){if(address)return{address:address,callData:callData,gasRequired:gasRequired}}));return result[chainId]=calls,result}),{}):{}}),[chainToAddresses,callData,gasRequired]),options);return useMemo((function(){return getChainIds(chainIdToResults).reduce((function(combinedResults,chainId){var latestBlockNumber=null==chainToBlockNumber?void 0:chainToBlockNumber[chainId],results=chainIdToResults[chainId];return combinedResults[chainId]=results.map((function(result){return toCallState(result,contractInterface,fragment,latestBlockNumber)})),combinedResults}),{})}),[fragment,contractInterface,chainIdToResults,chainToBlockNumber])}function useMultiChainSingleContractSingleData(context,chainToBlockNumber,chainToAddress,contractInterface,methodName,callInputs,options){var multiContractResults=useMultiChainMultiContractSingleData(context,chainToBlockNumber,useMemo((function(){return getChainIds(chainToAddress).reduce((function(result,chainId){return result[chainId]=[chainToAddress[chainId]],result}),{})}),[chainToAddress]),contractInterface,methodName,callInputs,options);return useMemo((function(){return getChainIds(chainToAddress).reduce((function(result,chainId){var _multiContractResults,_multiContractResults2;return result[chainId]=null!=(_multiContractResults=null==(_multiContractResults2=multiContractResults[chainId])?void 0:_multiContractResults2[0])?_multiContractResults:INVALID_CALL_STATE,result}),{})}),[chainToAddress,multiContractResults])}function useCallData(methodName,contractInterface,callInputs){var fragment=useMemo((function(){return null==contractInterface?void 0:contractInterface.getFunction(methodName)}),[contractInterface,methodName]),callData=useMemo((function(){return fragment&&isValidMethodArgs(callInputs)?null==contractInterface?void 0:contractInterface.encodeFunctionData(fragment,callInputs):void 0}),[callInputs,contractInterface,fragment]);return{fragment:fragment,callData:callData}}function getChainIds(chainIdMap){return Object.keys(chainIdMap).map((function(c){return parseInt(c,10)}))}var initialState={callResults:{}};function createMulticallSlice(reducerPath){return createSlice({name:reducerPath,initialState:initialState,reducers:{addMulticallListeners:function(state,action){var _listeners$chainId,_action$payload=action.payload,calls=_action$payload.calls,chainId=_action$payload.chainId,blocksPerFetch=_action$payload.options.blocksPerFetch,listeners=state.callListeners?state.callListeners:state.callListeners={};listeners[chainId]=null!=(_listeners$chainId=listeners[chainId])?_listeners$chainId:{},calls.forEach((function(call){var _listeners$chainId$ca,_listeners$chainId$ca2,callKey=toCallKey(call);listeners[chainId][callKey]=null!=(_listeners$chainId$ca=listeners[chainId][callKey])?_listeners$chainId$ca:{},listeners[chainId][callKey][blocksPerFetch]=(null!=(_listeners$chainId$ca2=listeners[chainId][callKey][blocksPerFetch])?_listeners$chainId$ca2:0)+1}))},removeMulticallListeners:function(state,action){var _action$payload2=action.payload,calls=_action$payload2.calls,chainId=_action$payload2.chainId,blocksPerFetch=_action$payload2.options.blocksPerFetch,listeners=state.callListeners?state.callListeners:state.callListeners={};listeners[chainId]&&calls.forEach((function(call){var callKey=toCallKey(call);listeners[chainId][callKey]&&listeners[chainId][callKey][blocksPerFetch]&&(1===listeners[chainId][callKey][blocksPerFetch]?delete listeners[chainId][callKey][blocksPerFetch]:listeners[chainId][callKey][blocksPerFetch]--)}))},fetchingMulticallResults:function(state,action){var _state$callResults$ch,_action$payload3=action.payload,chainId=_action$payload3.chainId,fetchingBlockNumber=_action$payload3.fetchingBlockNumber,calls=_action$payload3.calls;state.callResults[chainId]=null!=(_state$callResults$ch=state.callResults[chainId])?_state$callResults$ch:{},calls.forEach((function(call){var callKey=toCallKey(call),current=state.callResults[chainId][callKey];if(current){var _current$fetchingBloc;if((null!=(_current$fetchingBloc=current.fetchingBlockNumber)?_current$fetchingBloc:0)>=fetchingBlockNumber)return;state.callResults[chainId][callKey].fetchingBlockNumber=fetchingBlockNumber}else state.callResults[chainId][callKey]={fetchingBlockNumber:fetchingBlockNumber}}))},errorFetchingMulticallResults:function(state,action){var _state$callResults$ch2,_action$payload4=action.payload,chainId=_action$payload4.chainId,fetchingBlockNumber=_action$payload4.fetchingBlockNumber,calls=_action$payload4.calls;state.callResults[chainId]=null!=(_state$callResults$ch2=state.callResults[chainId])?_state$callResults$ch2:{},calls.forEach((function(call){var callKey=toCallKey(call),current=state.callResults[chainId][callKey];current&&"number"==typeof current.fetchingBlockNumber&&current.fetchingBlockNumber<=fetchingBlockNumber&&(delete current.fetchingBlockNumber,current.data=null,current.blockNumber=fetchingBlockNumber)}))},updateMulticallResults:function(state,action){var _state$callResults$ch3,_action$payload5=action.payload,chainId=_action$payload5.chainId,results=_action$payload5.results,blockNumber=_action$payload5.blockNumber;state.callResults[chainId]=null!=(_state$callResults$ch3=state.callResults[chainId])?_state$callResults$ch3:{},Object.keys(results).forEach((function(callKey){var _current$blockNumber,current=state.callResults[chainId][callKey];(null!=(_current$blockNumber=null==current?void 0:current.blockNumber)?_current$blockNumber:0)>blockNumber||(null==current?void 0:current.data)===results[callKey]&&(null==current?void 0:current.blockNumber)===blockNumber||(state.callResults[chainId][callKey]={data:results[callKey],blockNumber:blockNumber})}))},updateListenerOptions:function(state,action){var _state$listenerOption,_action$payload6=action.payload,chainId=_action$payload6.chainId,listenerOptions=_action$payload6.listenerOptions;state.listenerOptions=null!=(_state$listenerOption=state.listenerOptions)?_state$listenerOption:{},state.listenerOptions[chainId]=listenerOptions}}})}function createCommonjsModule(fn,module){return fn(module={exports:{}},module.exports),module.exports}var runtime_1=createCommonjsModule((function(module){var runtime=function(exports){var undefined$1,Op=Object.prototype,hasOwn=Op.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag";function define(obj,key,value){return Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}),obj[key]}try{define({},"")}catch(err){define=function(obj,key,value){return obj[key]=value}}function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return generator._invoke=function(innerFn,self,context){var state=GenStateSuspendedStart;return function(method,arg){if(state===GenStateExecuting)throw new Error("Generator is already running");if(state===GenStateCompleted){if("throw"===method)throw arg;return doneResult()}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if(state===GenStateSuspendedStart)throw state=GenStateCompleted,context.arg;context.dispatchException(context.arg)}else"return"===context.method&&context.abrupt("return",context.arg);state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?GenStateCompleted:GenStateSuspendedYield,record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done}}"throw"===record.type&&(state=GenStateCompleted,context.method="throw",context.arg=record.arg)}}}(innerFn,self,context),generator}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}exports.wrap=wrap;var GenStateSuspendedStart="suspendedStart",GenStateSuspendedYield="suspendedYield",GenStateExecuting="executing",GenStateCompleted="completed",ContinueSentinel={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var IteratorPrototype={};define(IteratorPrototype,iteratorSymbol,(function(){return this}));var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);function defineIteratorMethods(prototype){["next","throw","return"].forEach((function(method){define(prototype,method,(function(arg){return this._invoke(method,arg)}))}))}function AsyncIterator(generator,PromiseImpl){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"==typeof value&&hasOwn.call(value,"__await")?PromiseImpl.resolve(value.__await).then((function(value){invoke("next",value,resolve,reject)}),(function(err){invoke("throw",err,resolve,reject)})):PromiseImpl.resolve(value).then((function(unwrapped){result.value=unwrapped,resolve(result)}),(function(error){return invoke("throw",error,resolve,reject)}))}reject(record.arg)}var previousPromise;this._invoke=function(method,arg){function callInvokeWithMethodAndArg(){return new PromiseImpl((function(resolve,reject){invoke(method,arg,resolve,reject)}))}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(method===undefined$1){if(context.delegate=null,"throw"===context.method){if(delegate.iterator.return&&(context.method="return",context.arg=undefined$1,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined$1),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel)}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0)}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;)if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;return next.value=undefined$1,next.done=!0,next};return next.next=next}}return{next:doneResult}}function doneResult(){return{value:undefined$1,done:!0}}return GeneratorFunction.prototype=GeneratorFunctionPrototype,define(Gp,"constructor",GeneratorFunctionPrototype),define(GeneratorFunctionPrototype,"constructor",GeneratorFunction),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,toStringTagSymbol,"GeneratorFunction"),exports.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name))},exports.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,define(genFun,toStringTagSymbol,"GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun},exports.awrap=function(arg){return{__await:arg}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,asyncIteratorSymbol,(function(){return this})),exports.AsyncIterator=AsyncIterator,exports.async=function(innerFn,outerFn,self,tryLocsList,PromiseImpl){void 0===PromiseImpl&&(PromiseImpl=Promise);var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList),PromiseImpl);return exports.isGeneratorFunction(outerFn)?iter:iter.next().then((function(result){return result.done?result.value:iter.next()}))},defineIteratorMethods(Gp),define(Gp,toStringTagSymbol,"Generator"),define(Gp,iteratorSymbol,(function(){return this})),define(Gp,"toString",(function(){return"[object Generator]"})),exports.keys=function(object){var keys=[];for(var key in object)keys.push(key);return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next}return next.done=!0,next}},exports.values=values,Context.prototype={constructor:Context,reset:function(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined$1,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined$1,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this)"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined$1)},stop:function(){this.done=!0;var rootRecord=this.tryEntries[0].completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval},dispatchException:function(exception){if(this.done)throw exception;var context=this;function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined$1),!!caught}for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0)}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record)},complete:function(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel}},catch:function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined$1),ContinueSentinel}},exports}(module.exports);try{regeneratorRuntime=runtime}catch(accidentalStrictMode){"object"==typeof globalThis?globalThis.regeneratorRuntime=runtime:Function("r","regeneratorRuntime = r")(runtime)}}));function chunkCalls(calls,chunkGasLimit,defaultGasRequired){return void 0===defaultGasRequired&&(defaultGasRequired=DEFAULT_CHUNK_GAS_REQUIRED),calls.sort((function(c1,c2){var _c2$gasRequired,_c1$gasRequired;return(null!=(_c2$gasRequired=c2.gasRequired)?_c2$gasRequired:defaultGasRequired)-(null!=(_c1$gasRequired=c1.gasRequired)?_c1$gasRequired:defaultGasRequired)})).reduce((function(bins,call){for(var _call$gasRequired,_step,gas=null!=(_call$gasRequired=call.gasRequired)?_call$gasRequired:defaultGasRequired,_iterator=_createForOfIteratorHelperLoose(bins);!(_step=_iterator()).done;){var bin=_step.value;if(bin.cumulativeGasLimit+gas<=chunkGasLimit)return bin.calls.push(call),bin.cumulativeGasLimit+=gas,bins}return bins.push({calls:[call],cumulativeGasLimit:gas}),bins}),[]).map((function(b){return b.calls}))}function wait(ms){return new Promise((function(resolve){return setTimeout(resolve,ms)}))}function waitRandom(min,max){return wait(min+Math.round(Math.random()*Math.max(0,max-min)))}var CancelledError=function(_Error){function CancelledError(){var _this;return(_this=_Error.call(this,"Cancelled")||this).isCancelledError=!0,_this}return _inheritsLoose(CancelledError,_Error),CancelledError}(_wrapNativeSuper(Error)),RetryableError=function(_Error2){function RetryableError(){var _this2;return(_this2=_Error2.apply(this,arguments)||this).isRetryableError=!0,_this2}return _inheritsLoose(RetryableError,_Error2),RetryableError}(_wrapNativeSuper(Error));function retry(fn,_ref){var rejectCancelled,n=_ref.n,minWait=_ref.minWait,maxWait=_ref.maxWait,completed=!1,promise=new Promise(function(){var _ref2=_asyncToGenerator(runtime_1.mark((function _callee(resolve,reject){var result;return runtime_1.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:rejectCancelled=reject;case 1:return result=void 0,_context.prev=3,_context.next=6,fn();case 6:return result=_context.sent,completed||(resolve(result),completed=!0),_context.abrupt("break",24);case 11:if(_context.prev=11,_context.t0=_context.catch(3),!completed){_context.next=15;break}return _context.abrupt("break",24);case 15:if(!(n<=0)&&_context.t0.isRetryableError){_context.next=19;break}return reject(_context.t0),completed=!0,_context.abrupt("break",24);case 19:n--;case 20:return _context.next=22,waitRandom(minWait,maxWait);case 22:_context.next=1;break;case 24:case"end":return _context.stop()}}),_callee,null,[[3,11]])})));return function(_x,_x2){return _ref2.apply(this,arguments)}}());return{promise:promise,cancel:function(){completed||(completed=!0,rejectCancelled(new CancelledError))}}}function useDebounce(value,delay){var _useState=useState(value),debouncedValue=_useState[0],setDebouncedValue=_useState[1];return useEffect((function(){var handler=setTimeout((function(){setDebouncedValue(value)}),delay);return function(){clearTimeout(handler)}}),[value,delay]),debouncedValue}var FETCH_RETRY_CONFIG={n:1/0,minWait:1e3,maxWait:2500};function fetchChunk(_x,_x2,_x3,_x4){return _fetchChunk.apply(this,arguments)}function _fetchChunk(){return(_fetchChunk=_asyncToGenerator(runtime_1.mark((function _callee(multicall,chunk,blockNumber,isDebug){var _yield$multicall$call,returnData,_error$message,_error$message2,error,half,_yield$Promise$all,c0,c1;return runtime_1.wrap((function(_context){for(;;)switch(_context.prev=_context.next){case 0:return console.debug("Fetching chunk",chunk,blockNumber),_context.prev=1,_context.next=4,multicall.callStatic.multicall(chunk.map((function(obj){var _obj$gasRequired;return{target:obj.address,callData:obj.callData,gasLimit:null!=(_obj$gasRequired=obj.gasRequired)?_obj$gasRequired:DEFAULT_CALL_GAS_REQUIRED}})),{blockTag:blockNumber});case 4:return _yield$multicall$call=_context.sent,returnData=_yield$multicall$call.returnData,isDebug&&returnData.forEach((function(_ref,i){var _chunk$i$gasRequired,_chunk$i$gasRequired2,gasUsed=_ref.gasUsed,returnData=_ref.returnData;!_ref.success&&2===returnData.length&&gasUsed.gte(Math.floor(.95*(null!=(_chunk$i$gasRequired=chunk[i].gasRequired)?_chunk$i$gasRequired:DEFAULT_CALL_GAS_REQUIRED)))&&console.warn("A call failed due to requiring "+gasUsed.toString()+" vs. allowed "+(null!=(_chunk$i$gasRequired2=chunk[i].gasRequired)?_chunk$i$gasRequired2:DEFAULT_CALL_GAS_REQUIRED),chunk[i])})),_context.abrupt("return",returnData);case 10:if(_context.prev=10,_context.t0=_context.catch(1),-32e3!==(error=_context.t0).code&&-1===(null==(_error$message=error.message)?void 0:_error$message.indexOf("header not found"))){_context.next=17;break}throw new RetryableError("header not found for block number "+blockNumber);case 17:if(-32603!==error.code&&-1===(null==(_error$message2=error.message)?void 0:_error$message2.indexOf("execution ran out of gas"))){_context.next=27;break}if(!(chunk.length>1)){_context.next=27;break}return"development"===process.env.NODE_ENV&&console.debug("Splitting a chunk in 2",chunk),half=Math.floor(chunk.length/2),_context.next=23,Promise.all([fetchChunk(multicall,chunk.slice(0,half),blockNumber),fetchChunk(multicall,chunk.slice(half,chunk.length),blockNumber)]);case 23:return _yield$Promise$all=_context.sent,c0=_yield$Promise$all[0],c1=_yield$Promise$all[1],_context.abrupt("return",c0.concat(c1));case 27:throw console.error("Failed to fetch chunk",error),error;case 29:case"end":return _context.stop()}}),_callee,null,[[1,10]])})))).apply(this,arguments)}function activeListeningKeys(allListeners,chainId){if(!allListeners||!chainId)return{};var listeners=allListeners[chainId];return listeners?Object.keys(listeners).reduce((function(memo,callKey){var keyListeners=listeners[callKey];return memo[callKey]=Object.keys(keyListeners).filter((function(key){var blocksPerFetch=parseInt(key);return!(blocksPerFetch<=0)&&keyListeners[blocksPerFetch]>0})).reduce((function(previousMin,current){return Math.min(previousMin,parseInt(current))}),1/0),memo}),{}):{}}function outdatedListeningKeys(callResults,listeningKeys,chainId,latestBlockNumber){return chainId&&latestBlockNumber?callResults[chainId]?Object.keys(listeningKeys).filter((function(callKey){var blocksPerFetch=listeningKeys[callKey],data=callResults[chainId][callKey];if(!data)return!0;var minDataBlockNumber=latestBlockNumber-(blocksPerFetch-1);return!(data.fetchingBlockNumber&&data.fetchingBlockNumber>=minDataBlockNumber)&&(!data.blockNumber||data.blockNumber<minDataBlockNumber)})):Object.keys(listeningKeys):[]}function onFetchChunkSuccess(context,chunk,result){var actions=context.actions,dispatch=context.dispatch,chainId=context.chainId,latestBlockNumber=context.latestBlockNumber,isDebug=context.isDebug,_chunk$reduce=chunk.reduce((function(memo,call,i){var _result$i$returnData;result[i].success?memo.results[toCallKey(call)]=null!=(_result$i$returnData=result[i].returnData)?_result$i$returnData:null:memo.erroredCalls.push(call);return memo}),{erroredCalls:[],results:{}}),erroredCalls=_chunk$reduce.erroredCalls,results=_chunk$reduce.results;Object.keys(results).length>0&&dispatch(actions.updateMulticallResults({chainId:chainId,results:results,blockNumber:latestBlockNumber})),erroredCalls.length>0&&(isDebug?result.forEach((function(returnData,ix){returnData.success||console.debug("Call failed",chunk[ix],returnData)})):console.debug("Calls errored in fetch",erroredCalls),dispatch(actions.errorFetchingMulticallResults({calls:erroredCalls,chainId:chainId,fetchingBlockNumber:latestBlockNumber})))}function onFetchChunkFailure(context,chunk,error){var actions=context.actions,dispatch=context.dispatch,chainId=context.chainId,latestBlockNumber=context.latestBlockNumber;error.isCancelledError?console.debug("Cancelled fetch for blockNumber",latestBlockNumber,chunk,chainId):(console.error("Failed to fetch multicall chunk",chunk,chainId,error),dispatch(actions.errorFetchingMulticallResults({calls:chunk,chainId:chainId,fetchingBlockNumber:latestBlockNumber})))}function Updater(props){var context=props.context,chainId=props.chainId,latestBlockNumber=props.latestBlockNumber,contract=props.contract,isDebug=props.isDebug,listenerOptions=props.listenerOptions,actions=context.actions,reducerPath=context.reducerPath,dispatch=useDispatch();useEffect((function(){chainId&&listenerOptions&&dispatch(actions.updateListenerOptions({chainId:chainId,listenerOptions:listenerOptions}))}),[chainId,listenerOptions,actions,dispatch]);var state=useSelector((function(state){return state[reducerPath]})),debouncedListeners=useDebounce(state.callListeners,100),cancellations=useRef(),listeningKeys=useMemo((function(){return activeListeningKeys(debouncedListeners,chainId)}),[debouncedListeners,chainId]),serializedOutdatedCallKeys=useMemo((function(){var outdatedCallKeys=outdatedListeningKeys(state.callResults,listeningKeys,chainId,latestBlockNumber);return JSON.stringify(outdatedCallKeys.sort())}),[chainId,state.callResults,listeningKeys,latestBlockNumber]);return useEffect((function(){if(latestBlockNumber&&chainId&&contract){var outdatedCallKeys=JSON.parse(serializedOutdatedCallKeys);if(0!==outdatedCallKeys.length){var calls=outdatedCallKeys.map((function(key){return parseCallKey(key)})),chunkedCalls=chunkCalls(calls,CHUNK_GAS_LIMIT);cancellations.current&&cancellations.current.blockNumber!==latestBlockNumber&&cancellations.current.cancellations.forEach((function(c){return c()})),dispatch(actions.fetchingMulticallResults({calls:calls,chainId:chainId,fetchingBlockNumber:latestBlockNumber}));var fetchChunkContext={actions:actions,dispatch:dispatch,chainId:chainId,latestBlockNumber:latestBlockNumber,isDebug:isDebug},newCancellations=chunkedCalls.map((function(chunk){var _retry=retry((function(){return fetchChunk(contract,chunk,latestBlockNumber,isDebug)}),FETCH_RETRY_CONFIG),cancel=_retry.cancel;return _retry.promise.then((function(result){return onFetchChunkSuccess(fetchChunkContext,chunk,result)})).catch((function(error){return onFetchChunkFailure(fetchChunkContext,chunk,error)})),cancel}));cancellations.current={blockNumber:latestBlockNumber,cancellations:newCancellations}}}}),[actions,chainId,contract,dispatch,serializedOutdatedCallKeys,latestBlockNumber,isDebug]),null}function createUpdater(context){return function(props){return React.createElement(Updater,Object.assign({context:context},props))}}function createMulticall(options){var _options$reducerPath,reducerPath=null!=(_options$reducerPath=null==options?void 0:options.reducerPath)?_options$reducerPath:"multicall",slice=createMulticallSlice(reducerPath),actions=slice.actions,reducer=slice.reducer,context={reducerPath:reducerPath,actions:actions},hooks={useMultipleContractSingleData:function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return useMultipleContractSingleData.apply(void 0,[context].concat(args))},useSingleContractMultipleData:function(){for(var _len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];return useSingleContractMultipleData.apply(void 0,[context].concat(args))},useSingleContractWithCallData:function(){for(var _len3=arguments.length,args=new Array(_len3),_key3=0;_key3<_len3;_key3++)args[_key3]=arguments[_key3];return useSingleContractWithCallData.apply(void 0,[context].concat(args))},useSingleCallResult:function(){for(var _len4=arguments.length,args=new Array(_len4),_key4=0;_key4<_len4;_key4++)args[_key4]=arguments[_key4];return useSingleCallResult.apply(void 0,[context].concat(args))},useMultiChainMultiContractSingleData:function(){for(var _len5=arguments.length,args=new Array(_len5),_key5=0;_key5<_len5;_key5++)args[_key5]=arguments[_key5];return useMultiChainMultiContractSingleData.apply(void 0,[context].concat(args))},useMultiChainSingleContractSingleData:function(){for(var _len6=arguments.length,args=new Array(_len6),_key6=0;_key6<_len6;_key6++)args[_key6]=arguments[_key6];return useMultiChainSingleContractSingleData.apply(void 0,[context].concat(args))}};return{reducerPath:reducerPath,reducer:reducer,actions:actions,hooks:hooks,Updater:createUpdater(context)}}export{CHUNK_GAS_LIMIT,CONSERVATIVE_BLOCK_GAS_LIMIT,DEFAULT_BLOCKS_PER_FETCH,DEFAULT_CALL_GAS_REQUIRED,DEFAULT_CHUNK_GAS_REQUIRED,INVALID_CALL_STATE,INVALID_RESULT,LOADING_CALL_STATE,NEVER_RELOAD,createMulticall};