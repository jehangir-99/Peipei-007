"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.V2DutchOrderBuilder=void 0;const tslib_1=require("tslib"),ethers_1=require("ethers"),tiny_invariant_1=tslib_1.__importDefault(require("tiny-invariant")),constants_1=require("../constants"),order_1=require("../order"),utils_1=require("../utils"),OrderBuilder_1=require("./OrderBuilder");class V2DutchOrderBuilder extends OrderBuilder_1.OrderBuilder{static fromOrder(order){const builder=new V2DutchOrderBuilder(order.chainId,order.info.reactor).deadline(order.info.deadline).swapper(order.info.swapper).nonce(order.info.nonce).input(order.info.input).cosigner(order.info.cosigner).validation({additionalValidationContract:order.info.additionalValidationContract,additionalValidationData:order.info.additionalValidationData});for(const output of order.info.outputs)builder.output(output);return isCosigned(order)&&(builder.cosignature(order.info.cosignature),builder.decayEndTime(order.info.cosignerData.decayEndTime),builder.decayStartTime(order.info.cosignerData.decayStartTime),builder.cosignerData(order.info.cosignerData)),builder}constructor(chainId,reactorAddress,_permit2Address){super(),this.chainId=chainId,this.reactor((0,utils_1.getReactor)(chainId,constants_1.OrderType.Dutch_V2,reactorAddress)),this.permit2Address=(0,utils_1.getPermit2)(chainId,_permit2Address),this.info={outputs:[],cosignerData:{decayStartTime:0,decayEndTime:0,exclusiveFiller:ethers_1.ethers.constants.AddressZero,exclusivityOverrideBps:ethers_1.BigNumber.from(0),inputOverride:ethers_1.BigNumber.from(0),outputOverrides:[]}}}decayStartTime(decayStartTime){return this.info.cosignerData?this.info.cosignerData.decayStartTime=decayStartTime:this.initializeCosignerData({decayStartTime:decayStartTime}),this}decayEndTime(decayEndTime){return this.info.cosignerData?this.info.cosignerData.decayEndTime=decayEndTime:this.initializeCosignerData({decayEndTime:decayEndTime}),this.orderInfo.deadline||super.deadline(decayEndTime),this}input(input){return this.info.input=input,this}output(output){var _a;return(0,tiny_invariant_1.default)(output.startAmount.gte(output.endAmount),`startAmount must be greater than endAmount: ${output.startAmount.toString()}`),null===(_a=this.info.outputs)||void 0===_a||_a.push(output),this}deadline(deadline){return super.deadline(deadline),this.info.cosignerData?this.info.cosignerData.decayEndTime||this.decayEndTime(deadline):this.initializeCosignerData({decayEndTime:deadline}),this}swapper(swapper){return super.swapper(swapper),this}nonce(nonce){return super.nonce(nonce),this}validation(info){return super.validation(info),this}nonFeeRecipient(newRecipient,feeRecipient){return(0,tiny_invariant_1.default)(newRecipient!==feeRecipient,`newRecipient must be different from feeRecipient: ${newRecipient}`),this.info.outputs?(this.info.outputs=this.info.outputs.map((output=>feeRecipient&&output.recipient.toLowerCase()===feeRecipient.toLowerCase()?output:Object.assign(Object.assign({},output),{recipient:newRecipient}))),this):this}exclusiveFiller(exclusiveFiller){return this.info.cosignerData||(this.info.cosignerData={decayStartTime:0,decayEndTime:0,exclusiveFiller:exclusiveFiller,exclusivityOverrideBps:ethers_1.BigNumber.from(0),inputOverride:ethers_1.BigNumber.from(0),outputOverrides:[]}),this.info.cosignerData.exclusiveFiller=exclusiveFiller,this}exclusivityOverrideBps(exclusivityOverrideBps){return this.info.cosignerData||(this.info.cosignerData={decayStartTime:0,decayEndTime:0,exclusiveFiller:ethers_1.ethers.constants.AddressZero,exclusivityOverrideBps:exclusivityOverrideBps,inputOverride:ethers_1.BigNumber.from(0),outputOverrides:[]}),this.info.cosignerData.exclusivityOverrideBps=exclusivityOverrideBps,this}inputOverride(inputOverride){return this.info.cosignerData?this.info.cosignerData.inputOverride=inputOverride:this.initializeCosignerData({inputOverride:inputOverride}),this}outputOverrides(outputOverrides){return this.info.cosignerData?this.info.cosignerData.outputOverrides=outputOverrides:this.initializeCosignerData({outputOverrides:outputOverrides}),this}cosigner(cosigner){return this.info.cosigner=cosigner,this}cosignature(cosignature){return this.info.cosignature=cosignature,this}cosignerData(cosignerData){return this.decayStartTime(cosignerData.decayStartTime),this.decayEndTime(cosignerData.decayEndTime),this.exclusiveFiller(cosignerData.exclusiveFiller),this.exclusivityOverrideBps(cosignerData.exclusivityOverrideBps),this.inputOverride(cosignerData.inputOverride),this.outputOverrides(cosignerData.outputOverrides),this}buildPartial(){var _a,_b;return(0,tiny_invariant_1.default)(void 0!==this.info.cosigner,"cosigner not set"),(0,tiny_invariant_1.default)(void 0!==this.info.input,"input not set"),(0,tiny_invariant_1.default)(this.info.outputs&&this.info.outputs.length>0,"outputs not set"),(0,tiny_invariant_1.default)(void 0!==this.info.input,"original input not set"),(0,tiny_invariant_1.default)(!this.orderInfo.deadline||this.info.cosignerData&&this.info.cosignerData.decayStartTime<=this.orderInfo.deadline,`if present, decayStartTime must be before or same as deadline: ${null===(_a=this.info.cosignerData)||void 0===_a?void 0:_a.decayStartTime}`),(0,tiny_invariant_1.default)(!this.orderInfo.deadline||this.info.cosignerData&&this.info.cosignerData.decayEndTime<=this.orderInfo.deadline,`if present, decayEndTime must be before or same as deadline: ${null===(_b=this.info.cosignerData)||void 0===_b?void 0:_b.decayEndTime}`),new order_1.UnsignedV2DutchOrder(Object.assign(this.getOrderInfo(),{input:this.info.input,outputs:this.info.outputs,cosigner:this.info.cosigner}),this.chainId,this.permit2Address)}build(){return(0,tiny_invariant_1.default)(void 0!==this.info.cosigner,"cosigner not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignature,"cosignature not set"),(0,tiny_invariant_1.default)(void 0!==this.info.input,"input not set"),(0,tiny_invariant_1.default)(this.info.outputs&&this.info.outputs.length>0,"outputs not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData,"cosignerData not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData.decayStartTime,"decayStartTime not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData.decayEndTime||void 0!==this.orderInfo.deadline,"Neither decayEndTime or deadline not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData.exclusiveFiller,"exclusiveFiller not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData.exclusivityOverrideBps,"exclusivityOverrideBps not set"),(0,tiny_invariant_1.default)(void 0!==this.info.cosignerData.inputOverride&&this.info.cosignerData.inputOverride.lte(this.info.input.startAmount),"inputOverride not set or larger than original input"),(0,tiny_invariant_1.default)(this.info.cosignerData.outputOverrides.length>0,"outputOverrides not set"),this.info.cosignerData.outputOverrides.forEach(((override,idx)=>{(0,tiny_invariant_1.default)(override.gte(this.info.outputs[idx].startAmount),"outputOverride must be larger than or equal to original output")})),(0,tiny_invariant_1.default)(void 0!==this.info.input,"original input not set"),(0,tiny_invariant_1.default)(!this.orderInfo.deadline||this.info.cosignerData.decayStartTime<=this.orderInfo.deadline,`decayStartTime must be before or same as deadline: ${this.info.cosignerData.decayStartTime}`),(0,tiny_invariant_1.default)(!this.orderInfo.deadline||this.info.cosignerData.decayEndTime<=this.orderInfo.deadline,`decayEndTime must be before or same as deadline: ${this.info.cosignerData.decayEndTime}`),new order_1.CosignedV2DutchOrder(Object.assign(this.getOrderInfo(),{cosignerData:this.info.cosignerData,input:this.info.input,outputs:this.info.outputs,cosigner:this.info.cosigner,cosignature:this.info.cosignature}),this.chainId,this.permit2Address)}initializeCosignerData(overrides){this.info.cosignerData=Object.assign({decayStartTime:0,decayEndTime:0,exclusiveFiller:ethers_1.ethers.constants.AddressZero,exclusivityOverrideBps:ethers_1.BigNumber.from(0),inputOverride:ethers_1.BigNumber.from(0),outputOverrides:[]},overrides)}}function isCosigned(order){return void 0!==order.info.cosignature}exports.V2DutchOrderBuilder=V2DutchOrderBuilder;