"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.watchPendingTransactions=void 0;const getAction_js_1=require("../../utils/getAction.js"),observe_js_1=require("../../utils/observe.js"),poll_js_1=require("../../utils/poll.js"),stringify_js_1=require("../../utils/stringify.js"),createPendingTransactionFilter_js_1=require("./createPendingTransactionFilter.js"),getFilterChanges_js_1=require("./getFilterChanges.js"),uninstallFilter_js_1=require("./uninstallFilter.js");function watchPendingTransactions(client,{batch:batch=!0,onError:onError,onTransactions:onTransactions,poll:poll_,pollingInterval:pollingInterval=client.pollingInterval}){return(void 0!==poll_?poll_:"webSocket"!==client.transport.type)?(()=>{const observerId=(0,stringify_js_1.stringify)(["watchPendingTransactions",client.uid,batch,pollingInterval]);return(0,observe_js_1.observe)(observerId,{onTransactions:onTransactions,onError:onError},(emit=>{let filter;const unwatch=(0,poll_js_1.poll)((async()=>{try{if(!filter)try{return void(filter=await(0,getAction_js_1.getAction)(client,createPendingTransactionFilter_js_1.createPendingTransactionFilter,"createPendingTransactionFilter")({}))}catch(err){throw unwatch(),err}const hashes=await(0,getAction_js_1.getAction)(client,getFilterChanges_js_1.getFilterChanges,"getFilterChanges")({filter:filter});if(0===hashes.length)return;if(batch)emit.onTransactions(hashes);else for(const hash of hashes)emit.onTransactions([hash])}catch(err){emit.onError?.(err)}}),{emitOnBegin:!0,interval:pollingInterval});return async()=>{filter&&await(0,getAction_js_1.getAction)(client,uninstallFilter_js_1.uninstallFilter,"uninstallFilter")({filter:filter}),unwatch()}}))})():(()=>{let active=!0,unsubscribe=()=>active=!1;return(async()=>{try{const{unsubscribe:unsubscribe_}=await client.transport.subscribe({params:["newPendingTransactions"],onData(data){if(!active)return;const transaction=data.result;onTransactions([transaction])},onError(error){onError?.(error)}});unsubscribe=unsubscribe_,active||unsubscribe()}catch(err){onError?.(err)}})(),unsubscribe})()}exports.watchPendingTransactions=watchPendingTransactions;