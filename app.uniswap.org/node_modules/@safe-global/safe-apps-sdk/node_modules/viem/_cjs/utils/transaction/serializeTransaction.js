"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.serializeTransaction=void 0;const transaction_js_1=require("../../errors/transaction.js"),concat_js_1=require("../data/concat.js"),trim_js_1=require("../data/trim.js"),toHex_js_1=require("../encoding/toHex.js"),toRlp_js_1=require("../encoding/toRlp.js"),assertTransaction_js_1=require("./assertTransaction.js"),getTransactionType_js_1=require("./getTransactionType.js"),serializeAccessList_js_1=require("./serializeAccessList.js");function serializeTransaction(transaction,signature){const type=(0,getTransactionType_js_1.getTransactionType)(transaction);return"eip1559"===type?serializeTransactionEIP1559(transaction,signature):"eip2930"===type?serializeTransactionEIP2930(transaction,signature):serializeTransactionLegacy(transaction,signature)}function serializeTransactionEIP1559(transaction,signature){const{chainId:chainId,gas:gas,nonce:nonce,to:to,value:value,maxFeePerGas:maxFeePerGas,maxPriorityFeePerGas:maxPriorityFeePerGas,accessList:accessList,data:data}=transaction;(0,assertTransaction_js_1.assertTransactionEIP1559)(transaction);const serializedAccessList=(0,serializeAccessList_js_1.serializeAccessList)(accessList),serializedTransaction=[(0,toHex_js_1.toHex)(chainId),nonce?(0,toHex_js_1.toHex)(nonce):"0x",maxPriorityFeePerGas?(0,toHex_js_1.toHex)(maxPriorityFeePerGas):"0x",maxFeePerGas?(0,toHex_js_1.toHex)(maxFeePerGas):"0x",gas?(0,toHex_js_1.toHex)(gas):"0x",to??"0x",value?(0,toHex_js_1.toHex)(value):"0x",data??"0x",serializedAccessList];if(signature){const yParity=0n===signature.v?"0x":1n===signature.v?(0,toHex_js_1.toHex)(1):27n===signature.v?"0x":(0,toHex_js_1.toHex)(1);serializedTransaction.push(yParity,(0,trim_js_1.trim)(signature.r),(0,trim_js_1.trim)(signature.s))}return(0,concat_js_1.concatHex)(["0x02",(0,toRlp_js_1.toRlp)(serializedTransaction)])}function serializeTransactionEIP2930(transaction,signature){const{chainId:chainId,gas:gas,data:data,nonce:nonce,to:to,value:value,accessList:accessList,gasPrice:gasPrice}=transaction;(0,assertTransaction_js_1.assertTransactionEIP2930)(transaction);const serializedAccessList=(0,serializeAccessList_js_1.serializeAccessList)(accessList),serializedTransaction=[(0,toHex_js_1.toHex)(chainId),nonce?(0,toHex_js_1.toHex)(nonce):"0x",gasPrice?(0,toHex_js_1.toHex)(gasPrice):"0x",gas?(0,toHex_js_1.toHex)(gas):"0x",to??"0x",value?(0,toHex_js_1.toHex)(value):"0x",data??"0x",serializedAccessList];if(signature){const yParity=0n===signature.v?"0x":1n===signature.v?(0,toHex_js_1.toHex)(1):27n===signature.v?"0x":(0,toHex_js_1.toHex)(1);serializedTransaction.push(yParity,(0,trim_js_1.trim)(signature.r),(0,trim_js_1.trim)(signature.s))}return(0,concat_js_1.concatHex)(["0x01",(0,toRlp_js_1.toRlp)(serializedTransaction)])}function serializeTransactionLegacy(transaction,signature){const{chainId:chainId=0,gas:gas,data:data,nonce:nonce,to:to,value:value,gasPrice:gasPrice}=transaction;(0,assertTransaction_js_1.assertTransactionLegacy)(transaction);let serializedTransaction=[nonce?(0,toHex_js_1.toHex)(nonce):"0x",gasPrice?(0,toHex_js_1.toHex)(gasPrice):"0x",gas?(0,toHex_js_1.toHex)(gas):"0x",to??"0x",value?(0,toHex_js_1.toHex)(value):"0x",data??"0x"];if(signature){const v=(()=>{if(chainId>0)return BigInt(2*chainId)+BigInt(35n+signature.v-27n);if(signature.v>=35n){return(signature.v-35n)/2n>0?signature.v:27n+(35n===signature.v?0n:1n)}const v=27n+(27n===signature.v?0n:1n);if(signature.v!==v)throw new transaction_js_1.InvalidLegacyVError({v:signature.v});return v})();serializedTransaction=[...serializedTransaction,(0,toHex_js_1.toHex)(v),signature.r,signature.s]}else chainId>0&&(serializedTransaction=[...serializedTransaction,(0,toHex_js_1.toHex)(chainId),"0x","0x"]);return(0,toRlp_js_1.toRlp)(serializedTransaction)}exports.serializeTransaction=serializeTransaction;