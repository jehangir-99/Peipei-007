"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.hashDomain=exports.hashTypedData=void 0;const encodeAbiParameters_js_1=require("../abi/encodeAbiParameters.js"),concat_js_1=require("../data/concat.js"),toHex_js_1=require("../encoding/toHex.js"),keccak256_js_1=require("../hash/keccak256.js"),typedData_js_1=require("../typedData.js");function hashTypedData({domain:domain_,message:message,primaryType:primaryType,types:types_}){const domain=void 0===domain_?{}:domain_,types={EIP712Domain:(0,typedData_js_1.getTypesForEIP712Domain)({domain:domain}),...types_};(0,typedData_js_1.validateTypedData)({domain:domain,message:message,primaryType:primaryType,types:types});const parts=["0x1901"];return domain&&parts.push(hashDomain({domain:domain,types:types})),"EIP712Domain"!==primaryType&&parts.push(hashStruct({data:message,primaryType:primaryType,types:types})),(0,keccak256_js_1.keccak256)((0,concat_js_1.concat)(parts))}function hashDomain({domain:domain,types:types}){return hashStruct({data:domain,primaryType:"EIP712Domain",types:types})}function hashStruct({data:data,primaryType:primaryType,types:types}){const encoded=encodeData({data:data,primaryType:primaryType,types:types});return(0,keccak256_js_1.keccak256)(encoded)}function encodeData({data:data,primaryType:primaryType,types:types}){const encodedTypes=[{type:"bytes32"}],encodedValues=[hashType({primaryType:primaryType,types:types})];for(const field of types[primaryType]){const[type,value]=encodeField({types:types,name:field.name,type:field.type,value:data[field.name]});encodedTypes.push(type),encodedValues.push(value)}return(0,encodeAbiParameters_js_1.encodeAbiParameters)(encodedTypes,encodedValues)}function hashType({primaryType:primaryType,types:types}){const encodedHashType=(0,toHex_js_1.toHex)(encodeType({primaryType:primaryType,types:types}));return(0,keccak256_js_1.keccak256)(encodedHashType)}function encodeType({primaryType:primaryType,types:types}){let result="";const unsortedDeps=findTypeDependencies({primaryType:primaryType,types:types});unsortedDeps.delete(primaryType);const deps=[primaryType,...Array.from(unsortedDeps).sort()];for(const type of deps)result+=`${type}(${types[type].map((({name:name,type:t})=>`${t} ${name}`)).join(",")})`;return result}function findTypeDependencies({primaryType:primaryType_,types:types},results=new Set){const match=primaryType_.match(/^\w*/u),primaryType=match?.[0];if(results.has(primaryType)||void 0===types[primaryType])return results;results.add(primaryType);for(const field of types[primaryType])findTypeDependencies({primaryType:field.type,types:types},results);return results}function encodeField({types:types,name:name,type:type,value:value}){if(void 0!==types[type])return[{type:"bytes32"},(0,keccak256_js_1.keccak256)(encodeData({data:value,primaryType:type,types:types}))];if("bytes"===type){return value=`0x${(value.length%2?"0":"")+value.slice(2)}`,[{type:"bytes32"},(0,keccak256_js_1.keccak256)(value)]}if("string"===type)return[{type:"bytes32"},(0,keccak256_js_1.keccak256)((0,toHex_js_1.toHex)(value))];if(type.lastIndexOf("]")===type.length-1){const parsedType=type.slice(0,type.lastIndexOf("[")),typeValuePairs=value.map((item=>encodeField({name:name,type:parsedType,types:types,value:item})));return[{type:"bytes32"},(0,keccak256_js_1.keccak256)((0,encodeAbiParameters_js_1.encodeAbiParameters)(typeValuePairs.map((([t])=>t)),typeValuePairs.map((([,v])=>v))))]}return[{type:type},value]}exports.hashTypedData=hashTypedData,exports.hashDomain=hashDomain;