import{NEW_FOCUS,newFocus}from"./solver";import{getFocusableNodes,getTabbableNodes}from"./utils/DOMutils";import{getAllAffectedNodes}from"./utils/all-affected";import{asArray,getFirst}from"./utils/array";import{pickAutofocus}from"./utils/auto-focus";import{getActiveElement}from"./utils/getActiveElement";import{isDefined,isNotAGuard}from"./utils/is";import{allParentAutofocusables,getTopCommonParent}from"./utils/parenting";var reorderNodes=function(srcNodes,dstNodes){var remap=new Map;return dstNodes.forEach((function(entity){return remap.set(entity.node,entity)})),srcNodes.map((function(node){return remap.get(node)})).filter(isDefined)};export var focusSolver=function(topNode,lastNode){var activeElement=getActiveElement(asArray(topNode).length>0?document:getFirst(topNode).ownerDocument),entries=getAllAffectedNodes(topNode).filter(isNotAGuard),commonParent=getTopCommonParent(activeElement||topNode,topNode,entries),visibilityCache=new Map,anyFocusable=getFocusableNodes(entries,visibilityCache),innerElements=getTabbableNodes(entries,visibilityCache).filter((function(_a){var node=_a.node;return isNotAGuard(node)}));if(innerElements[0]||(innerElements=anyFocusable)[0]){var outerNodes=getFocusableNodes([commonParent],visibilityCache).map((function(_a){return _a.node})),orderedInnerElements=reorderNodes(outerNodes,innerElements),innerNodes=orderedInnerElements.map((function(_a){return _a.node})),newId=newFocus(innerNodes,outerNodes,activeElement,lastNode);if(newId===NEW_FOCUS){var focusNode=pickAutofocus(anyFocusable,innerNodes,allParentAutofocusables(entries,visibilityCache));return focusNode?{node:focusNode}:void console.warn("focus-lock: cannot find any node to move focus into")}return void 0===newId?newId:orderedInnerElements[newId]}};