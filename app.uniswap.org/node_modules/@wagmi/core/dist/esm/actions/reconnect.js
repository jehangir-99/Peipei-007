import{}from"viem";import{}from"../connectors/createConnector.js";import{}from"../types/utils.js";let isReconnecting=!1;export async function reconnect(config,parameters={}){if(isReconnecting)return[];isReconnecting=!0,config.setState((x=>({...x,status:x.current?"reconnecting":"connecting"})));const connectors=[];if(parameters.connectors?.length)for(const connector_ of parameters.connectors){let connector;connector="function"==typeof connector_?config._internal.connectors.setup(connector_):connector_,connectors.push(connector)}else connectors.push(...config.connectors);let recentConnectorId;try{recentConnectorId=await(config.storage?.getItem("recentConnectorId"))}catch{}const scores={};for(const[,connection]of config.state.connections)scores[connection.connector.id]=1;recentConnectorId&&(scores[recentConnectorId]=0);const sorted=Object.keys(scores).length>0?[...connectors].sort(((a,b)=>(scores[a.id]??10)-(scores[b.id]??10))):connectors;let connected=!1;const connections=[],providers=[];for(const connector of sorted){const provider_=await connector.getProvider();if(!provider_)continue;if(providers.some((provider=>provider===provider_)))continue;if(!await connector.isAuthorized())continue;const data=await connector.connect({isReconnecting:!0}).catch((()=>null));data&&(connector.emitter.off("connect",config._internal.events.connect),connector.emitter.on("change",config._internal.events.change),connector.emitter.on("disconnect",config._internal.events.disconnect),config.setState((x=>{const connections=new Map(connected?x.connections:new Map).set(connector.uid,{accounts:data.accounts,chainId:data.chainId,connector:connector});return{...x,current:connected?x.current:connector.uid,connections:connections}})),connections.push({accounts:data.accounts,chainId:data.chainId,connector:connector}),providers.push(provider_),connected=!0)}return"reconnecting"!==config.state.status&&"connecting"!==config.state.status||(connected?config.setState((x=>({...x,status:"connected"}))):config.setState((x=>({...x,connections:new Map,current:null,status:"disconnected"})))),isReconnecting=!1,connections}